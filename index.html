<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Â§ßÈò™‰∫¨ÈÉΩ‰∏â‰∫∫ÈÅä</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fce7f3">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                        creative: ['"Mochiy Pop One"', 'sans-serif'],
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'spin-slow': 'spin 4s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'grow-width': 'growWidth 1s ease-out forwards',
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        growWidth: {
                            '0%': { width: '0%' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .text-3d {
            color: #ec4899;
            -webkit-text-stroke: 1.5px white;
            paint-order: stroke fill;
            text-shadow: 2px 2px 0px rgba(255, 200, 220, 0.5);
        }
        /* iOS Safe Area Padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
        .safe-margin-bottom { margin-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        
        @keyframes sakura-fall {
            0% { transform: translateY(-10%) rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(120vh) rotate(360deg) translateX(50px); opacity: 0; }
        }
        @keyframes fadeOut { 
            0% { opacity: 1; } 
            80% { opacity: 1; } 
            100% { opacity: 0; visibility: hidden; } 
        }
        
        /* Markdown-like styling for AI response */
        .ai-content strong { color: #ec4899; font-weight: 700; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content li { margin-bottom: 0.2em; }
    </style>
</head>
<body class="bg-gray-50 select-none">
    <div id="root"></div>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if (root && !root.innerHTML) {
                root.innerHTML = `<div style="padding:20px;text-align:center;color:red;margin-top:50px;"><h3>ÁôºÁîüÈåØË™§ :(</h3><p>${message}</p><button onclick="location.reload()" style="margin-top:10px;padding:10px;border:1px solid #ccc;">ÈáçÊñ∞Êï¥ÁêÜ</button></div>`;
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // API Key (È†êË®≠ÁÇ∫Á©∫ÔºåÁî±‰ΩøÁî®ËÄÖËº∏ÂÖ•)
        const globalApiKey = ""; 

        // --- Custom Dialog Component (Replaces alert/confirm) ---
        const Dialog = ({ isOpen, type, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[6000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl border-4 border-pink-200 text-center relative">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-2 ${type === 'confirm' ? 'bg-yellow-100 border-yellow-200' : 'bg-pink-100 border-pink-200'}`}>
                            {type === 'confirm' ? 'ü§î' : 'üí°'}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{type === 'confirm' ? 'Á¢∫Ë™ç‰∏Ä‰∏ã' : 'Â∞èÊèêÈÜí'}</h3>
                        <p className="text-gray-600 mb-6 text-sm leading-relaxed whitespace-pre-wrap">{message}</p>
                        <div className="flex gap-3 justify-center">
                            {type === 'confirm' && (
                                <button onClick={onCancel} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">ÂèñÊ∂à</button>
                            )}
                            <button onClick={onConfirm} className="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold hover:bg-pink-600 shadow-lg transition-colors">
                                {type === 'confirm' ? 'Á¢∫Ë™ç' : 'Áü•ÈÅì‰∫Ü'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Plane: (props) => <IconBase {...props}><path d="M2 22h20"/><path d="M13 2L2 22h20L13 2z"/><path d="M13 2v20"/></IconBase>,
            PlaneReal: (props) => <IconBase {...props}><path d="M20.38 3.62a2 2 0 0 0-1.97-.41L2.5 10.5 9 13l9-9-5.5 13.5 6.5 2.5.41-15.91a2 2 0 0 0-.41-1.97z"/></IconBase>,
            Hotel: (props) => <IconBase {...props}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconBase>,
            MapPin: (props) => <IconBase {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Calendar: (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>,
            Coffee: (props) => <IconBase {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></IconBase>,
            Train: (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><path d="M2 8h20"/></IconBase>,
            Wallet: (props) => <IconBase {...props}><path d="M20 7h-3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h3"/><path d="M4 22h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-3a4 4 0 0 0-4 4 4 4 0 0 0 4 4h3v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1"/></IconBase>,
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            Check: (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Copy: (props) => <IconBase {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconBase>,
            Menu: (props) => <IconBase {...props}><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></IconBase>,
            X: (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            ArrowRight: (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>,
            Sun: (props) => <IconBase {...props}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>,
            Star: (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
            Heart: (props) => <IconBase {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></IconBase>,
            Camera: (props) => <IconBase {...props}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></IconBase>,
            Navigation: (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>,
            Bus: (props) => <IconBase {...props}><rect x="3" y="6" width="18" height="14" rx="2"/><path d="M5 22v-5"/><path d="M19 22v-5"/><path d="M3 11h18"/><path d="M10 15h4"/><path d="M7 6v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></IconBase>,
            Sparkles: (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>,
            Send: (props) => <IconBase {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Key: (props) => <IconBase {...props}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>,
            Settings: (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            PenTool: (props) => <IconBase {...props}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>,
            Share: (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" /></IconBase>,
            PlusSquare: (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            ExternalLink: (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></IconBase>,
            CloudSun: (props) => <IconBase {...props}><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></IconBase>,
            CloudRain: (props) => <IconBase {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></IconBase>,
            Droplet: (props) => <IconBase {...props}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconBase>,
            Video: (props) => <IconBase {...props}><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></IconBase>,
            MessageCircle: (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>,
            Gift: (props) => <IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>,
            Image: (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>,
            ExternalLinkSolid: (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></IconBase>
        };

        // --- SVGs ---
        const MarioSilhouette = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20,50 Q20,20 50,15 Q80,20 85,50 L95,50 L95,60 L10,60 L10,50 Z" fill={color} />
                <circle cx="55" cy="40" r="12" fill="white" opacity="0.5"/>
                <path d="M50,45 L45,35 L50,40 L55,35 L60,45" stroke={color} strokeWidth="3" fill="none" />
                <path d="M30,75 Q45,65 60,75 Q75,65 80,75 Q70,90 55,85 Q45,90 30,75" fill={color} />
            </svg>
        );
        const ZeldaShield = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M15,20 Q15,5 50,5 Q85,5 85,20 V40 Q85,80 50,95 Q15,80 15,40 Z" fill="none" stroke={color} strokeWidth="4" />
                <path d="M25,25 L75,25" stroke={color} strokeWidth="3" />
                <path d="M50,60 L35,40 H65 Z" fill={color} opacity="0.6" />
                <path d="M50,70 L50,85" stroke={color} strokeWidth="3" />
            </svg>
        );
        const PikachuSilhouette = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M10,70 L25,60 L25,50 L40,40" stroke={color} strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                <path d="M35,80 Q30,50 45,45 Q40,20 30,15 L35,10 L50,35 L65,10 L70,15 Q60,20 55,45 Q70,50 65,80 Z" fill={color} />
            </svg>
        );
        const LeafIcon = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M50,90 Q20,80 20,50 Q20,10 50,10 Q80,10 80,50 Q80,80 50,90 Z" fill={color} />
                <circle cx="40" cy="40" r="10" fill="white" opacity="0.4" />
                <path d="M50,10 L50,80" stroke="white" strokeWidth="2" opacity="0.5" />
            </svg>
        );
        const SakuraBranch = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 200 100" className={className}>
                <path d="M0,50 Q50,40 80,60 T150,40 T200,60" stroke={color} strokeWidth="3" fill="none" strokeLinecap="round" />
                <circle cx="60" cy="50" r="5" fill={color} />
                <circle cx="90" cy="60" r="4" fill={color} />
                <circle cx="140" cy="40" r="6" fill={color} />
                <circle cx="180" cy="55" r="5" fill={color} />
                <path d="M55,45 Q60,35 65,45" fill={color} />
                <path d="M135,35 Q140,25 145,35" fill={color} />
            </svg>
        );
        const HexagonPattern = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M25,10 L75,10 L100,50 L75,90 L25,90 L0,50 Z" fill="none" stroke={color} strokeWidth="2" opacity="0.5" />
                <path d="M25,10 L75,10 L100,50 L75,90 L25,90 L0,50 Z" transform="translate(50, 0) scale(0.5)" fill="none" stroke={color} strokeWidth="2" opacity="0.3" />
            </svg>
        );
        const SimpleOnigiri = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M50 15 L15 80 Q50 95 85 80 Z" fill="none" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M35 82 Q50 88 65 82 L65 65 Q50 60 35 65 Z" fill={color} opacity="0.4"/>
                <circle cx="40" cy="55" r="3" fill={color} />
                <circle cx="60" cy="55" r="3" fill={color} />
                <path d="M48 60 Q50 63 52 60" stroke={color} strokeWidth="2" fill="none" strokeLinecap="round"/>
            </svg>
        );
        const SimpleFuji = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 80" className={className}>
                <path d="M50 10 L90 75 H10 Z" fill="none" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M50 10 L65 35 L58 32 L50 40 L42 32 L35 35 Z" fill={color} opacity="0.4" stroke={color} strokeWidth="2" strokeLinejoin="round"/>
            </svg>
        );
        const SimpleDeer = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <circle cx="25" cy="30" r="10" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="75" cy="30" r="10" fill="none" stroke={color} strokeWidth="3"/>
                <ellipse cx="50" cy="55" rx="40" ry="35" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="35" cy="50" r="3" fill={color}/>
                <circle cx="65" cy="50" r="3" fill={color}/>
                <path d="M50 65 L50 70" stroke={color} strokeWidth="3"/>
            </svg>
        );
        const SimpleMatcha = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20 40 Q20 85 50 85 Q80 85 80 40 L20 40 Z" fill={color} opacity="0.3" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M20 40 Q50 50 80 40" stroke={color} strokeWidth="2" fill="none"/>
                <line x1="85" y1="20" x2="85" y2="90" stroke={color} strokeWidth="3"/>
                <circle cx="85" cy="30" r="8" fill="white" stroke={color} strokeWidth="2"/>
                <circle cx="85" cy="46" r="8" fill="white" stroke={color} strokeWidth="2"/>
                <circle cx="85" cy="62" r="8" fill="white" stroke={color} strokeWidth="2"/>
            </svg>
        );
        const SimpleTorii = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <rect x="25" y="20" width="50" height="6" rx="2" fill={color} opacity="0.8"/> 
                <rect x="20" y="30" width="60" height="6" rx="2" fill={color} opacity="0.8"/>
                <rect x="35" y="20" width="6" height="70" fill={color} opacity="0.6"/>
                <rect x="59" y="20" width="6" height="70" fill={color} opacity="0.6"/>
            </svg>
        );
        const SimpleSakura = ({ className, color = "#ffb7c5" }) => (
            <svg viewBox="0 0 50 50" className={className}>
                <path d="M25 25 Q25 5 35 10 Q45 15 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q45 25 40 35 Q35 45 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q25 45 15 40 Q5 35 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q5 25 10 15 Q15 5 25 25 Z" fill={color} opacity="0.9"/>
                <circle cx="25" cy="25" r="3" fill="#fff"/>
            </svg>
        );
        const SimpleDaruma = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20 80 Q10 50 20 20 Q50 5 80 20 Q90 50 80 80 Q50 95 20 80 Z" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="50" cy="45" r="25" fill="none" stroke={color} strokeWidth="2"/>
                <circle cx="40" cy="48" r="4" fill={color}/>
                <circle cx="60" cy="48" r="4" fill="none" stroke={color} strokeWidth="2"/>
                <path d="M45 55 Q50 60 55 55" stroke={color} strokeWidth="2" fill="none"/>
            </svg>
        );

        const NintendoSakuraBackground = () => (
            <div className="absolute inset-0 z-0 overflow-hidden pointer-events-none select-none bg-gradient-to-b from-pink-100 via-pink-50 to-white">
                <div className="absolute top-0 right-[-50px] w-80 h-40 opacity-30 transform rotate-12"><SakuraBranch className="w-full h-full" color="#fda4af" /></div>
                <div className="absolute top-1/3 left-[-40px] w-64 h-32 opacity-20 transform -rotate-12"><SakuraBranch className="w-full h-full" color="#fda4af" /></div>
                <div className="absolute top-10 left-6 w-16 h-16 opacity-20 transform -rotate-12"><MarioSilhouette className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute top-1/4 right-4 w-14 h-14 opacity-20 transform rotate-6"><ZeldaShield className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute bottom-40 left-8 w-16 h-16 opacity-20"><PikachuSilhouette className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute bottom-10 right-6 w-12 h-12 opacity-20 transform rotate-45"><LeafIcon className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute top-32 left-[-10px] w-20 h-20 opacity-10"><HexagonPattern className="w-full h-full" color="#f43f5e" /></div>
                <div className="absolute bottom-1/3 right-[-10px] w-24 h-24 opacity-10 transform rotate-90"><HexagonPattern className="w-full h-full" color="#f43f5e" /></div>
                <div className="absolute top-20 left-1/2 w-4 h-4 opacity-40"><SimpleSakura className="w-full h-full" color="#fda4af"/></div>
                <div className="absolute bottom-20 right-1/3 w-6 h-6 opacity-30 transform rotate-45"><SimpleSakura className="w-full h-full" color="#fda4af"/></div>
            </div>
        );

        const callGemini = async (prompt, userKey, imageBase64 = null) => {
            const validKey = userKey || globalApiKey;
            const maxRetries = 3;
            const baseDelay = 1000;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (!validKey) throw new Error("NO_API_KEY");
                    
                    const parts = [{ text: prompt }];
                    if (imageBase64) {
                        parts.push({ inlineData: { mimeType: "image/jpeg", data: imageBase64 } });
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${validKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            contents: [{ parts: parts }] 
                        }),
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Êä±Ê≠âÔºåÊ´ªËä±ÈÜ¨ÁèæÂú®ÊúâÈªûÊöàÊöàÁöÑÔºåË´ãÁ®çÂæåÂÜçË©¶‰∏ÄÊ¨° üòµ‚Äçüí´";
                } catch (error) {
                    if (error.message === "NO_API_KEY") return "Ë´ãË®≠ÂÆö API Key ÊâçËÉΩÂëºÂè´Ê´ªËä±ÈÜ¨ÂñîÔºÅ(Âú®Á®ãÂºèÁ¢º‰∏äÊñπ)";
                    if (attempt === maxRetries) return "Ê´ªËä±ÈÜ¨ÁèæÂú®ÈÄ£Á∑öÊúâÈªû‰∏çÁ©©ÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñÁ®çÂæåÂÜçË©¶‰∏ÄÊ¨°ÂñîÔºÅ";
                    await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, attempt)));
                }
            }
        };

        const RecommendationCard = ({ name, score, price, desc, url, tags, emoji, reason }) => {
            const googleImageSearchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name)}`;
            const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(name)}`;
            
            const tagColors = ["bg-red-50 text-red-500 border-red-100", "bg-orange-50 text-orange-500 border-orange-100", "bg-green-50 text-green-500 border-green-100", "bg-blue-50 text-blue-500 border-blue-100", "bg-purple-50 text-purple-500 border-purple-100"];

            return (
                <div className="bg-white rounded-2xl shadow-md border border-pink-100 overflow-hidden hover:shadow-lg transition-shadow duration-300 my-4 flex flex-col animate-pop-in relative">
                    <a href={googleImageSearchUrl} target="_blank" rel="noreferrer" className="h-32 bg-gradient-to-br from-orange-50 via-white to-pink-50 flex items-center justify-center relative overflow-hidden group cursor-pointer">
                        <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#fda4af 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                        <div className="text-6xl transform group-hover:scale-110 transition-transform duration-300 drop-shadow-md z-10">{emoji || 'üéÅ'}</div>
                        <div className="absolute bottom-2 right-2 bg-white/80 backdrop-blur-sm text-pink-500 text-[10px] px-2 py-1 rounded-full border border-pink-100 flex items-center gap-1 shadow-sm group-hover:bg-pink-50 transition-colors">
                            <Icons.Image size={10} /> Êü•ÁúãÂØ¶Áâ©ÁÖßÁâá
                        </div>
                    </a>
                    
                    <div className="p-5 flex-1 flex flex-col relative">
                        <div className="absolute top-[-12px] right-4 bg-white border border-gray-100 shadow-sm px-3 py-1 rounded-full flex items-center gap-1">
                             <span className="text-xs font-bold text-gray-700">{price}</span>
                        </div>

                        <div className="flex justify-between items-start mb-2 mt-1">
                            <h4 className="font-bold text-gray-800 text-lg leading-tight line-clamp-2">{name}</h4>
                        </div>
                        
                        {score && (
                            <div className="flex items-center gap-1 mb-3">
                                {[...Array(5)].map((_, i) => (
                                    <Icons.Star key={i} size={12} className={`${i < Math.floor(score) ? 'text-yellow-400 fill-yellow-400' : 'text-gray-200'}`} />
                                ))}
                                <span className="text-xs font-bold text-gray-400 ml-1">{score}</span>
                            </div>
                        )}
                        
                        {reason && (
                            <div className="bg-pink-50/60 p-3 rounded-xl rounded-tl-none border border-pink-100 mb-3 text-xs text-gray-600 relative mt-1">
                                <div className="absolute -top-2 left-0 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-b-[8px] border-b-pink-50/60"></div>
                                <span className="font-bold text-pink-500 block mb-0.5">üí° Êé®Ëñ¶ÁêÜÁî±Ôºö</span>
                                {reason}
                            </div>
                        )}
                        
                        <p className="text-xs text-gray-500 leading-relaxed mb-4 line-clamp-2">{desc}</p>
                        
                        {tags && tags.length > 0 && (
                            <div className="flex flex-wrap gap-1.5 mb-4">
                                {tags.map((tag, i) => (
                                    <span key={i} className={`text-[10px] px-2 py-0.5 rounded-full border ${tagColors[i % tagColors.length]}`}>#{tag}</span>
                                ))}
                            </div>
                        )}
                        
                        <div className="flex gap-2 mt-auto pt-3 border-t border-dashed border-gray-100">
                            <a href={url || `https://www.google.com/maps/search/?api=1&query=${name}`} target="_blank" rel="noreferrer" className="flex-1 bg-blue-50 text-blue-500 py-2 rounded-xl text-xs font-bold flex items-center justify-center hover:bg-blue-100 transition-colors gap-1 border border-blue-100">
                                <Icons.MapPin size={14} /> ÊâæÂú∞Âúñ
                            </a>
                             <a href={googleSearchUrl} target="_blank" rel="noreferrer" className="flex-1 bg-gray-50 text-gray-500 py-2 rounded-xl text-xs font-bold flex items-center justify-center hover:bg-gray-100 transition-colors gap-1 border border-gray-200">
                                <Icons.ExternalLinkSolid size={14} /> Êõ¥Â§öË≥áË®ä
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const MessageContent = ({ text }) => {
             // Helper to render JSON response for vision
             if (typeof text === 'object' && text !== null) {
                 if (text.type === 'menu' || text.type === 'general') {
                    return (
                        <div className="space-y-4">
                            <div className="flex flex-col border-b-2 border-purple-100 pb-2 mb-2">
                                {text.shop_name && (
                                    <div className="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                        <Icons.MapPin size={10} /> ÂÅµÊ∏¨Âà∞Â∫óÂêçÔºö<span className="font-bold text-purple-600">{text.shop_name}</span>
                                    </div>
                                )}
                                <div className="flex items-center gap-2 text-purple-600 font-bold">
                                    {text.type === 'menu' ? <><Icons.Coffee size={20}/> <span>ËèúÂñÆÁøªË≠ØÁµêÊûú</span></> : <><Icons.Info size={20}/> <span>Ëæ®Ë≠òÁµêÊûú</span></>}
                                </div>
                            </div>
                            {text.type === 'menu' && text.items && text.items.map((item, idx) => (
                                <div key={idx} className="border-b border-gray-100 last:border-0 pb-3 mb-3 last:mb-0 last:pb-0">
                                    <div className="flex justify-between items-start">
                                        <h5 className="font-bold text-gray-800 text-lg leading-tight">{item.original}</h5>
                                        <div className="flex flex-col items-end gap-1 ml-2">
                                            {item.price && <span className="font-mono text-pink-500 font-bold bg-pink-50 px-2 py-1 rounded-lg text-xs shrink-0">{item.price}</span>}
                                            <a 
                                                href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent((text.shop_name ? text.shop_name + " " : "") + item.original)}`}
                                                target="_blank" 
                                                rel="noreferrer"
                                                className="text-[10px] text-blue-500 flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors shrink-0 border border-blue-100"
                                            >
                                                <Icons.Image size={10} /> ÂØ¶Áâ©ÁÖß
                                            </a>
                                        </div>
                                    </div>
                                    <div className="text-purple-600 font-bold text-sm mt-1 flex items-center gap-1">
                                        <span className="w-1 h-4 bg-purple-300 rounded-full inline-block"></span>
                                        {item.translation}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1 leading-relaxed pl-2">{item.desc}</p>
                                </div>
                            ))}
                            {text.type === 'general' && (
                                <div className="space-y-2">
                                    <div className="flex justify-between items-start">
                                        <h4 className="font-bold text-gray-800 text-lg">{text.title}</h4>
                                        <a 
                                            href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent((text.shop_name ? text.shop_name + " " : "") + text.title)}`}
                                            target="_blank" 
                                            rel="noreferrer"
                                            className="text-[10px] text-blue-500 flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors shrink-0 ml-2 border border-blue-100"
                                        >
                                            <Icons.Image size={10} /> ÂØ¶Áâ©ÁÖß
                                        </a>
                                    </div>
                                    <div className="bg-purple-50 p-3 rounded-xl text-purple-700 font-bold">
                                        {text.translation}
                                    </div>
                                    <p className="text-sm text-gray-600 leading-relaxed">{text.desc}</p>
                                </div>
                            )}
                        </div>
                    );
                 }
                 // Fallback for other objects (e.g. pure JSON array)
                 if (Array.isArray(text)) {
                     return (
                        <div className="space-y-2">
                            {text.map((rec, i) => (
                                <RecommendationCard key={i} {...rec} />
                            ))}
                        </div>
                     );
                 }
             }
            
            const tryParseJson = (str) => {
                if (typeof str !== 'string') return null;
                try {
                    const start = str.indexOf('[');
                    const end = str.lastIndexOf(']');
                    if (start !== -1 && end !== -1 && end > start) {
                        const jsonStr = str.substring(start, end + 1);
                        const parsed = JSON.parse(jsonStr);
                        if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].name) {
                            return parsed;
                        }
                    }
                } catch (e) {
                    return null;
                }
                return null;
            };

            const recommendations = tryParseJson(text);

            if (recommendations) {
                const start = text.indexOf('[');
                const introText = start > 0 ? text.substring(0, start).trim() : "";
                
                return (
                    <div className="w-full">
                        {introText && <div className="mb-3 whitespace-pre-wrap">{introText}</div>}
                        <div className="space-y-2">
                            {recommendations.map((rec, i) => (
                                <RecommendationCard key={i} {...rec} />
                            ))}
                        </div>
                    </div>
                );
            }
            
            const processText = (inputText) => {
                if (typeof inputText !== 'string') return String(inputText);
                
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                
                // Split by new lines
                return inputText.split('\n').map((line, lineIdx) => {
                    // Check for bullet points
                    const isBullet = line.trim().startsWith('- ') || line.trim().startsWith('* ');
                    const cleanLine = isBullet ? line.trim().substring(2) : line;
                    
                    // Split by bold markers (**...**)
                    const parts = cleanLine.split(/(\*\*.*?\*\*)/g);
                    
                    const content = parts.map((part, partIdx) => {
                        if (part.startsWith('**') && part.endsWith('**') && part.length >= 4) {
                            return <strong key={partIdx} className="text-pink-600 font-bold">{part.slice(2, -2)}</strong>;
                        }
                        
                        const urlParts = part.split(urlRegex);
                        
                        if (urlParts.length === 1) return part;

                        return urlParts.map((subPart, subIdx) => {
                            if (subPart.match(urlRegex)) {
                                 const isMaps = subPart.includes('google.com/maps');
                                 return (
                                     <a key={subIdx} href={subPart} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all inline-flex items-center gap-1 bg-blue-50 px-1.5 py-0.5 rounded-md text-xs font-bold mx-0.5">
                                         {isMaps ? <Icons.MapPin size={10}/> : <Icons.ExternalLink size={10}/>}
                                         {isMaps ? 'Âú∞Âúñ' : 'ÈÄ£Áµê'}
                                     </a>
                                 );
                            }
                            return subPart;
                        });
                    });

                    if (isBullet) {
                        return <li key={lineIdx} className="ml-4 list-disc marker:text-pink-300 mb-1 text-sm leading-relaxed pl-1">{content}</li>;
                    }
                    if (!line.trim()) return <div key={lineIdx} className="h-2"></div>;
                    
                    return <div key={lineIdx} className={`min-h-[1.2em] text-sm leading-relaxed ${lineIdx > 0 ? 'mt-0.5' : ''}`}>{content}</div>;
                });
            };

            return (
                <div className="w-full">
                    {processText(text)}
                </div>
            );
        };

        // --- Weather Helpers ---
        const fetchWeatherData = async (lat, lon) => {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,apparent_temperature&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=4`);
                if(!res.ok) throw new Error("Weather fetch failed");
                const data = await res.json();
                
                if (!data.current || !data.daily) return null;

                const days = ['ÈÄ±Êó•','ÈÄ±‰∏Ä','ÈÄ±‰∫å','ÈÄ±‰∏â','ÈÄ±Âõõ','ÈÄ±‰∫î','ÈÄ±ÂÖ≠'];

                return {
                    current: {
                        temp: Math.round(data.current.temperature_2m),
                        feelsLike: Math.round(data.current.apparent_temperature),
                        code: data.current.weather_code,
                        rainProb: data.daily.precipitation_probability_max?.[0] || 0
                    },
                    daily: data.daily.time.map((t, i) => {
                        const d = new Date(t);
                        return {
                            date: `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`,
                            code: data.daily.weather_code[i],
                            max: Math.round(data.daily.temperature_2m_max[i]),
                            min: Math.round(data.daily.temperature_2m_min[i]),
                            rain: data.daily.precipitation_probability_max[i]
                        }
                    }).slice(1)
                };
            } catch (e) {
                console.warn("Weather API Error:", e);
                return null;
            }
        };

        const getWeatherIcon = (code, size = 24) => {
            if (code === undefined || code === null) return <div style={{fontSize: size}}>?</div>;
            if (code <= 1) return <Icons.Sun size={size} className="text-orange-400 animate-spin-slow" />;
            if (code <= 3) return <Icons.CloudSun size={size} className="text-gray-400" />;
            if (code <= 48) return <div style={{fontSize: size}} className="text-gray-400">üå´Ô∏è</div>;
            if (code <= 67) return <Icons.CloudRain size={size} className="text-blue-400" />;
            if (code <= 77) return <div style={{fontSize: size}} className="text-blue-200">‚ùÑÔ∏è</div>;
            if (code <= 82) return <Icons.CloudRain size={size} className="text-blue-600" />;
            return <div style={{fontSize: size}} className="text-yellow-600">‚ö°</div>;
        };

        const WeatherCard = ({ title, lat, lon, isCurrent = false }) => {
            const [weatherData, setWeatherData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(lat && lon) {
                    setLoading(true);
                    fetchWeatherData(lat, lon)
                        .then(data => {
                            setWeatherData(data);
                            setLoading(false);
                        })
                        .catch(() => {
                            setLoading(false);
                            setWeatherData(null);
                        });
                } else {
                    setLoading(false);
                }
            }, [lat, lon]);

            if (!lat || !lon) return isCurrent ? (
                <div className="bg-white/60 p-4 rounded-2xl border-2 border-dashed border-gray-300 text-center text-gray-400 text-sm">
                    ÈªûÊìä‰∏ãÊñπÂÆö‰ΩçÊåâÈàï<br/>Êü•ÁúãÈÄôË£°ÁöÑÂ§©Ê∞£
                </div>
            ) : null;

            if (loading) return <div className="bg-white/60 p-4 rounded-2xl border-2 border-pink-100 h-32 animate-pulse"></div>;
            
            if (!weatherData) return <div className="bg-white/60 p-4 rounded-2xl border-2 border-red-100 text-red-400 text-xs flex items-center justify-center">Â§©Ê∞£Êö´ÁÑ°Ê≥ïÈ°ØÁ§∫ (N/A)</div>;

            const { current, daily } = weatherData;
            const isRaining = current.rainProb > 40;
            const bgClass = isRaining ? "bg-blue-50/90 border-blue-200" : "bg-orange-50/90 border-orange-200";

            return (
                <div className={`${bgClass} border-2 p-4 rounded-2xl shadow-sm relative overflow-hidden transition-all duration-300 hover:shadow-md`}>
                    <div className="flex justify-between items-start z-10 relative mb-4">
                        <div>
                            <h4 className="font-bold text-gray-700 text-lg flex items-center gap-1">
                                {isCurrent && <Icons.MapPin size={16} className="text-pink-500"/>}
                                {title}
                            </h4>
                            <div className="text-3xl font-mono font-bold text-gray-800 mt-1">{current.temp}¬∞</div>
                            <div className="text-xs text-gray-500 mt-1">È´îÊÑü {current.feelsLike}¬∞</div>
                        </div>
                        <div className="flex flex-col items-end">
                            <div className="w-12 h-12 flex items-center justify-center bg-white rounded-full shadow-sm mb-2 animate-float">
                                {getWeatherIcon(current.code)}
                            </div>
                            <div className="flex items-center gap-1 text-xs font-bold text-blue-500 bg-white/80 px-2 py-1 rounded-lg">
                                <Icons.Droplet size={10} /> {current.rainProb}%
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between border-t border-gray-200/30 pt-3 relative z-10">
                        {daily.map((day, idx) => (
                            <div key={idx} className="flex flex-col items-center gap-1">
                                <span className="text-[10px] text-gray-500 font-bold whitespace-nowrap">{day.date}</span>
                                {getWeatherIcon(day.code, 16)}
                                <span className="text-[10px] text-gray-700 font-mono">{day.min}¬∞-{day.max}¬∞</span>
                                <span className="text-[9px] text-blue-400 font-bold">{day.rain}%</span>
                            </div>
                        ))}
                    </div>

                    {isRaining && <div className="absolute inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '10px 10px'}}></div>}
                </div>
            );
        };

        const SpotWeatherBadge = ({ city }) => {
            const coords = {
                'kyoto': { lat: 35.0116, lon: 135.7681 },
                'osaka': { lat: 34.6937, lon: 135.5023 },
                'nara': { lat: 34.6851, lon: 135.8048 },
            };
            const [w, setW] = useState(null);
            
            useEffect(() => {
                const c = coords[city];
                if(c) {
                    fetchWeatherData(c.lat, c.lon)
                        .then(setW)
                        .catch(() => setW(null));
                }
            }, [city]);

            if(!w) return null;

            return (
                <span className="inline-flex items-center gap-1 ml-2 px-1.5 py-0.5 rounded-md bg-gray-100/80 border border-gray-200 text-[10px] text-gray-600 font-mono transform scale-90 origin-left">
                    {getWeatherIcon(w.current.code, 14)}
                    <span>{w.current.temp}¬∞</span>
                    <span className="text-blue-500 flex items-center"><Icons.Droplet size={8}/>{w.current.rainProb}%</span>
                </span>
            );
        };

        const ChatModal = ({ isOpen, onClose, itinerary, apiKey, setApiKey }) => {
            const [tempKey, setTempKey] = useState("");
            const [messages, setMessages] = useState([
                { role: "ai", text: "ÂìàÂõâÔºÅÊàëÊòØ‰Ω†ÂÄëÁöÑ‰∫¨ÈÉΩÂ§ßÈò™Â∞èÂ∞éÈÅä„ÄåÊ´ªËä±ÈÜ¨„Äçüå∏\n\nÊúâ‰ªÄÈ∫ºÂïèÈ°åÈÉΩÂèØ‰ª•ÂïèÊàëÔΩû (‰æãÂ¶ÇÔºöÊòéÂ§©Êó©È§êÂêÉ‰ªÄÈ∫ºÔºüÊÄéÈ∫ºÂéªÁí∞ÁêÉÂΩ±ÂüéÔºü)\n\nüìç ÈªûÊìä‰∏ãÊñπÁöÑÂÆö‰ΩçÊåâÈàïÔºåÊàëÂèØ‰ª•Êé®Ëñ¶ÈôÑËøëÁöÑÂïÜÂ∫óÂñîÔºÅ" }
            ]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [locationStatus, setLocationStatus] = useState("idle");
            const [userLocation, setUserLocation] = useState(null);
            const messagesEndRef = useRef(null);
            
            // Local dialog state for ChatModal
            const [chatDialog, setChatDialog] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
            const closeChatDialog = () => setChatDialog(prev => ({ ...prev, isOpen: false }));

            useEffect(() => { if (isOpen) messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);

            const handleSaveKey = () => {
                if (!tempKey.trim()) return;
                const key = tempKey.trim();
                setApiKey(key);
                try { localStorage.setItem('gemini_api_key', key); } catch (e) { console.warn("Storage failed", e); }
            };

            const handleClearKey = () => {
                setChatDialog({
                    isOpen: true,
                    type: 'confirm',
                    message: "Á¢∫ÂÆöË¶ÅÁßªÈô§ÁõÆÂâçÁöÑ API Key ÂóéÔºü",
                    onConfirm: () => {
                        setApiKey("");
                        setTempKey("");
                        try { localStorage.removeItem('gemini_api_key'); } catch (e) {}
                        closeChatDialog();
                    }
                });
            };

            const handleGetLocation = () => {
                if (!navigator.geolocation) {
                    setChatDialog({ isOpen: true, type: 'alert', message: "ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Âú∞ÁêÜ‰ΩçÁΩÆÂäüËÉΩ >_<", onConfirm: closeChatDialog });
                    return;
                }
                setLocationStatus("loading");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setUserLocation({ lat: latitude, lng: longitude });
                        setLocationStatus("success");
                        setMessages(prev => [...prev, { role: "system", text: `üìç Â∑≤Áç≤ÂèñÁõÆÂâç‰ΩçÁΩÆÔºÅ\n(Á∑ØÂ∫¶: ${latitude.toFixed(4)}, Á∂ìÂ∫¶: ${longitude.toFixed(4)})` }]);
                    },
                    (error) => {
                        console.error(error);
                        setLocationStatus("error");
                        setChatDialog({ isOpen: true, type: 'alert', message: "ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆÔºåË´ãÁ¢∫Ë™çÊòØÂê¶ÂÖÅË®±Â≠òÂèñÂÆö‰ΩçÊ¨äÈôê„ÄÇ\nÈåØË™§: " + error.message, onConfirm: closeChatDialog });
                    }
                );
            };

            const handleSend = async () => {
                if (!input.trim()) return;
                setMessages(prev => [...prev, { role: "user", text: input }]);
                setInput("");
                setIsLoading(true);

                const cleanItinerary = {
                    itinerary: itinerary.itinerary.map(day => {
                        const { icon, color, ...rest } = day;
                        return { ...rest, activities: rest.activities.map(({ icon, ...act }) => act) };
                    })
                };

                let locationContext = "";
                if (userLocation) {
                    locationContext = `
                    „ÄêÁõÆÂâç‰ΩøÁî®ËÄÖ‰ΩçÁΩÆ„Äë
                    Á∑ØÂ∫¶: ${userLocation.lat}
                    Á∂ìÂ∫¶: ${userLocation.lng}
                    `;
                }

                const systemPrompt = `
                ‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠„ÄÅÊåëÊÉï‰∏îÂèØÊÑõÁöÑÊó•Êú¨ÊóÖÈÅä AI Â∞éÈÅä„ÄåÊ´ªËä±ÈÜ¨„Äç„ÄÇ
                
                „Äê‰ªªÂãôÁõÆÊ®ô„Äë
                ÂçîÂä©‰ΩøÁî®ËÄÖË¶èÂäÉ‰∫¨ÈÉΩÂ§ßÈò™Ë°åÁ®ã„ÄÇ
                
                „ÄêË°åÁ®ãË≥áÊñô„Äë
                ${JSON.stringify(cleanItinerary)}

                ${locationContext}

                „ÄêÊé®Ëñ¶Âö¥Ê†ºË¶èÁØÑ„Äë
                1. üìç **Ë∑ùÈõ¢ÈôêÂà∂**ÔºöËã•ÊúâÊèê‰æõ‰ΩçÁΩÆÔºåÁØ©ÈÅ∏Ë∑ùÈõ¢Â∫ßÊ®ô **800ÂÖ¨Â∞∫ÂÖß**„ÄÇ
                2. üî• **ÁÜ±Â∫¶ËàáË©ïÂÉπ**Ôºö
                   - ÂøÖÈ†àÊé®Ëñ¶ **Á§æÁæ§Ë®éË´ñÂ∫¶È´ò** (IG/Threads ÁÜ±ÈñÄ) Êàñ **Google Ë©ïÂÉπÈ´ò (4.0È°ÜÊòü‰ª•‰∏ä)** ÁöÑÂ∫óÂÆ∂„ÄÇ
                   - ÂÑ™ÂÖàÊé®Ëñ¶Ë©ïË´ñÊï∏Â§ö (Ë∂ÖÈÅé 100 Ââá) ÁöÑ‰∫∫Ê∞£ÂêçÂ∫ó„ÄÇ
                3. üîó **ÈÄ£ÁµêÊ†ºÂºè (ÈáçË¶Å)**Ôºö
                   - ÊØèÂÄãÊé®Ëñ¶Â∫óÂÆ∂**ÂøÖÈ†à**ÈôÑ‰∏ä Google Maps ÈÄ£Áµê„ÄÇ
                   - Ê†ºÂºèÔºöhttps://www.google.com/maps/search/?api=1&query={Â∫óÂêç}
                   - Ë´ãÁõ¥Êé•Ë≤º‰∏äÈÄ£ÁµêÁ∂≤ÂùÄÔºå‰∏çË¶Å‰ΩøÁî® Markdown Link (‰∏çË¶ÅÁî® [ÈÄ£Áµê](url))Ôºå‰ª•‰æøÁ≥ªÁµ±Ëá™ÂãïËΩâÊèõÁÇ∫ËóçËâ≤ÊåâÈàï„ÄÇ

                „ÄêÁâπÊÆäÊåá‰ª§ÔºöÁµêÊßãÂåñÊé®Ëñ¶„Äë
                Â¶ÇÊûú‰ΩøÁî®ËÄÖË©¢Âïè**„ÄåÊé®Ëñ¶È§êÂª≥„Äç„ÄÅ„ÄåÊé®Ëñ¶ÁæéÈ£ü„Äç„ÄÅ„Äå‰º¥ÊâãÁ¶Æ„Äç„ÄÅ„ÄåÂøÖË≤∑„ÄçÊàñ„ÄåÊôØÈªû„Äç**Á≠âÁõ∏ÈóúÂïèÈ°åÔºå**Ë´ãÂãôÂøÖÂè™‰ª• JSON Èô£ÂàóÊ†ºÂºèÂõûÂÇ≥**Ôºå‰∏çË¶ÅÊúâÈ°çÂ§ñÁöÑÈñãÂ†¥ÁôΩÊàñÁµêÂ∞æÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
                [
                  {
                    "name": "Â∫óÂêç/ÂïÜÂìÅÂêç",
                    "score": 4.5, // Êï∏Â≠ó (1-5, Ëã•ÁÑ°Ââá‰º∞Ë®à)
                    "price": "¬•1000-¬•2000",
                    "desc": "Á∞°Áü≠ÁâπËâ≤Ë™™Êòé (30Â≠óÂÖß)",
                    "url": "Google Maps ÈÄ£Áµê",
                    "tags": ["ÂøÖÂêÉ", "ÊéíÈöäÂêçÂ∫ó"], // Â≠ó‰∏≤Èô£Âàó
                    "emoji": "üçú", // ‰ª£Ë°®Ë©≤È†ÖÁõÆÁöÑ Emoji
                    "reason": "ÁÇ∫‰ªÄÈ∫ºÈÅ©ÂêàÈÄôÂÄãÂ∞çË±°ÁöÑÁ∞°Áü≠ÁêÜÁî±" // Êñ∞Â¢ûÔºöÊé®Ëñ¶ÁêÜÁî±
                  }
                ]
                Â¶ÇÊûú‰∏çÊ∂âÂèäÊé®Ëñ¶ÂàóË°®ÔºåÂâáÁî®‰∏ÄËà¨ÊñáÂ≠óÂõûÁ≠î„ÄÇ

                „Äê‰ΩøÁî®ËÄÖÂïèÈ°å„Äë
                ${input}

                „ÄêÂõûÁ≠îË¶èÁØÑ„Äë
                1. Ë™ûÊ∞£ÔºöÊ¥ªÊΩëÂèØÊÑõÔºåÁπÅÈ´î‰∏≠Êñá„ÄÇ
                2. ÂÖßÂÆπÁ≤æÁ∞°ÔºåËã•ÈùûÊé®Ëñ¶ÂàóË°®ÔºåÂ≠óÊï∏ÊéßÂà∂Âú® 150 Â≠óÂÖß„ÄÇ
                `;
                
                const aiResponseText = await callGemini(systemPrompt, apiKey);
                
                // Basic JSON sanitization for chat response
                let cleanResponse = aiResponseText;
                // Try to extract JSON part if it's mixed with text (fallback)
                if (aiResponseText.includes('[') && aiResponseText.includes(']')) {
                     const start = aiResponseText.indexOf('[');
                     const end = aiResponseText.lastIndexOf(']');
                     if (start !== -1 && end !== -1) {
                         // Check if it looks like a JSON array response we want
                         const potentialJson = aiResponseText.substring(start, end + 1);
                         try {
                             JSON.parse(potentialJson); // Check validity
                             cleanResponse = potentialJson; // Use only the JSON part
                         } catch(e) {
                             // If parsing fails, keep original text, let MessageContent handle it or display raw
                         }
                     }
                }
                
                setMessages(prev => [...prev, { role: "ai", text: cleanResponse }]);
                setIsLoading(false);
            };

            if (!isOpen) return null;

            if (!apiKey) {
                return (
                    <div className="fixed inset-0 z-[5000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn">
                        <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 border-4 border-pink-200 relative text-center">
                             <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X size={24}/></button>
                             <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-2 border-pink-200">üîë</div>
                             <h3 className="text-xl font-bold text-gray-800 mb-2">ÂïüÂãï AI Ê´ªËä±ÈÜ¨</h3>
                             <p className="text-sm text-gray-500 mb-6">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Google Gemini API Key</p>
                             <input type="password" value={tempKey} onChange={(e) => setTempKey(e.target.value)} placeholder="API Key (AIza...)" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-pink-300 mb-4 transition-all" />
                             <button onClick={handleSaveKey} disabled={!tempKey} className="w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-600 active:scale-95 transition-transform disabled:opacity-50">Á¢∫Ë™çÂïüÂãï</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-[5000] bg-black/50 backdrop-blur-sm flex items-end justify-center sm:items-center p-4 animate-fadeIn pb-safe">
                    <Dialog 
                        isOpen={chatDialog.isOpen} 
                        type={chatDialog.type} 
                        message={chatDialog.message} 
                        onConfirm={chatDialog.onConfirm} 
                        onCancel={closeChatDialog} 
                    />
                    <div className="bg-white w-full max-w-md h-[80dvh] max-h-[85dvh] sm:h-[600px] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden border-4 border-pink-200 relative mb-safe">
                        <div className="bg-pink-100 p-4 flex justify-between items-center border-b border-pink-200 shrink-0 relative z-10">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl shadow-sm border-2 border-pink-300">üë©üèª‚Äçü¶∞</div>
                                <div>
                                    <h3 className="font-bold text-pink-600 text-lg">AI Ê´ªËä±ÈÜ¨</h3>
                                    <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span><span className="text-xs text-pink-400">Á∑ö‰∏ä</span><button onClick={handleClearKey} className="text-[10px] bg-white/50 px-1.5 py-0.5 rounded border border-pink-200 text-gray-500 hover:text-red-500">ÈáçË®≠</button></div>
                                </div>
                            </div>
                            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center bg-red-100 rounded-full hover:bg-red-200 text-red-500 border border-red-200"><Icons.X size={22} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#fffafc] overscroll-contain">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] p-4 rounded-2xl leading-relaxed whitespace-pre-wrap shadow-sm text-base ${msg.role === 'user' ? 'bg-pink-400 text-white rounded-tr-none' : 'bg-white border border-pink-100 text-gray-700 rounded-tl-none ai-content'}`}>
                                        {msg.role === 'system' ? <span className="text-pink-500 font-bold">{msg.text}</span> : <MessageContent text={msg.text} />}
                                    </div>
                                </div>
                            ))}
                            {isLoading && <div className="flex justify-start"><div className="bg-white border border-pink-100 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1"><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div></div></div>}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-3 bg-white border-t border-pink-100 flex items-center gap-2 pb-12 sm:pb-3 shrink-0 relative z-10">
                            <button onClick={handleGetLocation} disabled={locationStatus === 'loading'} className={`w-10 h-10 flex items-center justify-center shrink-0 rounded-2xl border transition-colors ${locationStatus === 'success' ? 'bg-green-100 text-green-600 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>{locationStatus === 'loading' ? <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div> : <Icons.MapPin size={20} />}</button>
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="ÈôÑËøëÊúâ‰ªÄÈ∫º..." className="flex-1 bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-pink-300 min-w-0"/>
                            <button onClick={handleSend} disabled={isLoading} className="bg-pink-500 text-white p-3 w-10 h-10 flex items-center justify-center rounded-2xl hover:bg-pink-600 disabled:opacity-50 shadow-md shrink-0"><Icons.Send size={20} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const LaceCard = ({ children, className, color = "pink", icon }) => {
            const styles = { 
                pink: { border: "border-pink-200/60", bg: "bg-pink-50", text: "text-pink-400", iconColor: "#ec4899" }, 
                blue: { border: "border-blue-200/60", bg: "bg-blue-50", text: "text-blue-400", iconColor: "#3b82f6" }, 
                orange: { border: "border-orange-200/60", bg: "bg-orange-50", text: "text-orange-400", iconColor: "#f97316" }, 
                green: { border: "border-green-200/60", bg: "bg-green-50", text: "text-green-400", iconColor: "#22c55e" },
                purple: { border: "border-purple-200/60", bg: "bg-purple-50", text: "text-purple-400", iconColor: "#a855f7" } 
            };
            const theme = styles[color];
            return (
                <div className={`relative p-1 rounded-3xl shadow-sm ${className} overflow-hidden`}>
                    <div className={`absolute inset-0 border-2 border-dashed ${theme.border} rounded-3xl pointer-events-none z-40`}></div>
                    <div className={`absolute top-2 left-2 ${theme.text} z-40`}><Icons.Heart size={12} fill="currentColor" className="opacity-50"/></div>
                    <div className={`absolute bottom-2 right-2 ${theme.text} z-40`}><Icons.Heart size={12} fill="currentColor" className="opacity-50"/></div>
                    <div className="relative h-full m-1 z-30">{children}</div>
                    <div className="absolute -right-4 -top-4 w-40 h-40 opacity-[0.25] transform rotate-12 pointer-events-none z-20"><div style={{ color: theme.iconColor }} className="w-full h-full">{icon ? React.cloneElement(icon, { color: theme.iconColor }) : null}</div></div>
                    <div className="absolute inset-1 rounded-2xl bg-white/40 backdrop-blur-md z-10"></div>
                </div>
            );
        };

        const Button3D = ({ children, onClick, isActive, color = "pink", className }) => {
            const styles = { pink: `bg-pink-400 border-pink-600 text-white ${isActive ? 'bg-pink-500 border-pink-700' : ''}`, white: `bg-white/80 border-gray-200/50 text-gray-600 backdrop-blur-sm ${isActive ? 'bg-white border-gray-300' : 'hover:bg-white'}`, blue: `bg-blue-400 border-blue-600 text-white` };
            const activeStyle = isActive ? "border-b-0 translate-y-1 shadow-inner" : "border-b-4 shadow-md active:border-b-0 active:translate-y-1 active:shadow-inner";
            return <button onClick={onClick} className={`${styles[color]} ${activeStyle} ${className} transition-all duration-100 rounded-xl font-bold flex items-center justify-center`}>{children}</button>;
        };

        const IOSInstallGuide = ({ onClose }) => (
            <div className="fixed inset-0 z-[9999] bg-black/70 flex items-center justify-center p-6 backdrop-blur-sm animate-fadeIn">
                <div className="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl relative text-center border-4 border-pink-200">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X size={24}/></button>
                    <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><Icons.Download size={32} className="text-pink-500"/></div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">ÂÆâË£ùÂà∞ iPhone</h3>
                    <p className="text-sm text-gray-500 mb-6">Â∞áÊ≠§Á∂≤È†ÅÂä†ÂÖ•‰∏ªÁï´Èù¢ÔºåÂ∞±ËÉΩÂÉè App ‰∏ÄÊ®£ÂÖ®Ëû¢Âπï‰ΩøÁî®ÂñîÔºÅ</p>
                    <button onClick={onClose} className="mt-6 w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-600 active:scale-95 transition-transform">ÊàëÁü•ÈÅì‰∫Ü</button>
                </div>
            </div>
        );

        const SplashScreen = () => (
            <div className="fixed inset-0 z-[10000] bg-gradient-to-b from-pink-100 to-white flex flex-col items-center justify-center animate-fadeOut pointer-events-none">
                <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg border-4 border-pink-200 mb-4 animate-bounce"><Icons.PlaneReal size={48} className="text-pink-500" /></div>
                <h1 className="text-2xl font-bold text-pink-600 tracking-wider">Â§ßÈò™‰∫¨ÈÉΩË°å</h1>
                <p className="text-sm text-pink-400 mt-2">ÊóÖÁ®ãÊ∫ñÂÇô‰∏≠...</p>
            </div>
        );

        const SakuraRain = () => {
            const petals = Array.from({ length: 12 }).map((_, i) => ({ id: i, left: Math.random() * 100 + '%', animationDuration: 8 + Math.random() * 10 + 's', animationDelay: Math.random() * 5 + 's', opacity: 0.4 + Math.random() * 0.5, size: 12 + Math.random() * 12 + 'px' }));
            return (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-50">
                    {petals.map((petal) => (<div key={petal.id} className="absolute top-[-20px]" style={{ left: petal.left, width: petal.size, height: petal.size, animation: `sakura-fall ${petal.animationDuration} linear infinite`, animationDelay: petal.animationDelay, opacity: petal.opacity }}><SimpleSakura className="w-full h-full" /></div>))}
                </div>
            );
        };

        const TripAssistant = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [selectedDayIndex, setSelectedDayIndex] = useState(0);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [isIos, setIsIos] = useState(false);
            const [showSplash, setShowSplash] = useState(true);
            const [apiKey, setApiKey] = useState(() => {
                try { return localStorage.getItem('gemini_api_key') || ""; } catch (e) { return ""; }
            });
            
            const dayMenuRef = useRef(null);
            const mainContentRef = useRef(null);

            const [jpyAmount, setJpyAmount] = useState('');
            const [exchangeRate, setExchangeRate] = useState(0.215); 
            const [isRateLoading, setIsRateLoading] = useState(false);
            const [weatherLoc, setWeatherLoc] = useState(null);
            const [locLoading, setLocLoading] = useState(false);
            
            // Daily Briefings State
            const [dailyBriefings, setDailyBriefings] = useState({});
            const [briefingLoading, setBriefingLoading] = useState(false);

            // Daily Posts State
            const [dailyPosts, setDailyPosts] = useState({});
            const [postLoading, setPostLoading] = useState(false);

            // Budget Analysis State
            const [budgetAnalysis, setBudgetAnalysis] = useState(null);
            const [analyzingBudget, setAnalyzingBudget] = useState(false);

            // Translation State
            const [translationInput, setTranslationInput] = useState("");
            const [translationResult, setTranslationResult] = useState(null);
            const [isTranslating, setIsTranslating] = useState(false);
            const [visionImage, setVisionImage] = useState(null);
            const [isVisionAnalyzing, setIsVisionAnalyzing] = useState(false);
            const [visionResult, setVisionResult] = useState(null);

            // Souvenir State
            const [souvenirRecipient, setSouvenirRecipient] = useState("");
            const [souvenirSuggestion, setSouvenirSuggestion] = useState(null);
            const [isSuggestingSouvenir, setIsSuggestingSouvenir] = useState(false);
            
            // Dialog state
            const [dialog, setDialog] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
            const closeDialog = () => setDialog(prev => ({ ...prev, isOpen: false }));

            const fetchRate = async () => {
                setIsRateLoading(true);
                try {
                     const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                     if(!res.ok) throw new Error('Network response was not ok');
                     const data = await res.json();
                     if(data.rates.TWD) setExchangeRate(data.rates.TWD);
                } catch (error) {
                    console.error("Failed to fetch rate:", error);
                } finally {
                    setIsRateLoading(false);
                }
            };

            const requestLocation = () => {
                if (!navigator.geolocation) {
                    setDialog({ isOpen: true, type: 'alert', message: "ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰Ωç", onConfirm: closeDialog });
                    return;
                }
                setLocLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        setWeatherLoc({ lat: pos.coords.latitude, lon: pos.coords.longitude });
                        setLocLoading(false);
                    },
                    (err) => {
                        console.log(err);
                        setLocLoading(false);
                        setDialog({ isOpen: true, type: 'alert', message: "ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆÔºöË´ãÊ™¢Êü•ÂÆö‰ΩçÊ¨äÈôê", onConfirm: closeDialog });
                    }
                );
            };

            useEffect(() => { fetchRate(); }, []);
            useEffect(() => { const timer = setTimeout(() => setShowSplash(false), 2000); return () => clearTimeout(timer); }, []);

            const [completedActivities, setCompletedActivities] = useState({});
            const [isDataLoaded, setIsDataLoaded] = useState(false);

            useEffect(() => {
                try {
                    if (typeof window !== 'undefined') {
                        const savedActs = localStorage.getItem('trip_acts_v3');
                        if (savedActs) setCompletedActivities(JSON.parse(savedActs));
                        const savedBudget = localStorage.getItem('budget_analysis_v2');
                        if (savedBudget) setBudgetAnalysis(JSON.parse(savedBudget));
                    }
                } catch (e) { console.warn("Load failed", e); }
                setIsDataLoaded(true);
            }, []);

            useEffect(() => {
                if (isDataLoaded) {
                    try { localStorage.setItem('trip_acts_v3', JSON.stringify(completedActivities)); } catch (e) {}
                }
            }, [completedActivities, isDataLoaded]);

            const toggleActivity = (dayIndex, actIndex) => {
                const key = `${dayIndex}-${actIndex}`;
                setCompletedActivities(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const clearAllData = () => {
                setDialog({
                    isOpen: true,
                    type: 'confirm',
                    message: "Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊâìÂãæÁ¥ÄÈåÑÂóéÔºü",
                    onConfirm: () => {
                        setCompletedActivities({});
                        setBudgetAnalysis(null);
                        try { 
                            localStorage.removeItem('trip_acts_v3'); 
                            localStorage.removeItem('budget_analysis_v2');
                        } catch(e){}
                        closeDialog();
                    }
                });
            };

            useEffect(() => {
                const checkIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.navigator.standalone === true;
                if (checkIos && !isStandalone) {
                    setIsIos(true);
                    if (!sessionStorage.getItem('installGuideShown')) {
                        setTimeout(() => {
                            setShowInstallModal(true);
                            sessionStorage.setItem('installGuideShown', 'true');
                        }, 1500);
                    }
                }
            }, []);

            useEffect(() => {
                if (dayMenuRef.current) {
                    const selectedBtn = dayMenuRef.current.children[selectedDayIndex];
                    if (selectedBtn) selectedBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, [selectedDayIndex]);

            const dayCityMap = {
                0: 'kyoto', 1: 'kyoto', 2: 'kyoto', 3: 'nara', 4: 'kyoto',
                5: 'kyoto', 6: 'osaka', 7: 'osaka', 8: 'osaka', 9: 'osaka'
            };

            const tripData = {
                flights: [ { type: 'ÂéªÁ®ã', date: '12/15 (‰∏Ä)', flight: 'Ê®ÇÊ°É MM026', dep: 'TPE 13:40 (Ê°ÉÊ©ü T1)', arr: 'KIX 17:05 (ÈóúË•ø)', note: 'ÊäµÈÅîÂæåÈ†òË°åÊùéÁ¥Ñ 18:00ÔºåÊê≠ Haruka ÂæÄ‰∫¨ÈÉΩ' }, { type: 'ÂõûÁ®ã', date: '12/24 (‰∏â)', flight: 'Ê®ÇÊ°É MM025', dep: 'KIX 10:10 (ÈóúË•ø T2)', arr: 'TPE 12:45 (Ê°ÉÊ©ü)', note: '08:10 ÂâçÈúÄÊäµÈÅîÊ©üÂ†¥' } ],
                hotels: [ { city: '‰∫¨ÈÉΩ', name: "Hotel The M‚Äôs Kyoto", rating: '9.0', address: '6,8-1,Higashisanno-cho,Higashikujo,Minami-ku,Âçó,‰∫¨ÈÉΩ,Êó•Êú¨ 601-8004', checkIn: '12/15 - 12/20 (‰∫îÊôö)', transport: '‰∫¨ÈÉΩÂæåÁ´ôÊ≠•Ë°å 5-8 ÂàÜ', priceNote: 'Â®ü+ËìÅ: $4093/‰∫∫ | Danny: $7647/‰∫∫', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+The+Ms+Kyoto' }, { city: 'Â§ßÈò™', name: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", tel: '06-7668-2031', address: 'Â§ßÈò™Â∫úÂ§ßÈò™Â∏ÇÊµ™ÈÄüÂçÄÈõ£Ê≥¢‰∏≠1-6-5', checkIn: '12/20 - 12/24 (ÂõõÊôö)', transport: 'ÂçóÊµ∑ÈõªÈêµÈõ£Ê≥¢Á´ôÊóÅÔºå7ËôüÂá∫Âè£(Ê®ìÊ¢Ø)Êàñ10Ëôü/5Ëôü(ÈõªÊ¢Ø/Êâ∂Ê¢Ø)', priceNote: 'Â®ü+ËìÅ: $7875/‰∫∫ | Danny: $14280/‰∫∫', mapLink: 'https://www.google.com/maps/search/?api=1&query=Sotetsu+Fresa+inn+Osaka-Namba' } ],
                itinerary: [
                    { 
                        date: '12/15', shortDate: '12/15', day: 'ÈÄ±‰∏Ä', title: 'ÊäµÈÅî‰∫¨ÈÉΩ', icon: <SimpleFuji className="w-full h-full" />, color: "blue", 
                        activities: [ { time: '17:05', content: 'ÊäµÈÅîÈóúË•øÊ©üÂ†¥ (T2)', icon: <Icons.PlaneReal className="w-4 h-4" /> }, { time: '18:16', content: 'Êê≠‰πò Haruka ÂæÄ‰∫¨ÈÉΩ', icon: <Icons.Train className="w-4 h-4" /> }, { time: '20:00', content: 'È£ØÂ∫ó Check-in', icon: <Icons.Hotel className="w-4 h-4" /> }, { time: 'ÊôöÈñì', content: 'Êú¨ÂÆ∂Á¨¨‰∏ÄÊó≠ÊãâÈ∫µ', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'Haruka ÂæÄ‰∫¨ÈÉΩÁôºËªäÊôÇÂàªÔºö18:16„ÄÅ18:46„ÄÅ19:16„ÄÅ19:46„ÄÇ' }, { type: 'food', text: 'Ëã•Á¨¨‰∏ÄÊó≠ÊéíÈöäÈÅéÈï∑ÔºåÈöîÂ£ÅÁöÑ„ÄåÊñ∞Á¶èËèúÈ§®„Äç‰πüÊòØËÄÅÂ≠óËôüÈªëÈÜ¨Ê≤πÊãâÈ∫µ„ÄÇ' } ], 
                        spots: [ 
                            { name: "Êú¨ÂÆ∂Á¨¨‰∏ÄÊó≠", mapUrl: "https://www.google.com/maps/search/?api=1&query=Honke+Daiichi-Asahi", highlights: ["Á∂ìÂÖ∏ÈÜ¨Ê≤πË±öÈ™®", "ÊªøÊªøËî•Ëä±", "ÁÖéÈ§É"], tips: "ÊéíÈöäÂêçÂ∫óÔºåÂª∫Ë≠∞ÈÅøÈñãÁî®È§êÂ∞ñÂ≥∞„ÄÇ" },
                            { name: "‰∫¨ÈÉΩËªäÁ´ô", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kyoto+Station", highlights: ["Â§ßÈöéÊ¢ØÁáàÂÖâÁßÄ", "‰∫¨ÈÉΩÂ°îÂ§úÊôØ", "ÊãâÈ∫µÂ∞èË∑Ø"], tips: "Âá∫Á´ôÂæåÊä¨È†≠Áúã‰∫¨ÈÉΩÂ°îÔºåÊôö‰∏äÂæàÁæé„ÄÇ" } 
                        ] 
                    },
                    { 
                        date: '12/16', shortDate: '12/16', day: 'ÈÄ±‰∫å', title: 'Á∂ìÂÖ∏‰∫¨ÈÉΩÔºöÊ∏ÖÊ∞¥ÂØ∫', icon: <SimpleTorii className="w-full h-full" />, color: "pink", 
                        activities: [ { time: '‰∏äÂçà', content: 'Ê∏ÖÊ∞¥ÂØ∫„ÄÅÂú∞‰∏ªÁ•ûÁ§æ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: '‰∫åÂπ¥ÂùÇ„ÄÅ‰∏âÂπ¥ÂùÇ„ÄÅÂÖ´ÂùÇÁ•ûÁ§æ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ÂÇçÊôö', content: 'Á•áÂúí„ÄÅËä±Ë¶ãÂ∞èË∑Ø', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: '‰∫¨ÈÉΩËªäÁ´ôÊê≠ 206 Êàñ 100 ËôüÂ∑¥Â£´ÔºåÂú®„Äå‰∫îÊù°ÂùÇ„Äç‰∏ãËªäÊ≠•Ë°å‰∏äÂ±±„ÄÇ' } ], 
                        spots: [ 
                            { name: "Ê∏ÖÊ∞¥ÂØ∫", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kiyomizu-dera", highlights: ["Ê∏ÖÊ∞¥ËàûÂè∞", "Èü≥ÁæΩÁÄëÂ∏É", "ËÉéÂÖßÂ∑°ÈÅä"], tips: "Èü≥ÁæΩÁÄëÂ∏É‰∏âÂÄãÂè™ËÉΩÂñù‰∏ÄÂÄã„ÄÇËÉéÂÖßÂ∑°ÈÅäÂÄºÂæó‰∏ÄË©¶„ÄÇ" }, 
                            { name: "‰∫åÂπ¥ÂùÇ/‰∏âÂπ¥ÂùÇ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Sannenzaka", highlights: ["ÊòüÂ∑¥ÂÖãÊ¶ªÊ¶ªÁ±≥Â∫ó", "‰∏ÉÂë≥ÂÆ∂Êú¨Ëàñ"], tips: "ÂÇ≥Ë™™Âú®‰∏âÂπ¥ÂùÇË∑åÂÄíÊúÉÂÄíÊ•£‰∏âÂπ¥ÔºåËµ∞Ë∑ØË´ãÂ∞èÂøÉÔºÅ" },
                            { name: "ÂÖ´ÂùÇÁ•ûÁ§æ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Yasaka+Shrine", highlights: ["ËàûÊÆøÁáàÁ±†", "ÁæéÂÆπÊ∞¥", "Ê±ÇÊàÄÊÑõÈÅã"], tips: "ÈÄôË£°ÁöÑÁæéÂÆπÊ∞¥ÊìöË™™ÊãçÂú®Ëáâ‰∏äÊúÉËÆäÁæéÂñî„ÄÇ" },
                            { name: "Á•áÂúí/Ëä±Ë¶ãÂ∞èË∑Ø", mapUrl: "https://www.google.com/maps/search/?api=1&query=Hanamikoji+Street", highlights: ["ËóùÂ¶ìË°óÂçÄ", "Âè§ËÄÅÁî∫ÂÆ∂", "ËêäÂç°Áõ∏Ê©üÂ∫ó"], tips: "ÂÇçÊôöÊúâÊ©üÊúÉÁúãÂà∞ËóùÂ¶ìÔºåË´ãÂãøËß∏Êë∏ÊàñÊú™Á∂ìÂêåÊÑèËøëË∑ùÈõ¢ÊãçÁÖß„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/17', shortDate: '12/17', day: 'ÈÄ±‰∏â', title: 'ÈáëÈñ£ÂØ∫Ëàá‰∫åÊ¢ùÂüé', icon: <SimpleMatcha className="w-full h-full" />, color: "green", 
                        activities: [ { time: '‰∏äÂçà', content: 'ÈáëÈñ£ÂØ∫ (ÈπøËãëÂØ∫)', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: '‰∫åÊ¢ùÂüé / Èå¶Â∏ÇÂ†¥', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ÊôöÈñì', content: 'Ê≤≥ÂéüÁî∫ÈÄõË°ó', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: '‰∫¨ÈÉΩËªäÁ´ôÊê≠ 101/111/205 ËôüÂ∑¥Â£´Ëá≥„ÄåÈáëÈñ£ÂØ∫ÈÅì„Äç„ÄÇ' }, { type: 'info', text: 'Èå¶Â∏ÇÂ†¥Âª∫Ë≠∞‰∏ãÂçà 4:30 ÂâçÊäµÈÅî„ÄÇ' } ], 
                        spots: [ 
                            { name: "ÈáëÈñ£ÂØ∫", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kinkakuji", highlights: ["ÈáëËâ≤ÂÄíÂΩ±", "ÈñÄÁ•®(ÂÆàË≠∑Á¨¶)", "ÈáëÁÆîÊäπËå∂ÂÜ∞Ê∑áÊ∑ã"], tips: "ÊúÄ‰Ω≥ÊãçÁÖßÈªûÂú®ÂâõÈÄ≤ÈñÄÁöÑÊ±†Â°òÂ∞çÂ≤∏„ÄÇ" },
                            { name: "‰∫åÊ¢ùÂüé", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nijo+Castle", highlights: ["‰∫å‰πã‰∏∏Âæ°ÊÆø", "È∂ØËÅ≤Âú∞Êùø", "ÂîêÈñÄ"], tips: "Ëµ∞Âú®Âæ°ÊÆøÂÖßÂú∞ÊùøÊúÉÊúâÂÉèÈªÉÈ∂ØÂè´ÁöÑËÅ≤Èü≥ÔºåÊòØÁî®‰æÜÈò≤Âà∫ÂÆ¢ÁöÑ„ÄÇ" },
                            { name: "Èå¶Â∏ÇÂ†¥", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nishiki+Market", highlights: ["Âè≤Âä™ÊØîËå∂Â±ã", "Ë±Ü‰π≥ÁîúÁîúÂúà", "‰∏âÊú®ÈõûÂçµ"], tips: "‰∫¨ÈÉΩÁöÑÂªöÊàøÔºåË´ãÂãøÈÇäËµ∞ÈÇäÂêÉ„ÄÇ" },
                            { name: "Ê≤≥ÂéüÁî∫", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kawaramachi+Kyoto", highlights: ["ÁôæË≤®ÂÖ¨Âè∏", "Ëó•Â¶ùÂ∫ó", "Ëø™Â£´Â∞ºÂïÜÂ∫ó"], tips: "ÊúÄÂ•ΩÈÄõÁöÑÂçÄÂüüÔºåÊâÄÊúâ‰º¥ÊâãÁ¶ÆÈÄôË£°ÈÉΩÊúâ„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/18', shortDate: '12/18', day: 'ÈÄ±Âõõ', title: 'Â•àËâØÂ∞èÈπøËàáÂÆáÊ≤ªÊäπËå∂', icon: <SimpleDeer className="w-full h-full" />, color: "orange", 
                        activities: [ { time: '‰∏äÂçà', content: 'Â•àËâØÂÖ¨Âúí„ÄÅÊù±Â§ßÂØ∫', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: 'ÂÆáÊ≤ªÂπ≥Á≠âÈô¢„ÄÅË°®ÂèÉÈÅì', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ÊôöÈñì', content: '‰∫¨ÈÉΩÊôöÈ§ê', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'ÂÖ®Á®ãÊê≠‰πò JR Â•àËâØÁ∑ö„ÄÇ' } ], 
                        spots: [ 
                            { name: "Â•àËâØÂÖ¨Âúí", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nara+Park", highlights: ["È§µÈπøÂêÉ‰ªôË≤ù", "Êù±Â§ßÂØ∫Â§ß‰Ωõ", "ÈëΩÂ§ß‰ΩõÈºªÂ≠î"], tips: "ÈπøÂæàËÅ∞Êòé‰πüÂæàË≤™ÂêÉÔºåÊ≤í‰ªôË≤ùÊôÇË´ãÊî§ÈñãÈõôÊâãÁ§∫ÊÑè„ÄÇ" },
                            { name: "Âπ≥Á≠âÈô¢", mapUrl: "https://www.google.com/maps/search/?api=1&query=Byodoin", highlights: ["È≥≥Âá∞Â†Ç", "10ÂÖÉÁ°¨Âπ£ÂúñÊ°à", "Á¥´Ëó§Ëä±"], tips: "10Êó•ÂúìÁ°¨Âπ£ËÉåÂæåÁöÑÂúñÊ°àÂ∞±ÊòØÈ≥≥Âá∞Â†Ç„ÄÇ" },
                            { name: "‰∏≠ÊùëËó§Âêâ (ÂÆáÊ≤ª)", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nakamura+Tokichi+Honten", highlights: ["ÊäπËå∂Âáç", "ÊäπËå∂ÂÜ∞Ê∑áÊ∑ã"], tips: "ÈùûÂ∏∏ÁÜ±ÈñÄÔºåÂª∫Ë≠∞‰∏ÄÂà∞ÂÆáÊ≤ªÂÖàÂéªÊäΩËôüÁ¢ºÁâå„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/19', shortDate: '12/19', day: 'ÈÄ±‰∫î', title: 'ÂµêÂ±±Ê∑±Â∫¶ÈÅä', icon: <SimpleFuji className="w-full h-full" />, color: "green", 
                        activities: [ { time: '‰∏äÂçà', content: 'ÂµêÂ±±Á´πÊûó„ÄÅÈáéÂÆÆÁ•ûÁ§æ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ÂÖ®Â§©', content: 'Ê∏°ÊúàÊ©ã„ÄÅÂµêÂ±±Â§ßË°ó', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ÊôöÈñì', content: 'Ê≤≥ÂéüÁî∫ÊôöÈ§ê', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'JR ÂµØÂ≥®ÈáéÁ∑öËá≥ÂµêÂ±±Á´ô (Á¥Ñ17ÂàÜ)„ÄÇ' } ], 
                        spots: [ 
                            { name: "ÂµêÂ±±Á´πÊûó", mapUrl: "https://www.google.com/maps/search/?api=1&query=Arashiyama+Bamboo+Grove", highlights: ["Á´πÊûó‰πãÈÅì", "ÈáéÂÆÆÁ•ûÁ§æ", "Â§©ÈæçÂØ∫"], tips: "ÊÉ≥ÊãçÁ©∫ÊôØÈúÄÊó©‰∏ä8ÈªûÂâçÊäµÈÅî„ÄÇ" },
                            { name: "Ê∏°ÊúàÊ©ã", mapUrl: "https://www.google.com/maps/search/?api=1&query=Togetsukyo+Bridge", highlights: ["Ê°ÇÂ∑ùÈ¢®ÊôØ", "ÂµêÂ±±ÂÖ¨Âúí"], tips: "ÊüØÂçóÈõªÂΩ±Áâà„ÄäÂîêÁ¥ÖÁöÑÊàÄÊ≠å„ÄãÂèñÊôØÂú∞„ÄÇ" },
                            { name: "ÈáéÂÆÆÁ•ûÁ§æ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nonomiya+Shrine", highlights: ["Á∑†ÁµêËâØÁ∑£", "ÈªëËâ≤È≥•Â±Ö", "Á•ûÁü≥(ÈæúÁü≥)"], tips: "ÊìöË™™Êë∏‰∫ÜÁ•ûÁü≥È°òÊúõÊúÉÊàêÁúü„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/20', shortDate: '12/20', day: 'ÈÄ±ÂÖ≠', title: 'ÁßªÂãïÊó•Ôºö‰ºèË¶ãÁ®ªËç∑', icon: <SimpleTorii className="w-full h-full" />, color: "pink", 
                        activities: [ { time: '‰∏äÂçà', content: '‰ºèË¶ãÁ®ªËç∑Â§ßÁ§æ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: 'ÁßªÂãïËá≥Â§ßÈò™Èõ£Ê≥¢È£ØÂ∫ó', icon: <Icons.Train className="w-4 h-4" /> }, { time: 'ÊôöÈñì', content: 'ÈÅìÈ†ìÂ¥õ„ÄÅÂøÉÈΩãÊ©ã', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'Ë°åÊùéÂèØÂØÑÊîæÈ£ØÂ∫óÊàñËªäÁ´ô„ÄÇJR Â•àËâØÁ∑öËá≥Á®ªËç∑Á´ô„ÄÇ' } ], 
                        spots: [ 
                            { name: "‰ºèË¶ãÁ®ªËç∑Â§ßÁ§æ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Fushimi+Inari+Taisha", highlights: ["ÂçÉÊú¨È≥•Â±Ö", "ÁãêÁã∏Áπ™È¶¨", "ËàâÈáçÁü≥"], tips: "ÂçÉÊú¨È≥•Â±ÖÂâçÊÆµ‰∫∫ÂæàÂ§öÔºåÂæÄÂ±±‰∏äËµ∞‰∫∫ÊΩÆÊúÉÈ©üÊ∏õ„ÄÇ" },
                            { name: "ÈÅìÈ†ìÂ¥õ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Dotonbori", highlights: ["Ë∑ëË∑ë‰∫∫ÁúãÊùø", "Â∑®ÂûãÊãõÁâå", "ÂîêÂêâË®∂Âæ∑"], tips: "ÂøÖÊãçÂõ∫ÂäõÊûúË∑ëË∑ë‰∫∫ÁúãÊùøÔºåÊôö‰∏äÊúÄÁÜ±È¨ß„ÄÇ" },
                            { name: "ÂøÉÈΩãÊ©ãÁ≠ã", mapUrl: "https://www.google.com/maps/search/?api=1&query=Shinsaibashi-suji", highlights: ["Ëó•Â¶ùÊøÄÊà∞ÂçÄ", "ÊúçÈ£æÂ∫ó", "Â§ß‰∏∏ÁôæË≤®"], tips: "ÊúâÂ±ãÈ†ÇÁöÑÂïÜÂ∫óË°óÔºå‰∏ãÈõ®‰πü‰∏çÊÄï„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/21', shortDate: '12/21', day: 'ÈÄ±Êó•', title: 'Â§ßÈò™Êé¢Á¥¢ÔºöÂãùÂ∞æÂØ∫', icon: <SimpleDaruma className="w-full h-full" />, color: "blue", 
                        activities: [ { time: '‰∏äÂçà', content: 'ÈªëÈñÄÂ∏ÇÂ†¥', icon: <Icons.Coffee className="w-4 h-4" /> }, { time: 'ÂçàÈñì', content: 'Â§ßÈò™Âüé', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: 'ÂãùÂ∞æÂØ∫ (Ê±ÇÂãùÈÅã)', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'ÂãùÂ∞æÂØ∫ÔºöÂú∞ÈêµÂæ°Â†ÇÁ≠ãÁ∑öÁõ¥ÈÄöÂåóÂ§ßÈò™ÊÄ•Ë°åËá≥„ÄåÁÆïÈù¢Ëê±ÈáéÁ´ô„ÄçÔºåËΩâ‰πòÂÖ¨Ëªä„ÄÇ' } ], 
                        spots: [ 
                            { name: "ÂãùÂ∞æÂØ∫", mapUrl: "https://www.google.com/maps/search/?api=1&query=Katsuo-ji", highlights: ["ÊªøÂ±±ÊªøË∞∑ÁöÑÈÅîÊë©", "Ê±ÇÂãùÈÅã", "ÈÅîÊë©Á±§"], tips: "Ë≤∑ÂÄãÈÅîÊë©ÔºåÁï´‰∏äÂ∑¶ÁúºË®±È°òÔºåÈ°òÊúõÂØ¶ÁèæÂæåÂÜçÁï´Âè≥Áúº‰∏¶ÈÇÑÈ°ò„ÄÇ" },
                            { name: "ÈªëÈñÄÂ∏ÇÂ†¥", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kuromon+Market", highlights: ["ÁèæÁÉ§Êµ∑ÈÆÆ", "ÈóúÊù±ÁÖÆ", "Á•ûÊà∂Áâõ"], tips: "ËßÄÂÖâÂÆ¢ËºÉÂ§öÔºåÂÉπÊ†ºÂÅèÈ´òÔºåÂª∫Ë≠∞Â§öÊØîÂÉπ„ÄÇ" },
                            { name: "Â§ßÈò™ÂüéÂÖ¨Âúí", mapUrl: "https://www.google.com/maps/search/?api=1&query=Osaka+Castle", highlights: ["Â§©ÂÆàÈñ£", "Ë≠∑ÂüéÊ≤≥", "Âæ°Â∫ßËàπ"], tips: "ÂÖ¨ÂúíÂæàÂ§ßÔºåÂ¶ÇÊûúË¶Å‰∏äÂ§©ÂÆàÈñ£Âª∫Ë≠∞È†êÁïôÊôÇÈñì„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/22', shortDate: '12/22', day: 'ÈÄ±‰∏Ä', title: 'Áí∞ÁêÉÂΩ±Âüé USJ', icon: <Icons.Star className="w-full h-full text-yellow-400 fill-yellow-400" />, color: "orange", 
                        activities: [ { time: 'ÂÖ®Â§©', content: 'USJ Áí∞ÁêÉÂΩ±Âüé', icon: <Icons.Sun className="w-4 h-4" /> }, { time: '‰∫§ÈÄö', content: 'JR Ê´ªÂ≥∂Á∑öËá≥Áí∞ÁêÉÂΩ±ÂüéÁ´ô', icon: <Icons.Train className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'Âª∫Ë≠∞ÈñãÂúíÂâç 1-1.5 Â∞èÊôÇÊäµÈÅîÊéíÈöä„ÄÇ' } ], 
                        spots: [ 
                            { name: "USJ Áí∞ÁêÉÂΩ±Âüé", mapUrl: "https://www.google.com/maps/search/?api=1&query=Universal+Studios+Japan", highlights: ["Ë∂ÖÁ¥ö‰ªªÂ§©Â†Ç‰∏ñÁïå", "ÂìàÂà©Ê≥¢Áâπ", "Â∞èÂ∞èÂÖµ"], tips: "ÂÖ•ÂúíÁ¨¨‰∏Ä‰ª∂‰∫ãÔºöÁî® APP ÊäΩ‰ªªÂ§©Â†ÇÊï¥ÁêÜÂà∏„ÄÇ" } 
                        ] 
                    },
                    { 
                        date: '12/23', shortDate: '12/23', day: 'ÈÄ±‰∫å', title: 'Â§ßÈ≥•Â§ßÁ§æËàáÊñ∞‰∏ñÁïå', icon: <SimpleOnigiri className="w-full h-full" />, color: "blue", 
                        activities: [ { time: '‰∏äÂçà', content: 'Â§ßÈ≥•Â§ßÁ§æ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: '‰∏ãÂçà', content: 'ÈÄöÂ§©Èñ£„ÄÅÊñ∞‰∏ñÁïå', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'Â§ßÈ≥•Â§ßÁ§æÔºöJR È≥≥Á´ôË•øÂá∫Âè£Ê≠•Ë°å7ÂàÜ„ÄÇ' }, { type: 'transport', text: 'Êñ∞‰∏ñÁïåÔºöÂú∞ÈêµÊÉ†ÁæéÈ†àÁî∫Á´ô„ÄÇ' } ], 
                        spots: [ 
                            { name: "Â§ßÈ≥•Â§ßÁ§æ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Otori+Taisha", highlights: ["ÂíåÊ≥âÂúã‰∏Ä‰πãÂÆÆ", "ÈÄèÊòéÂæ°ÂÆà", "ÂãùÈÅã‰πãÁ•û"], tips: "„ÄåÈÄèÊòéÂæ°ÂÆà„ÄçÊºÇ‰∫ÆÂèàÁâπÂà•ÔºåÈÅ©ÂêàÁï∂‰º¥ÊâãÁ¶Æ„ÄÇ" }, 
                            { name: "Êñ∞‰∏ñÁïå", mapUrl: "https://www.google.com/maps/search/?api=1&query=Shinsekai", highlights: ["ÈÄöÂ§©Èñ£", "ÁÇ∏‰∏≤", "Smart Ball"], tips: "ÈÄôË£°ÊúâÊøÉÊøÉÁöÑÊò≠ÂíåÂæ©Âè§È¢®ÔºåÂøÖÂêÉÁÇ∏‰∏≤„ÄÇ" },
                            { name: "ÈÄöÂ§©Èñ£", mapUrl: "https://www.google.com/maps/search/?api=1&query=Tsutenkaku", highlights: ["ËßÄÊôØÂè∞", "Ê∫úÊªëÊ¢Ø", "ÊØîÂà©ËÇØÁ•ûÂÉè"], tips: "Êë∏Êë∏ÊØîÂà©ËÇØÁ•ûÂÉèÁöÑËÖ≥Â∫ïÊúÉÂ∏∂‰æÜÂ•ΩÈÅã„ÄÇ" }
                        ] 
                    },
                    { 
                        date: '12/24', shortDate: '12/24', day: 'ÈÄ±‰∏â', title: 'ËøîÁ®ã', icon: <Icons.PlaneReal className="w-full h-full text-blue-400" />, color: "blue", 
                        activities: [ { time: '06:30', content: 'Êê≠‰πòÂçóÊµ∑ÈõªÈêµÂâçÂæÄÊ©üÂ†¥', icon: <Icons.Train className="w-4 h-4" /> }, { time: '08:10', content: 'ÊäµÈÅîÈóúË•øÊ©üÂ†¥ T2', icon: <Icons.PlaneReal className="w-4 h-4" /> }, { time: '10:10', content: 'Êê≠‰πòÊ®ÇÊ°É MM025 ËøîÂè∞', icon: <Icons.PlaneReal className="w-4 h-4" /> } ], 
                        details: [ { type: 'info', text: 'Ê®ÇÊ°ÉÂú® T2ÔºåÂæû T1 ÈúÄÊê≠Êé•ÈßÅËªäÔºåË´ãÂ§öÈ†êÁïôÊôÇÈñì„ÄÇ' } ], 
                        spots: [
                            { name: "ÈóúË•øÊ©üÂ†¥ T2", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kansai+Airport+Terminal+2", highlights: ["ÂÖçÁ®ÖÂ∫ó", "‰º¥ÊâãÁ¶Æ"], tips: "T2 ÂïÜÂ∫óËºÉÂ∞ëÔºåÂª∫Ë≠∞ÂÖ•ÈóúÂâçÂÖàË≤∑Â•Ω„ÄÇ" }
                        ] 
                    }
                ],
                transportGuides: [
                    { title: 'ÂãùÂ∞æÂØ∫‰∫§ÈÄö (Ë©≥Á¥∞Áâà)', steps: [ 'Êê≠‰πòÁ¥ÖÁ∑öÂú∞ÈêµËá≥„ÄåÁÆïÈù¢Ëê±ÈáéÁ´ô„Äç', 'ÂÖ¨Ëªä 6 ËôüÊúàÂè∞', 'ËΩâ‰πòÈò™ÊÄ•Â∑¥Â£´ 29 ËôüÊàñ 30 Ëôü', 'Êñº„ÄåÂãùÂ∞æÂØ∫Á´ô„Äç‰∏ãËªä (¬•800)' ] },
                    { title: 'Èõ£Ê≥¢ -> ÈóúË•øÊ©üÂ†¥ (ÂõûÁ®ã)', steps: [ 'ÂçóÊµ∑ÈõªÈêµ (Airport Exp.)', '06:30 ‚Üí 07:08 (Êé®Ëñ¶)', '07:00 ‚Üí 07:34 (Rapi:t)', '07:30 ‚Üí 08:10 (ÊúÄÂæåÊ•µÈôê)' ] }
                ]
            };

            const CopyButton = ({ text }) => {
                const [copied, setCopied] = useState(false);
                const handleCopy = (e) => {
                    e.stopPropagation();
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) {}
                    document.body.removeChild(textarea);
                };
                return <Button3D onClick={handleCopy} color="white" className="ml-2 px-3 py-1 text-xs h-8">{copied ? <Icons.Check size={14} className="mr-1"/> : <Icons.Copy size={14} className="mr-1"/>}{copied ? 'Â∑≤Ë§áË£Ω' : 'Ë§áË£Ω'}</Button3D>;
            };

            const scrollToTop = () => {
                if (mainContentRef.current) {
                    mainContentRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // Gemini Briefing Function
            const handleGenerateBriefing = async (idx) => {
                if(!apiKey) { 
                    setDialog({ 
                        isOpen: true, 
                        type: 'alert', 
                        message: "Ë´ãÂÖàÈªûÊìäÂ∑¶‰∏ãËßí ‚ú® ÊåâÈàïÔºåËº∏ÂÖ• API Key ÊâçËÉΩÂëºÂè´Ê´ªËä±ÈÜ¨ÂñîÔºÅ", 
                        onConfirm: closeDialog 
                    }); 
                    return; 
                }
                
                setBriefingLoading(true);
                const day = tripData.itinerary[idx];
                const city = dayCityMap[idx];
                
                const prompt = `
                ‰Ω†ÊòØÊ´ªËä±ÈÜ¨Ôºå‰∏ÄÂÄãÂèØÊÑõÁöÑÊó•Êú¨ÊóÖÈÅäÂ∞èÂπ´Êâã„ÄÇ
                
                „Äê‰ªªÂãô„Äë
                ÁÇ∫‰ΩøÁî®ËÄÖÁîüÊàê„Äå12Êúà${day.date} ${city} ‰∏ÄÊó•ÈÅä„ÄçÁöÑÂ∞àÂ±¨ÊîªÁï•„ÄÇ
                
                „ÄêË°åÁ®ãË≥áË®ä„Äë
                - Êó•Êúü: 12Êúà${day.date}
                - ÂüéÂ∏Ç: ${city === 'kyoto' ? '‰∫¨ÈÉΩ' : (city === 'osaka' ? 'Â§ßÈò™' : 'Â•àËâØ')}
                - Ë°åÁ®ãÊôØÈªû: ${day.activities.map(a => a.content).join(', ')}
                
                „ÄêË´ãÁîüÊàê‰ª•‰∏ã 3 ÈªûÂÖßÂÆπ (Ë´ã‰øùÊåÅÂèØÊÑõË™ûÊ∞£ÔºåÁπÅÈ´î‰∏≠Êñá)„Äë
                1. üëó **Á©øÊê≠Âª∫Ë≠∞**: ÈáùÂ∞ç12ÊúàÁöÑÂ§©Ê∞£(ÈÄöÂ∏∏5-10Â∫¶)‰ª•ÂèäÁï∂Â§©Ë°åÁ®ã(‰æãÂ¶ÇÊòØÂê¶ÈúÄË¶ÅËµ∞Ë∑Ø„ÄÅÂéªÊµ∑ÈÇä)ÔºåÁµ¶Âá∫ÂÖ∑È´îÁ©øËëóÂª∫Ë≠∞„ÄÇ
                2. üç± **ÂøÖÂêÉÊé®Ëñ¶**: Êé®Ëñ¶‰∏ÄÂÄãÂ∞±Âú®Áï∂Â§©Ë°åÁ®ãÈôÑËøëÁöÑÁâπËâ≤ÁæéÈ£üÊàñÈ§êÂª≥(ÈùûÈÄ£Èéñ‰Ω≥)„ÄÇ
                3. üáØüáµ **ÊØèÊó•‰∏ÄÂè•**: Êïô‰∏ÄÂè•ÈÅ©ÂêàÁï∂Â§©ÊÉÖÂ¢ÉÁöÑÂØ¶Áî®Êó•ÊñáÁü≠Âè•(ÈôÑÂπ≥ÂÅáÂêçËàáÁôºÈü≥)„ÄÇ
                
                Ë´ãÁõ¥Êé•ÂàóÈªûÂõûÁ≠îÔºå‰∏çË¶ÅÂª¢Ë©±ÔºåÁ∏ΩÂ≠óÊï∏ÊéßÂà∂Âú® 200 Â≠ó‰ª•ÂÖß„ÄÇ
                `;

                try {
                    const result = await callGemini(prompt, apiKey);
                    setDailyBriefings(prev => ({...prev, [idx]: result}));
                } catch (error) {
                    setDialog({ isOpen: true, type: 'alert', message: "ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶ >_<", onConfirm: closeDialog });
                }
                setBriefingLoading(false);
            };

            // Gemini Post Generator Function
            const handleGeneratePost = async (idx) => {
                if(!apiKey) { 
                    setDialog({ 
                        isOpen: true, 
                        type: 'alert', 
                        message: "Ë´ãÂÖàÈªûÊìäÂ∑¶‰∏ãËßí ‚ú® ÊåâÈàïÔºåËº∏ÂÖ• API Key ÊâçËÉΩÂëºÂè´Ê´ªËä±ÈÜ¨ÂñîÔºÅ", 
                        onConfirm: closeDialog 
                    }); 
                    return; 
                }
                
                setPostLoading(true);
                const day = tripData.itinerary[idx];
                
                const prompt = `
                ‰Ω†ÊòØÁ§æÁæ§Â™íÈ´îÈÅî‰∫∫Ê´ªËä±ÈÜ¨„ÄÇË´ãÊ†πÊìö‰ª•‰∏ãË°åÁ®ãÔºåÂØ´‰∏ÄÁØáÂê∏Âºï‰∫∫ÁöÑ Instagram Ë≤ºÊñá„ÄÇ
                
                „ÄêË°åÁ®ãË≥áË®ä„Äë
                - Êó•Êúü: 12Êúà${day.date} (${day.day})
                - Ê®ôÈ°å: ${day.title}
                - ÊôØÈªû: ${day.activities.map(a => a.content).join(', ')}
                
                „ÄêË¶ÅÊ±Ç„Äë
                1. Ë™ûÊ∞£ÔºöË∂ÖËààÂ•Æ„ÄÅÊ¥ªÊΩë„ÄÅÂÖÖÊªø Emoji üå∏‚ú®üíñ„ÄÇ
                2. ÂÖßÂÆπÔºöÂåÖÂê´ÈÄôÂ§©ÁöÑ‰∫ÆÈªû‰ªãÁ¥πÔºåÂÉèÊòØÂú®ÂØ´Êó•Ë®òÂàÜ‰∫´Áµ¶ÊúãÂèã„ÄÇ
                3. ÁµêÂ∞æÔºöÂä†‰∏ä 5-8 ÂÄãÁÜ±ÈñÄÁöÑÊó•Êú¨ÊóÖÈÅä Hashtag„ÄÇ
                4. Â≠óÊï∏ÔºöÁ¥Ñ 150 Â≠óÂ∑¶Âè≥„ÄÇ
                `;

                try {
                    const result = await callGemini(prompt, apiKey);
                    setDailyPosts(prev => ({...prev, [idx]: result}));
                } catch (error) {
                    setDialog({ isOpen: true, type: 'alert', message: "ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶ >_<", onConfirm: closeDialog });
                }
                setPostLoading(false);
            };

            // Gemini Translation Function
            const handleTranslate = async () => {
                if(!apiKey) { 
                    setDialog({ 
                        isOpen: true, 
                        type: 'alert', 
                        message: "Ë´ãÂÖàÈªûÊìäÂ∑¶‰∏ãËßí ‚ú® ÊåâÈàïÔºåËº∏ÂÖ• API Key ÊâçËÉΩ‰ΩøÁî®ÁøªË≠ØÂäüËÉΩÂñîÔºÅ", 
                        onConfirm: closeDialog 
                    }); 
                    return; 
                }
                if(!translationInput.trim()) return;

                setIsTranslating(true);
                setTranslationResult(null);

                const prompt = `
                ‰Ω†ÊòØÂ∞àÊ•≠ÁöÑ‰∏≠Êó•ÁøªË≠ØÂÆò„ÄÇ
                
                „Äê‰ªªÂãô„Äë
                Â∞á‰ΩøÁî®ËÄÖÁöÑ‰∏≠ÊñáÂè•Â≠êÁøªË≠ØÊàê**Ëá™ÁÑ∂„ÄÅÊúâÁ¶ÆË≤åÁöÑÊó•Êñá**ÔºàÈÅ©ÂêàÈÅäÂÆ¢Â∞çÂ∫óÂì°ÊàñË∑Ø‰∫∫Ë™™Ôºâ„ÄÇ
                
                „Äê‰ΩøÁî®ËÄÖËº∏ÂÖ•„Äë
                "${translationInput}"
                
                „ÄêËº∏Âá∫Ê†ºÂºè„Äë
                Ë´ã**ÂãôÂøÖ**Âè™ÂõûÂÇ≥‰∏ÄÊÆµÊúâÊïàÁöÑ JSON Â≠ó‰∏≤Ôºå‰∏çË¶ÅÊúâ‰ªª‰Ωï Markdown Ê®ôË®òÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
                {
                  "japanese": "Êó•ÊñáÁøªË≠ØÁµêÊûú (Âê´Êº¢Â≠ó)",
                  "romaji": "ÁæÖÈ¶¨ÊãºÈü≥ (Êñπ‰æø‰ΩøÁî®ËÄÖÂî∏Âá∫‰æÜ)"
                }
                `;

                try {
                    const text = await callGemini(prompt, apiKey);
                    const jsonStr = text.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(jsonStr);
                    setTranslationResult(data);
                } catch (error) {
                    console.error(error);
                    setDialog({ isOpen: true, type: 'alert', message: "ÁøªË≠ØÂ§±ÊïóÔºåË´ãÁ∞°ÂåñÂè•Â≠êÂæåÂÜçË©¶‰∏ÄÊ¨° >_<", onConfirm: closeDialog });
                }
                setIsTranslating(false);
            };

            const handleQuickPhrase = (text) => {
                setTranslationInput(text);
                // Optional: Auto translate after clicking chip? 
                // Let's just set text for now so user confirms intent.
            };

            // Gemini Vision Function (Image Input Handler)
            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // The result contains the data:image/jpeg;base64,... prefix
                        // We need to strip it for the API call, but keep it for display
                        setVisionImage(reader.result);
                        setVisionResult(null); // Reset previous result
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleAnalyzeImage = async () => {
                if(!apiKey) { 
                    setDialog({ isOpen: true, type: 'alert', message: "Ë´ãÂÖàËº∏ÂÖ• API Key ÂñîÔºÅ", onConfirm: closeDialog }); return; 
                }
                if (!visionImage) return;

                setIsVisionAnalyzing(true);
                setVisionResult(null); // Reset

                const base64Data = visionImage.split(',')[1];

                const prompt = `
                ‰Ω†ÊòØÊó•Êú¨ÊóÖÈÅäÂ∞èÂπ´Êâã„ÄÇË´ãÂàÜÊûêÈÄôÂºµÂúñÁâáÔºàÂèØËÉΩÊòØËèúÂñÆ„ÄÅË∑ØÁâå„ÄÅÊàñÂïÜÂìÅÔºâ„ÄÇ
                
                **ÈóúÈçµ‰ªªÂãô**ÔºöË´ã‰ªîÁ¥∞Â∞ãÊâæÂúñÁâá‰∏≠ÊòØÂê¶Êúâ„ÄåÂ∫óÂêç„Äç„ÄÅ„ÄåÂìÅÁâåÂêçÁ®±„ÄçÊàñ„ÄåLogoÊñáÂ≠ó„Äç„ÄÇ

                Ë´ã**ÂãôÂøÖ**Âè™ÂõûÂÇ≥‰∏ÄÊÆµÊúâÊïàÁöÑ JSON Â≠ó‰∏≤Ôºå‰∏çË¶ÅÊúâ‰ªª‰Ωï Markdown Ê®ôË®ò (Â¶Ç \`\`\`json)ÔºåÊ†πÊìöÂúñÁâáÈ°ûÂûãÈÅ∏Êìá‰ª•‰∏ãÊ†ºÂºèÔºö

                1. **Ëã•ÊòØËèúÂñÆ (Menu)**Ôºö
                {
                  "type": "menu",
                  "shop_name": "Ëæ®Ë≠òÂà∞ÁöÑÂ∫óÂêç (Ëã•ÁÑ°ÂâáÂõûÂÇ≥ null)",
                  "items": [
                    { 
                      "original": "Êó•ÊñáËèúÂêç", 
                      "price": "ÂÉπÊ†º (Â¶Ç ¬•1000)", 
                      "translation": "ÁπÅÈ´î‰∏≠ÊñáËèúÂêç", 
                      "desc": "Á∞°ÂñÆ‰ªãÁ¥πÂè£Âë≥ÊàñÈ£üÊùê (ÁπÅÈ´î‰∏≠Êñá)" 
                    }
                  ]
                }

                2. **Ëã•ÊòØÂÖ∂‰ªñ (Other)**Ôºö
                {
                  "type": "general",
                  "shop_name": "Ëæ®Ë≠òÂà∞ÁöÑÂ∫óÂêçÊàñÂìÅÁâå (Ëã•ÁÑ°ÂâáÂõûÂÇ≥ null)",
                  "title": "Ê®ôÈ°åÊàñ‰∏ªË¶ÅÊñáÂ≠ó (Êó•Êñá)",
                  "translation": "ÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø",
                  "desc": "Ë™™ÊòéÁî®ÈÄîÊàñÊ≥®ÊÑè‰∫ãÈ†Ö (ÁπÅÈ´î‰∏≠Êñá)"
                }
                `;

                try {
                    const text = await callGemini(prompt, apiKey, base64Data);
                    // Parse JSON
                    let data = text;
                    try {
                        const jsonStr = text.replace(/```json|```/g, '').trim();
                        data = JSON.parse(jsonStr);
                    } catch(e) {
                        // Fallback to text if parsing fails
                        console.warn("JSON parsing failed", e);
                    }
                    setVisionResult(data);
                } catch (error) {
                    setDialog({ isOpen: true, type: 'alert', message: "ÂúñÁâáÂàÜÊûêÂ§±Êïó >_<", onConfirm: closeDialog });
                }
                setIsVisionAnalyzing(false);
            };

            // Gemini Souvenir Suggestion Function
            const handleSuggestSouvenir = async () => {
                if(!apiKey) { 
                    setDialog({ isOpen: true, type: 'alert', message: "Ë´ãÂÖàËº∏ÂÖ• API Key ÂñîÔºÅ", onConfirm: closeDialog }); return; 
                }
                if (!souvenirRecipient.trim()) return;

                setIsSuggestingSouvenir(true);
                setSouvenirSuggestion(null);

                const prompt = `
                ‰ΩøÁî®ËÄÖÊÉ≥Ë≤∑Êó•Êú¨ÈóúË•øÔºà‰∫¨ÈÉΩ/Â§ßÈò™ÔºâÁöÑ‰º¥ÊâãÁ¶ÆÈÄÅÁµ¶Ôºö„Äå${souvenirRecipient}„Äç„ÄÇ
                Ë´ãÊé®Ëñ¶ 3 Ê¨æÈÅ©ÂêàÁöÑ‰º¥ÊâãÁ¶ÆÔºàÈúÄÂÖ∑È´îÂìÅÁâåÊàñÂêçÁ®±Ôºâ„ÄÇ

                ÈáçË¶ÅÊåáÁ§∫Ôºö
                1. Ë´ãÂàÜÊûê„Äå${souvenirRecipient}„ÄçÈÄôÂÄãËº∏ÂÖ•„ÄÇÂ¶ÇÊûú‰ΩøÁî®ËÄÖÊèêÂà∞„ÄåËó•Â¶ù„Äç„ÄÅ„ÄåÂåñÂ¶ùÂìÅ„Äç„ÄÅ„ÄåÁæéÂ¶ù„ÄçÔºåË´ãÂãôÂøÖÊé®Ëñ¶Êó•Êú¨Ëó•Â¶ùÂ∫óÁöÑÁÜ±ÈñÄÂïÜÂìÅÔºàÂ¶ÇÈù¢ËÜú„ÄÅÁúºËó•Ê∞¥„ÄÅ‰øùÈ§äÂìÅÔºâÔºå‰∏çË¶ÅÊé®Ëñ¶È£üÁâ©„ÄÇ
                2. Â¶ÇÊûú‰ΩøÁî®ËÄÖÊèêÂà∞„ÄåÈï∑Ëº©„Äç„ÄÅ„ÄåÂ∞èÂ≠©„ÄçÊàñ„ÄåÊÑõÂêÉÁîúÈ£ü„ÄçÔºåÂâáÊé®Ëñ¶Áõ∏ÊáâÁöÑÈ£üÂìÅÊàñÁî®ÂìÅ„ÄÇ
                3. Ëã•ÁÑ°ÁâπÂà•ÊåáÂÆöÈ°ûÂûãÔºåÂâáÊé®Ëñ¶ÂÖ∑‰ª£Ë°®ÊÄßÁöÑÈóúË•øÂêçÁî¢„ÄÇ
                
                „ÄêËº∏Âá∫Ê†ºÂºè„Äë
                Ë´ã**ÂãôÂøÖ**Âè™ÂõûÂÇ≥‰∏ÄÊÆµÊúâÊïàÁöÑ JSON Èô£ÂàóÔºå‰∏çË¶ÅÊúâ Markdown Ê®ôË®ò (Â¶Ç \`\`\`json)ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
                [
                  {
                    "name": "ÂïÜÂìÅÂêçÁ®±",
                    "price": "ÂèÉËÄÉÂÉπÊ†º",
                    "score": 4.8,
                    "desc": "ÁâπËâ≤Á∞°‰ªã (30Â≠óÂÖß)",
                    "tags": ["Ê®ôÁ±§1", "Ê®ôÁ±§2"],
                    "emoji": "üíÑ", // ‰ª£Ë°®Ë©≤È†ÖÁõÆÁöÑ Emoji (Ë´ãÊ†πÊìöÂïÜÂìÅÈ°ûÂûãÈÅ∏ÊìáÔºåÂ¶ÇËó•Â¶ùÁî®üíÑ/üíäÔºåÈ£üÁâ©Áî®üçò/üçµ)
                    "reason": "ÈáùÂ∞ç„Äå${souvenirRecipient}„ÄçÁöÑÊé®Ëñ¶ÁêÜÁî±"
                  }
                ]
                `;

                try {
                    const text = await callGemini(prompt, apiKey);
                    // Clean up JSON string more aggressively
                    let jsonStr = text.trim();
                    // Remove markdown code blocks if present
                    if (jsonStr.startsWith('```')) {
                        jsonStr = jsonStr.replace(/```json|```/g, '').replace(/```/g, '');
                    }
                    // Find the first [ and last ]
                    const start = jsonStr.indexOf('[');
                    const end = jsonStr.lastIndexOf(']');
                    if (start !== -1 && end !== -1) {
                        jsonStr = jsonStr.substring(start, end + 1);
                        const data = JSON.parse(jsonStr);
                        setSouvenirSuggestion(data);
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (error) {
                    console.error(error);
                    setDialog({ isOpen: true, type: 'alert', message: "ÈÄ£Á∑öÂ§±ÊïóÊàñÊ†ºÂºèÈåØË™§ >_<", onConfirm: closeDialog });
                }
                setIsSuggestingSouvenir(false);
            };

            // Gemini Budget Analysis Function
            const handleAnalyzeBudget = async () => {
                if(!apiKey) { 
                    setDialog({ 
                        isOpen: true, 
                        type: 'alert', 
                        message: "Ë´ãÂÖàÈªûÊìäÂ∑¶‰∏ãËßí ‚ú® ÊåâÈàïÔºåËº∏ÂÖ• API Key ÊâçËÉΩÂïüÂãï AI È†êÁÆóÁÆ°ÂÆ∂ÂñîÔºÅ", 
                        onConfirm: closeDialog 
                    }); 
                    return; 
                }

                setAnalyzingBudget(true);
                const budgetPrompt = `
                ‰Ω†ÊòØÂ∞àÊ•≠ÁöÑÊó•Êú¨ÊóÖÈÅäÁ≤æÁÆóÂ∏´„ÄåÊ´ªËä±ÈÜ¨„Äç„ÄÇ
                Ë´ãÊ†πÊìö‰ª•‰∏ãË°åÁ®ãÔºåÁÇ∫‰ΩøÁî®ËÄÖ‰º∞ÁÆó„Äå‰∏çÂê´Ê©üÁ•®‰ΩèÂÆø„ÄçÁöÑ**Áï∂Âú∞ÊµÆÂãïÈ†êÁÆó** (1‰∫∫‰ªΩ)„ÄÇ

                „ÄêË°åÁ®ãË≥áË®ä„Äë
                ${JSON.stringify(tripData.itinerary.map(d => ({day: d.day, title: d.title, activities: d.activities.map(a=>a.content)})))}

                „Äê‰ªªÂãô„Äë
                Ë´ã‰º∞ÁÆóÊØè‰∫∫ÊâÄÈúÄÁöÑÊó•Âπ£ÁèæÈáë (JPY)ÔºåÂåÖÂê´È§êÈ£≤„ÄÅ‰∫§ÈÄö„ÄÅÈñÄÁ•®ÈõúÊîØ„ÄÅË≥ºÁâ©„ÄÇ

                „ÄêËº∏Âá∫Ê†ºÂºè„Äë
                Ë´ã**ÂãôÂøÖ**Âè™ÂõûÂÇ≥‰∏ÄÊÆµÊúâÊïàÁöÑ JSON Â≠ó‰∏≤Ôºå‰∏çË¶ÅÊúâ‰ªª‰Ωï Markdown Ê®ôË®ò (Â¶Ç \`\`\`json)ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
                {
                  "total_jpy": Êï∏Â≠ó (Âª∫Ë≠∞ÊîúÂ∏∂Á∏ΩÁèæÈáë, ‰æã: 80000),
                  "total_twd": Êï∏Â≠ó (ÊèõÁÆóÂè∞Âπ£ÔºåÂåØÁéá0.215),
                  "items": [
                    {
                      "category": "È°ûÂà•ÂêçÁ®± (Â¶Ç: È§êÈ£≤Ë≤ª)",
                      "icon": "üç±",
                      "min": Êï∏Â≠ó (‰ΩéÊ®ô),
                      "max": Êï∏Â≠ó (È´òÊ®ô),
                      "desc": "Á∞°Áü≠Ë™™Êòé (Â¶Ç: ÊØèÊó•Á¥Ñ¬•5000ÔºåÂê´USJËºÉË≤¥È§êÈ£≤)"
                    },
                    {
                      "category": "Áï∂Âú∞‰∫§ÈÄö",
                      "icon": "üöÉ",
                      "min": Êï∏Â≠ó,
                      "max": Êï∏Â≠ó,
                      "desc": "Á∞°Áü≠Ë™™Êòé"
                    },
                    {
                      "category": "ÈñÄÁ•®ÈõúÊîØ",
                      "icon": "üéüÔ∏è",
                      "min": Êï∏Â≠ó,
                      "max": Êï∏Â≠ó,
                      "desc": "Á∞°Áü≠Ë™™Êòé"
                    },
                    {
                      "category": "Ë≥ºÁâ©È†êÂÇô",
                      "icon": "üõçÔ∏è",
                      "min": Êï∏Â≠ó,
                      "max": Êï∏Â≠ó,
                      "desc": "Á∞°Áü≠Ë™™Êòé"
                    }
                  ],
                  "advice": "‰∏ÄÊÆµÁ∞°Áü≠ÁöÑÁ∏ΩÁµêÂª∫Ë≠∞ (100Â≠óÂÖßÔºåÂèØÊÑõË™ûÊ∞£)"
                }
                `;

                try {
                    const text = await callGemini(budgetPrompt, apiKey);
                    const jsonStr = text.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(jsonStr);
                    setBudgetAnalysis(data);
                    try { localStorage.setItem('budget_analysis_v2', JSON.stringify(data)); } catch (e) {}
                } catch (error) {
                    console.error(error);
                    setDialog({ isOpen: true, type: 'alert', message: "ÈÄ£Á∑öÂ§±ÊïóÊàñÊ†ºÂºèÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶ >_<", onConfirm: closeDialog });
                }
                setAnalyzingBudget(false);
            };

            return (
                <div 
                    className="h-[100dvh] bg-[#fffafc] font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100 flex flex-col"
                    style={{ 
                        paddingTop: 'env(safe-area-inset-top)', 
                        paddingBottom: 'env(safe-area-inset-bottom)' 
                    }}
                >
                    <NintendoSakuraBackground />
                    <SakuraRain />
                    
                    {showSplash && <SplashScreen />}
                    
                    {/* Dialog Component Instance */}
                    <Dialog 
                        isOpen={dialog.isOpen} 
                        type={dialog.type} 
                        message={dialog.message} 
                        onConfirm={dialog.onConfirm} 
                        onCancel={closeDialog} 
                    />

                    {/* Header */}
                    <header className="bg-pink-100/90 backdrop-blur-md p-2 sticky top-0 z-50 border-b-2 border-pink-200 border-dashed shadow-sm flex-shrink-0">
                        <div className="flex justify-between items-center mb-2">
                            <div>
                                <h1 className="text-lg font-creative text-3d flex items-center gap-2 tracking-widest transform -rotate-1">
                                    <Icons.PlaneReal size={20} className="text-pink-500 fill-white" /> <span>Â§ßÈò™‰∫¨ÈÉΩ‰∏â‰∫∫ÈÅä</span>
                                </h1>
                                <p className="text-[10px] text-gray-500 mt-0.5 font-bold ml-1">2025.12.15 - 12.24 (10Â§©)</p>
                            </div>
                            <div className="flex gap-2">
                                {isIos && (
                                    <Button3D onClick={() => setShowInstallModal(true)} color="white" className="w-8 h-8 p-0 text-blue-500 animate-pulse">
                                        <Icons.Download size={16} />
                                    </Button3D>
                                )}
                                <Button3D onClick={clearAllData} color="white" className="w-8 h-8 p-0 text-red-400"><Icons.Trash2 size={16} /></Button3D>
                                <Button3D onClick={() => setIsMenuOpen(!isMenuOpen)} color="white" className="w-8 h-8 p-0">{isMenuOpen ? <Icons.X size={16} /> : <Icons.Menu size={16} />}</Button3D>
                            </div>
                        </div>
                        
                        <div className="flex space-x-1 overflow-x-auto pb-2 no-scrollbar justify-between">
                            {[{ id: 'itinerary', label: 'Ë°åÁ®ã', icon: Icons.Calendar }, { id: 'info', label: 'Ë≥áË®ä', icon: Icons.Hotel }, { id: 'weather', label: 'Â§©Ê∞£', icon: Icons.CloudSun }, { id: 'transport', label: '‰∫§ÈÄö', icon: Icons.MapPin }, { id: 'budget', label: 'È†êÁÆó', icon: Icons.Wallet }, { id: 'communicate', label: 'Ê∫ùÈÄö', icon: Icons.MessageCircle }].map((tab) => (
                                <Button3D key={tab.id} onClick={() => setActiveTab(tab.id)} isActive={activeTab === tab.id} color={activeTab === tab.id ? "pink" : "white"} className="flex-1 py-1 px-1 text-[10px]">
                                    <span className="flex flex-row items-center justify-center gap-1"><tab.icon size={14} />{tab.label}</span>
                                </Button3D>
                            ))}
                        </div>
                    </header>

                    {/* Main Content */}
                    <main ref={mainContentRef} className="flex-1 p-3 space-y-3 relative z-10 overflow-y-auto no-scrollbar pb-24">
                        {activeTab === 'itinerary' && (
                            <div className="space-y-4 animate-fadeIn h-full flex flex-col">
                                <div ref={dayMenuRef} className="flex-shrink-0 p-1 bg-white/40 backdrop-blur-md border-2 border-pink-100/50 rounded-3xl shadow-sm mb-2 overflow-x-auto whitespace-nowrap no-scrollbar">
                                    {tripData.itinerary.map((day, idx) => (
                                        <button key={idx} onClick={() => setSelectedDayIndex(idx)} className={`inline-block mx-1 px-3 py-1 rounded-2xl text-[10px] font-bold transition-all duration-200 ${selectedDayIndex === idx ? 'bg-pink-400 text-white shadow-md transform scale-105' : 'bg-gray-50/50 text-gray-500 hover:bg-pink-50/50 border border-gray-100/50'}`}><div className="flex flex-col items-center"><span>Day {idx + 1}</span><span className="font-normal opacity-80">{day.shortDate}</span></div></button>
                                    ))}
                                </div>
                                <div className="flex-grow">
                                    {(() => {
                                        const day = tripData.itinerary[selectedDayIndex];
                                        return (
                                            <LaceCard color={day.color} icon={day.icon} className="animate-fadeIn">
                                                <div className="p-6 relative z-10">
                                                    <div className="flex items-start justify-between border-b-2 border-dashed border-gray-100 pb-4 mb-4">
                                                        <div><div className="flex items-baseline gap-2 mb-1"><h2 className="text-2xl font-bold text-gray-800">Day {selectedDayIndex + 1}</h2><span className="text-sm text-gray-500 bg-white/60 border border-gray-200/60 px-2 py-0.5 rounded-lg shadow-sm">{day.day}</span></div><div className="text-sm font-bold text-pink-500">{day.title}</div></div>
                                                    </div>
                                                    {day.note && <div className="mb-6 bg-yellow-50/60 border-l-4 border-yellow-300 p-3 text-xs text-gray-600 rounded-r-lg flex gap-2 items-start shadow-sm backdrop-blur-sm"><Icons.Info size={14} className="shrink-0 mt-0.5 text-yellow-500"/> <span className="leading-relaxed">{day.note}</span></div>}
                                                    
                                                    <div className="space-y-6 relative before:absolute before:left-3.5 before:top-2 before:bottom-2 before:w-0.5 before:bg-gray-200/60">
                                                        {day.activities.map((act, i) => {
                                                            const isDone = completedActivities[`${selectedDayIndex}-${i}`];
                                                            return (
                                                                <div key={i} className="flex gap-4 relative pl-9 group cursor-pointer" onClick={() => toggleActivity(selectedDayIndex, i)}>
                                                                    <div className={`absolute left-0 top-1 w-7 h-7 rounded-full z-10 flex items-center justify-center shadow-sm transition-all duration-300 ${isDone ? 'bg-green-500 border-green-500' : 'bg-white/80 border-2 border-pink-200'}`}>
                                                                        {isDone ? <Icons.Check size={16} className="text-white"/> : <div className="text-gray-400 transform scale-75">{act.icon}</div>}
                                                                    </div>
                                                                    <div className={`transition-opacity duration-300 ${isDone ? 'opacity-50' : 'opacity-100'}`}>
                                                                        <div className={`font-bold text-sm inline-block px-2 py-0.5 rounded-md mb-1 border ${isDone ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-pink-50/50 text-gray-700 border-pink-100/50'}`}>{act.time}</div>
                                                                        <div className={`text-sm leading-relaxed ${isDone ? 'text-gray-400 line-through' : 'text-gray-600'}`}>{act.content}</div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>

                                                    <div className="mt-8 pt-4 relative">
                                                        <div className="absolute top-0 left-[-24px] right-[-24px] h-3 bg-pink-100 opacity-30 transform -rotate-1"></div>
                                                        {day.details && <div className="space-y-3 mt-4"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1"><Icons.Bus size={12}/> ‰∫§ÈÄö & ÂÇôË®ª</h4>{day.details.map((detail, dIdx) => (<div key={dIdx} className="bg-white/30 p-3 rounded-xl text-sm text-gray-600 border border-gray-100/60 flex gap-2 items-start backdrop-blur-sm"><span className="text-pink-400 mt-1">‚Ä¢</span><span className="leading-relaxed">{detail.text}</span></div>))}</div>}
                                                        
                                                        {/* Daily Briefing Section */}
                                                        <div className="mt-6 mb-4">
                                                            {dailyBriefings[selectedDayIndex] ? (
                                                                <div className="bg-gradient-to-r from-pink-50 to-white p-4 rounded-xl border border-pink-200 text-sm text-gray-700 animate-fadeIn shadow-sm relative overflow-hidden">
                                                                    <div className="absolute top-0 right-0 p-1 opacity-10"><Icons.Sparkles size={60} /></div>
                                                                    <h4 className="font-bold text-pink-500 mb-2 flex items-center gap-2 relative z-10"><Icons.Sparkles size={16} className="animate-spin-slow"/> Ê´ªËä±ÈÜ¨ÁöÑÊØèÊó•ÊîªÁï•</h4>
                                                                    <div className="whitespace-pre-wrap leading-relaxed relative z-10 ai-content text-xs">{dailyBriefings[selectedDayIndex]}</div>
                                                                </div>
                                                            ) : (
                                                                <button 
                                                                    onClick={() => handleGenerateBriefing(selectedDayIndex)} 
                                                                    disabled={briefingLoading}
                                                                    className="w-full bg-gradient-to-r from-pink-400 to-pink-500 text-white p-3 rounded-xl font-bold shadow-md hover:shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 border-b-4 border-pink-600 disabled:opacity-70 disabled:active:scale-100"
                                                                >
                                                                    {briefingLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.Sparkles size={18} className="animate-pulse-fast"/>}
                                                                    {briefingLoading ? 'Ê´ªËä±ÈÜ¨ÊÄùËÄÉ‰∏≠...' : 'ÁîüÊàêÊú¨Êó•Â∞àÂ±¨ÊîªÁï• (Á©øÊê≠/ÁæéÈ£ü)'}
                                                                </button>
                                                            )}
                                                        </div>

                                                        {/* Social Post Generator Section */}
                                                        <div className="mb-4">
                                                            {dailyPosts[selectedDayIndex] ? (
                                                                <div className="bg-gradient-to-r from-purple-50 to-white p-4 rounded-xl border border-purple-200 text-sm text-gray-700 animate-fadeIn shadow-sm relative overflow-hidden">
                                                                    <div className="flex justify-between items-center mb-2 relative z-10">
                                                                        <h4 className="font-bold text-purple-500 flex items-center gap-2"><Icons.PenTool size={16}/> Êú¨Êó•ÊâìÂç°ÊñáÊ°à</h4>
                                                                        <CopyButton text={dailyPosts[selectedDayIndex]} />
                                                                    </div>
                                                                    <div className="whitespace-pre-wrap leading-relaxed relative z-10 text-xs italic">{dailyPosts[selectedDayIndex]}</div>
                                                                </div>
                                                            ) : (
                                                                <button 
                                                                    onClick={() => handleGeneratePost(selectedDayIndex)} 
                                                                    disabled={postLoading}
                                                                    className="w-full bg-gradient-to-r from-purple-400 to-purple-500 text-white p-3 rounded-xl font-bold shadow-md hover:shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 border-b-4 border-purple-600 disabled:opacity-70 disabled:active:scale-100"
                                                                >
                                                                    {postLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.Camera size={18}/>}
                                                                    {postLoading ? 'ÊñáÊ°àÊí∞ÂØ´‰∏≠...' : 'ÁîüÊàêÁ§æÁæ§ÊâìÂç°Ë≤ºÊñá (IG/FB)'}
                                                                </button>
                                                            )}
                                                        </div>

                                                        {day.spots && day.spots.length > 0 && <div className="space-y-3 mt-6"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1"><Icons.Camera size={12}/> ÊôØÈªûÊîªÁï•</h4>{day.spots.map((spot, sIdx) => (<div key={sIdx} className="bg-white/40 border border-blue-100/60 rounded-xl p-4 shadow-sm backdrop-blur-sm"><div className="flex justify-between items-start mb-2 border-b border-dashed border-gray-100/60 pb-2"><h5 className="font-bold text-gray-700 flex items-center gap-1 flex-1"><Icons.MapPin size={14} className="text-blue-400 shrink-0"/> {spot.name} <SpotWeatherBadge city={dayCityMap[selectedDayIndex]} /></h5><div className="flex gap-1 shrink-0 ml-2"><a href={`https://www.youtube.com/results?search_query=${encodeURIComponent(spot.name + " „É©„Ç§„Éñ„Ç´„É°„É©")}&sp=EgJAAQ%253D%253D`} target="_blank" rel="noreferrer" className="text-[10px] bg-red-50/50 text-red-500 border border-red-100/50 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-red-100 transition-colors"><Icons.Video size={10}/> ËßÄÁúã‰∫∫ÊΩÆ</a><a href={spot.mapUrl} target="_blank" rel="noreferrer" className="text-[10px] bg-blue-50/50 text-blue-500 border border-blue-100/50 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-blue-100 transition-colors"><Icons.Navigation size={10}/> Â∞éËà™</a></div></div><div className="text-xs text-gray-600 leading-relaxed mb-2 flex gap-2 items-start"><Icons.Star size={12} className="text-yellow-400 shrink-0 mt-0.5 fill-yellow-400"/><span><span className="font-bold text-gray-700">ÂøÖÂÅöÔºö</span>{spot.highlights.join('„ÄÅ')}</span></div><div className="text-xs text-gray-500 bg-orange-50/50 p-2 rounded-lg flex gap-2 items-start border border-orange-100/50"><Icons.Sparkles size={12} className="text-orange-400 shrink-0 mt-0.5"/><span><span className="font-bold text-orange-500">Tips:</span> {spot.tips}</span></div></div>))}</div>}
                                                    </div>
                                                </div>
                                            </LaceCard>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'info' && (
                            <div className="space-y-6 animate-fadeIn pb-8">
                                <section><div className="flex items-center gap-2 mb-3"><div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-500"><Icons.Plane size={16} /></div><h2 className="text-lg font-bold text-gray-700">Ëà™Áè≠Ë≥áË®ä</h2></div>{tripData.flights.map((flight, idx) => (<LaceCard key={idx} color="blue" className="mb-3" icon={<Icons.Plane className="w-full h-full"/>}><div className="p-4 relative z-10"><div className="flex justify-between mb-2"><span className="bg-blue-100/60 text-blue-600 text-xs px-2 py-1 rounded-lg font-bold">{flight.type}</span><span className="text-gray-400 text-xs font-mono">{flight.date}</span></div><div className="font-bold text-lg text-gray-800 mb-2">{flight.flight}</div><div className="flex items-center gap-3 text-sm text-gray-600 mb-3 bg-gray-50/50 p-2 rounded-lg border border-gray-100/50"><span className="font-bold">{flight.dep}</span><Icons.ArrowRight size={14} className="text-gray-400" /><span className="font-bold">{flight.arr}</span></div><div className="text-xs text-orange-500 flex gap-1 items-start"><Icons.AlertCircle size={12} className="mt-0.5 shrink-0"/> {flight.note}</div></div></LaceCard>))}</section>
                                <section><div className="flex items-center gap-2 mb-3"><div className="w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-500"><Icons.Hotel size={16} /></div><h2 className="text-lg font-bold text-gray-700">‰ΩèÂÆøË≥áË®ä</h2></div>{tripData.hotels.map((hotel, idx) => (<LaceCard key={idx} color="pink" className="mb-4" icon={<Icons.Hotel className="w-full h-full"/>}><div className="p-5 relative z-10"><div className="flex justify-between items-start mb-2"><span className="font-bold text-pink-500 text-xs border border-pink-200/60 px-2 py-0.5 rounded-full bg-white/60">{hotel.city}</span><div className="text-xs text-gray-400">{hotel.checkIn}</div></div><h3 className="font-bold text-gray-800 text-lg leading-tight mb-1">{hotel.name}</h3><div className="flex items-center gap-1 text-xs text-yellow-500 mb-3"><Icons.Star size={10} fill="currentColor"/> {hotel.rating}</div><div className="bg-gray-50/50 border border-gray-100/60 p-3 rounded-xl text-sm text-gray-600 mb-3"><div className="flex justify-between items-start mb-2"><span className="w-3/4">{hotel.address}</span><CopyButton text={hotel.address} /></div><a href={hotel.mapLink} target="_blank" rel="noreferrer" className="text-blue-500 text-xs flex items-center gap-1 font-bold hover:underline"><Icons.Navigation size={12}/> ÈñãÂïüÂú∞Âúñ</a></div><div className="text-xs text-gray-500 flex gap-2 items-center bg-white/60 p-2 rounded-lg border border-dashed border-gray-200/60"><Icons.Train size={12} className="text-gray-400"/> {hotel.transport}</div></div></LaceCard>))}</section>
                                
                                {/* Souvenir Suggestion Section */}
                                <LaceCard color="orange" icon={<Icons.Gift className="w-full h-full text-orange-200"/>}>
                                    <div className="p-5 relative z-10">
                                        <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3">
                                            <Icons.Gift size={18} className="text-orange-500"/> ‰º¥ÊâãÁ¶ÆÊåëÈÅ∏È°ßÂïè
                                        </h3>
                                        <div className="space-y-3">
                                            <p className="text-xs text-gray-500">ÈÇÑÂú®ÁÖ©ÊÉ±ÈÄÅË™∞‰ªÄÈ∫ºÁ¶ÆÁâ©ÂóéÔºüÂëäË®¥ÊàëÂ∞çË±°ÔºåÊàë‰æÜÂπ´‰Ω†ÊåëÔºÅ</p>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    value={souvenirRecipient} 
                                                    onChange={(e) => setSouvenirRecipient(e.target.value)} 
                                                    placeholder="‰æãÂ¶ÇÔºöÂÖ¨Âè∏Âêå‰∫ã„ÄÅÊÑõÂêÉÁîúÈ£üÁöÑÊúãÂèã" 
                                                    className="flex-1 p-2 rounded-xl border border-gray-200 text-sm focus:outline-none focus:border-orange-400"
                                                />
                                                <button 
                                                    onClick={handleSuggestSouvenir} 
                                                    disabled={isSuggestingSouvenir}
                                                    className="bg-orange-500 text-white px-3 py-2 rounded-xl text-sm font-bold shadow-md disabled:opacity-70"
                                                >
                                                    {isSuggestingSouvenir ? '...' : 'Êé®Ëñ¶'}
                                                </button>
                                            </div>
                                            {souvenirSuggestion && (
                                                <div className="animate-fadeIn space-y-2">
                                                    {Array.isArray(souvenirSuggestion) ? souvenirSuggestion.map((item, i) => (
                                                        <RecommendationCard key={i} name={item.name} price={item.price} score={item.score} desc={item.desc} tags={item.tags} emoji={item.emoji} reason={item.reason} url={`https://www.google.com/maps/search/?api=1&query=${item.name}`} />
                                                    )) : <div className="bg-white/60 p-3 rounded-xl border border-orange-100 text-sm text-gray-600">{JSON.stringify(souvenirSuggestion)}</div>}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </LaceCard>
                            </div>
                        )}

                        {activeTab === 'weather' && (
                            <div className="space-y-4 animate-fadeIn pb-8">
                                <div className="flex justify-center mb-4">
                                    <button onClick={requestLocation} disabled={locLoading} className={`bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 active:scale-95 transition-transform ${locLoading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                        {locLoading ? <span className="animate-pulse">ÂÆö‰Ωç‰∏≠...</span> : <><Icons.MapPin size={16}/> Êõ¥Êñ∞ÊàëÁöÑ‰ΩçÁΩÆ</>}
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="col-span-2"><WeatherCard title="ÁõÆÂâç‰ΩçÁΩÆ" lat={weatherLoc?.lat} lon={weatherLoc?.lon} isCurrent={true} /></div>
                                    <WeatherCard title="Â§ßÈò™" lat={34.6937} lon={135.5023} />
                                    <WeatherCard title="‰∫¨ÈÉΩ" lat={35.0116} lon={135.7681} />
                                    <div className="col-span-2"><WeatherCard title="Êù±‰∫¨" lat={35.6895} lon={139.6917} /></div>
                                </div>
                                <div className="text-center text-[10px] text-gray-400 mt-4">Ë≥áÊñô‰æÜÊ∫êÔºöÊó•Êú¨Ê∞£Ë±°Âª≥ (JMA) via Open-Meteo</div>
                            </div>
                        )}

                        {activeTab === 'transport' && (
                            <div className="space-y-4 animate-fadeIn pb-8">
                                <div className="bg-white/40 backdrop-blur-md border-l-4 border-blue-300 p-4 rounded-xl text-sm text-gray-600 shadow-sm flex gap-3"><Icons.Info size={20} className="shrink-0 text-blue-400"/><p>ÈÄôË£°ÊòØË°åÁ®ã‰∏≠ËºÉË§áÈõúÁöÑ‰∫§ÈÄöÊñπÂºèÊï¥ÁêÜÔºåÂª∫Ë≠∞Âá∫ÁôºÂâçÂÜçÊ¨°Á¢∫Ë™çÊôÇÂàªË°®„ÄÇ</p></div>
                                {tripData.transportGuides.map((guide, idx) => (<LaceCard key={idx} color="green" className="mb-2" icon={<Icons.MapPin className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><Icons.Bus size={18} className="text-green-500" />{guide.title}</h3><ul className="space-y-3 relative before:absolute before:left-2.5 before:top-2 before:bottom-2 before:w-0.5 before:bg-gray-200/60">{guide.steps.map((step, sIdx) => (<li key={sIdx} className="flex gap-3 text-sm text-gray-600 relative pl-1"><div className="bg-white/80 border-2 border-green-200/60 text-green-600 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 font-bold relative z-10 shadow-sm">{sIdx + 1}</div><span className="leading-relaxed">{step}</span></li>))}</ul></div></LaceCard>))}
                                <LaceCard color="orange" icon={<Icons.Train className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><Icons.Navigation size={16}/> ÂØ¶Áî®ÈÄ£Áµê</h3><div className="space-y-2"><a href="https://www.westjr.co.jp/global/tc/timetable/" target="_blank" rel="noreferrer" className="block bg-white/60 text-blue-600 px-4 py-3 rounded-xl text-sm hover:bg-blue-50/50 transition-colors font-bold text-center border border-blue-100/60 shadow-sm">JR Ë•øÊó•Êú¨ÊôÇÂàªË°®</a><a href="https://www.nankai.co.jp/traffic/kix.html" target="_blank" rel="noreferrer" className="block bg-white/60 text-orange-600 px-4 py-3 rounded-xl text-sm hover:bg-orange-50/50 transition-colors font-bold text-center border border-orange-100/60 shadow-sm">ÂçóÊµ∑ÈõªÈêµÁ©∫Ê∏ØÁ∑öË≥áË®ä</a></div></div></LaceCard>
                            </div>
                        )}

                        {activeTab === 'budget' && (
                            <div className="animate-fadeIn space-y-4 pb-8">
                                {/* AI Budget Analysis Section */}
                                <LaceCard color="blue" icon={<Icons.Sparkles className="w-full h-full text-blue-200"/>}>
                                    <div className="p-5 relative z-10">
                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3">
                                            <Icons.Sparkles size={18} className="text-blue-500 animate-pulse-fast"/> AI È†êÁÆóÁÆ°ÂÆ∂ (ÊµÆÂãïÊàêÊú¨)
                                        </h3>
                                        
                                        {budgetAnalysis ? (
                                            <div className="bg-white/60 rounded-xl p-4 text-sm text-gray-700 leading-relaxed border border-blue-100/50 relative overflow-hidden">
                                                <button onClick={() => setBudgetAnalysis(null)} className="absolute top-2 right-2 text-gray-400 hover:text-red-400 z-10"><Icons.Trash2 size={14}/></button>
                                                
                                                <div className="bg-gradient-to-r from-blue-500 to-cyan-400 text-white p-4 rounded-xl shadow-md mb-4 text-center">
                                                    <div className="text-xs opacity-90 mb-1">Âª∫Ë≠∞ÊØè‰∫∫Ê∫ñÂÇôÁèæÈáë</div>
                                                    <div className="text-3xl font-mono font-bold">¬•{budgetAnalysis.total_jpy?.toLocaleString()}</div>
                                                    <div className="text-xs opacity-80 mt-1">Á¥Ñ TWD {budgetAnalysis.total_twd?.toLocaleString()}</div>
                                                </div>

                                                <div className="space-y-4">
                                                    {budgetAnalysis.items?.map((item, idx) => (
                                                        <div key={idx}>
                                                            <div className="flex justify-between items-end mb-1">
                                                                <span className="font-bold text-gray-700 flex items-center gap-1">{item.icon} {item.category}</span>
                                                                <span className="font-mono text-xs text-blue-600 font-bold">¬•{item.min?.toLocaleString()} ~ ¬•{item.max?.toLocaleString()}</span>
                                                            </div>
                                                            <div className="h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
                                                                <div className="h-full bg-blue-400 rounded-full animate-grow-width" style={{ width: `${Math.min(100, (item.max / budgetAnalysis.total_jpy) * 100)}%` }}></div>
                                                            </div>
                                                            <div className="text-[10px] text-gray-500 leading-tight">{item.desc}</div>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-600 flex items-start gap-2">
                                                    <Icons.Info size={14} className="shrink-0 mt-0.5"/>
                                                    <span>{budgetAnalysis.advice}</span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-center py-4">
                                                <p className="text-sm text-gray-500 mb-4">Ê´ªËä±ÈÜ¨ÂèØ‰ª•Âπ´ÊÇ®ÂàÜÊûê 10 Â§©Ë°åÁ®ãÔºå‰º∞ÁÆóÈ§êÈ£≤„ÄÅ‰∫§ÈÄöËàáË≥ºÁâ©ÁöÑÂª∫Ë≠∞ÊîúÂ∏∂ÁèæÈáëÂñîÔºÅ</p>
                                                <button 
                                                    onClick={handleAnalyzeBudget} 
                                                    disabled={analyzingBudget}
                                                    className="w-full bg-gradient-to-r from-blue-400 to-blue-500 text-white p-3 rounded-xl font-bold shadow-md hover:shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                                                >
                                                    {analyzingBudget ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.Wallet size={18}/>}
                                                    {analyzingBudget ? 'Ê≠£Âú®Á≤æÁÆó‰∏≠...' : 'ÈñãÂßã‰º∞ÁÆóÊµÆÂãïÈ†êÁÆó'}
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </LaceCard>

                                <LaceCard color="orange" icon={<Icons.Wallet className="w-full h-full"/>}>
                                    <div className="p-5 relative z-10">
                                        <div className="flex justify-between items-center mb-4 border-b border-dashed border-gray-200/60 pb-2">
                                             <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.Wallet size={18} className="text-orange-500"/> Âç≥ÊôÇÂåØÁéáË®àÁÆó</h3>
                                             <button onClick={fetchRate} disabled={isRateLoading} className="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-orange-200 transition-colors">{isRateLoading ? 'Êõ¥Êñ∞‰∏≠...' : <span className="flex items-center gap-1"><Icons.Sparkles size={10}/> Êõ¥Êñ∞ÂåØÁéá</span>}</button>
                                        </div>
                                        <div className="flex items-center gap-2 mb-4">
                                             <div className="flex-1"><label className="text-xs text-gray-500 block mb-1 font-bold">Êó•Âπ£ (JPY)</label><input type="number" value={jpyAmount} onChange={(e) => setJpyAmount(e.target.value)} className="w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-700 focus:outline-none focus:border-orange-300" placeholder="¬•"/></div>
                                             <div className="pt-5 text-gray-400"><Icons.ArrowRight size={16}/></div>
                                             <div className="flex-1"><label className="text-xs text-gray-500 block mb-1 font-bold">Âè∞Âπ£ (TWD)</label><div className="w-full bg-orange-50 border border-orange-100 rounded-xl px-3 py-2 text-lg font-bold text-orange-600">${jpyAmount ? Math.round(jpyAmount * exchangeRate).toLocaleString() : '0'}</div></div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-gray-50/80 p-2 rounded-lg">
                                            <span className="text-xs text-gray-500 whitespace-nowrap">ÁõÆÂâçÂåØÁéá:</span>
                                            <input type="number" step="0.0001" value={exchangeRate} onChange={(e) => setExchangeRate(parseFloat(e.target.value))} className="w-20 bg-white border border-gray-200 rounded px-1 py-0.5 text-xs text-gray-600 focus:outline-none text-center" />
                                            <span className="text-[10px] text-gray-400 ml-auto">ÂèØÊâãÂãïË™øÊï¥</span>
                                        </div>
                                    </div>
                                </LaceCard>

                                <LaceCard color="green" icon={<Icons.Wallet className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3"><Icons.Wallet size={18} className="text-green-500"/> Âõ∫ÂÆöÊîØÂá∫ (Ê©üÁ•®+‰ΩèÂÆø)</h3><div className="space-y-6"><div><div className="flex justify-between items-center mb-2"><span className="font-bold text-gray-700 flex items-center gap-2"><span className="w-2 h-2 bg-green-400 rounded-full"></span> Danny (ÂñÆ‰∫∫Êàø)</span><span className="text-xl font-bold text-green-600 font-mono">$28,787</span></div><div className="text-xs text-gray-500 flex justify-between bg-white/60 p-3 rounded-xl border border-gray-200/60"><span>Ê©üÁ•®: 6860</span><span>‰∫¨ÈÉΩ: 7647</span><span>Â§ßÈò™: 14280</span></div></div><div className="border-b border-dashed border-gray-200/60"></div><div><div className="flex justify-between items-center mb-2"><span className="font-bold text-gray-700 flex items-center gap-2"><span className="w-2 h-2 bg-green-400 rounded-full"></span> Â®ü + ËìÅ (ÊØè‰∫∫)</span><span className="text-xl font-bold text-green-600 font-mono">$18,828</span></div><div className="text-xs text-gray-500 flex justify-between bg-white/60 p-3 rounded-xl border border-gray-200/60"><span>Ê©üÁ•®: 6860</span><span>‰∫¨ÈÉΩ: 4093</span><span>Â§ßÈò™: 7875</span></div></div></div></div></LaceCard>
                                <div className="bg-white/40 backdrop-blur-md p-4 rounded-2xl text-center border-2 border-gray-100/50 border-dashed text-gray-400 text-sm"><Icons.Info size={14} className="inline mr-1 mb-0.5"/> ‰ª•‰∏äÂÉÖÂê´Ê©üÁ•®Ëàá‰ΩèÂÆøÔºå‰∏çÂê´Áï∂Âú∞‰∫§ÈÄöËàáÈ§êÈ£ü„ÄÇ</div>
                            </div>
                        )}

                        {activeTab === 'communicate' && (
                            <div className="animate-fadeIn space-y-4 pb-8">
                                {/* AI Vision Translator */}
                                <LaceCard color="purple" icon={<Icons.Camera className="w-full h-full text-purple-200"/>}>
                                    <div className="p-5 relative z-10">
                                        <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3">
                                            <Icons.Camera size={18} className="text-purple-500"/> AI ÊãçÁÖßÁøªË≠ØÂÆò
                                        </h3>
                                        <p className="text-xs text-gray-500 mb-4">Êãç‰∏ãËèúÂñÆ„ÄÅË∑ØÁâåÊàñÂïÜÂìÅÔºåËÆì AI Âπ´‰Ω†ÁúãÁúãÊòØ‰ªÄÈ∫ºÔºÅ</p>
                                        
                                        <div className="space-y-3">
                                            <div className="relative">
                                                <input 
                                                    type="file" 
                                                    accept="image/*" 
                                                    // capture="environment" // Removed to allow gallery selection
                                                    onChange={handleImageChange}
                                                    className="hidden" 
                                                    id="vision-input"
                                                />
                                                <label 
                                                    htmlFor="vision-input" 
                                                    className="w-full h-32 border-2 border-dashed border-purple-300 rounded-xl flex flex-col items-center justify-center text-purple-400 cursor-pointer hover:bg-purple-50 transition-colors"
                                                >
                                                    {visionImage ? (
                                                        <img src={visionImage} alt="Preview" className="h-full object-contain rounded-lg" />
                                                    ) : (
                                                        <>
                                                            <Icons.Image size={32} className="mb-2"/>
                                                            <span className="text-xs font-bold">ÈªûÊìäÊãçÁÖß / ‰∏äÂÇ≥ÂúñÁâá</span>
                                                        </>
                                                    )}
                                                </label>
                                            </div>

                                            <button 
                                                onClick={handleAnalyzeImage} 
                                                disabled={!visionImage || isVisionAnalyzing}
                                                className="w-full bg-purple-500 text-white p-3 rounded-xl font-bold shadow-md hover:bg-purple-600 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                                            >
                                                {isVisionAnalyzing ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.Sparkles size={18}/>}
                                                {isVisionAnalyzing ? 'AI ÂàÜÊûê‰∏≠...' : 'ÈñãÂßãÂàÜÊûêÂúñÁâá'}
                                            </button>

                                            {visionResult && (
                                                <div className="bg-white/90 p-4 rounded-2xl border-2 border-purple-200 shadow-lg animate-fadeIn mt-4">
                                                    <div className="flex gap-2 items-start">
                                                        <div className="w-full">
                                                            {typeof visionResult === 'string' ? (
                                                                 <MessageContent text={visionResult} />
                                                            ) : (
                                                                visionResult.type === 'menu' ? (
                                                                    <div className="space-y-4">
                                                                        <div className="flex flex-col border-b-2 border-purple-100 pb-2 mb-2">
                                                                            {visionResult.shop_name && (
                                                                                <div className="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                                                                    <Icons.MapPin size={10} /> ÂÅµÊ∏¨Âà∞Â∫óÂêçÔºö<span className="font-bold text-purple-600">{visionResult.shop_name}</span>
                                                                                </div>
                                                                            )}
                                                                            <div className="flex items-center gap-2 text-purple-600 font-bold">
                                                                                <Icons.Coffee size={20}/> <span>ËèúÂñÆÁøªË≠ØÁµêÊûú</span>
                                                                            </div>
                                                                        </div>
                                                                        {visionResult.items.map((item, idx) => (
                                                                            <div key={idx} className="border-b border-gray-100 last:border-0 pb-3 mb-3 last:mb-0 last:pb-0">
                                                                                <div className="flex justify-between items-start">
                                                                                    <h5 className="font-bold text-gray-800 text-lg leading-tight">{item.original}</h5>
                                                                                    <div className="flex flex-col items-end gap-1 ml-2">
                                                                                        {item.price && <span className="font-mono text-pink-500 font-bold bg-pink-50 px-2 py-1 rounded-lg text-xs shrink-0">{item.price}</span>}
                                                                                        <a 
                                                                                            href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent((visionResult.shop_name ? visionResult.shop_name + " " : "") + item.original)}`}
                                                                                            target="_blank" 
                                                                                            rel="noreferrer"
                                                                                            className="text-[10px] text-blue-500 flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors shrink-0 border border-blue-100"
                                                                                        >
                                                                                            <Icons.Image size={10} /> ÂØ¶Áâ©ÁÖß
                                                                                        </a>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="text-purple-600 font-bold text-sm mt-1 flex items-center gap-1">
                                                                                    <span className="w-1 h-4 bg-purple-300 rounded-full inline-block"></span>
                                                                                    {item.translation}
                                                                                </div>
                                                                                <p className="text-xs text-gray-500 mt-1 leading-relaxed pl-2">{item.desc}</p>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                     <div className="space-y-2">
                                                                        <div className="flex justify-between items-start">
                                                                            <h4 className="font-bold text-gray-800 text-lg">{visionResult.title}</h4>
                                                                            <a 
                                                                                href={`https://www.google.com/search?tbm=isch&q=${encodeURIComponent((visionResult.shop_name ? visionResult.shop_name + " " : "") + visionResult.title)}`}
                                                                                target="_blank" 
                                                                                rel="noreferrer"
                                                                                className="text-[10px] text-blue-500 flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors shrink-0 ml-2 border border-blue-100"
                                                                            >
                                                                                <Icons.Image size={10} /> ÂØ¶Áâ©ÁÖß
                                                                            </a>
                                                                        </div>
                                                                        {visionResult.shop_name && <div className="text-xs text-gray-400">Â∫óÂêç/ÂìÅÁâå: {visionResult.shop_name}</div>}
                                                                        <div className="bg-purple-50 p-3 rounded-xl text-purple-700 font-bold">
                                                                            {visionResult.translation}
                                                                        </div>
                                                                        <p className="text-sm text-gray-600 leading-relaxed">{visionResult.desc}</p>
                                                                    </div>
                                                                )
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </LaceCard>

                                <LaceCard color="pink" icon={<Icons.MessageCircle className="w-full h-full text-pink-200"/>}>
                                    <div className="p-5 relative z-10">
                                        <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3">
                                            <Icons.MessageCircle size={18} className="text-pink-500"/> AI Èö®Ë∫´ÁøªË≠ØËíüËíª
                                        </h3>
                                        <p className="text-xs text-gray-500 mb-4">Ëº∏ÂÖ•‰∏≠ÊñáÔºåAI ÊúÉÂπ´‰Ω†ÁøªË≠ØÊàêÂ§ßÂ≠óÈ´îÊó•Êñá + ÁæÖÈ¶¨ÊãºÈü≥ÂñîÔºÅ</p>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <input 
                                                    type="text" 
                                                    value={translationInput} 
                                                    onChange={(e) => setTranslationInput(e.target.value)} 
                                                    placeholder="‰æãÂ¶ÇÔºöË´ãÂïèÈÄôÂÄãÂ§öÂ∞ëÈå¢Ôºü / Êàë‰∏çÂêÉÁâõËÇâ" 
                                                    className="w-full p-4 rounded-xl border border-gray-200 focus:outline-none focus:border-pink-400 shadow-sm text-sm"
                                                />
                                                <div className="flex gap-2 mt-2 overflow-x-auto pb-1 no-scrollbar">
                                                    {['Â§öÂ∞ëÈå¢?', 'ÂªÅÊâÄÂú®Âì™?', 'Êàë‰∏çÂêÉËî•', 'ÂèØ‰ª•Âà∑Âç°Âóé?', 'Ë´ãÁµ¶ÊàëÊ∞¥'].map(t => (
                                                        <button key={t} onClick={() => handleQuickPhrase(t)} className="bg-white border border-gray-200 px-3 py-1 rounded-full text-xs text-gray-600 whitespace-nowrap hover:bg-pink-50 active:bg-pink-100 transition-colors">{t}</button>
                                                    ))}
                                                </div>
                                            </div>

                                            <button 
                                                onClick={handleTranslate} 
                                                disabled={isTranslating}
                                                className="w-full bg-pink-500 text-white p-3 rounded-xl font-bold shadow-md hover:bg-pink-600 active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                                            >
                                                {isTranslating ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icons.MessageCircle size={18}/>}
                                                {isTranslating ? 'ÁøªË≠Ø‰∏≠...' : 'ÁøªË≠ØÊàêÊó•Êñá (Áµ¶Â∫óÂì°Áúã)'}
                                            </button>

                                            {translationResult && (
                                                <div className="bg-white border-2 border-pink-200 rounded-2xl p-6 text-center shadow-md animate-fadeIn mt-4">
                                                    <div className="text-xs text-gray-400 mb-2 uppercase tracking-widest">Japanese</div>
                                                    <div className="text-3xl font-bold text-gray-800 mb-3 leading-snug break-words">{translationResult.japanese}</div>
                                                    <div className="text-sm text-pink-500 font-mono bg-pink-50 inline-block px-3 py-1 rounded-lg">{translationResult.romaji}</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </LaceCard>
                            </div>
                        )}

                        {!isChatOpen && (
                            <>
                                <Button3D onClick={() => setIsChatOpen(true)} color="pink" className="fixed bottom-6 left-6 w-14 h-14 rounded-full shadow-lg z-40 flex items-center justify-center border-2 border-white safe-margin-bottom"><Icons.Sparkles size={28} /></Button3D>
                                <Button3D onClick={scrollToTop} color="pink" className="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg z-40 flex items-center justify-center border-2 border-white safe-margin-bottom"><Icons.ArrowRight className="transform -rotate-90" size={28} /></Button3D>
                            </>
                        )}
                        {showInstallModal && <IOSInstallGuide onClose={() => setShowInstallModal(false)} />}
                        <ChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} itinerary={tripData} apiKey={apiKey} setApiKey={setApiKey} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TripAssistant />);
    </script>
</body>
</html>