<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¤§é˜ªäº¬éƒ½ä¸‰äººéŠ</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fce7f3">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                        creative: ['"Mochiy Pop One"', 'sans-serif'],
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'spin-slow': 'spin 4s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .text-3d {
            color: #ec4899;
            -webkit-text-stroke: 1.5px white;
            paint-order: stroke fill;
            text-shadow: 2px 2px 0px rgba(255, 200, 220, 0.5);
        }
        /* iOS Safe Area Padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
        .safe-margin-bottom { margin-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        
        @keyframes sakura-fall {
            0% { transform: translateY(-10%) rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(120vh) rotate(360deg) translateX(50px); opacity: 0; }
        }
        @keyframes fadeOut { 
            0% { opacity: 1; } 
            80% { opacity: 1; } 
            100% { opacity: 0; visibility: hidden; } 
        }
    </style>
</head>
<body class="bg-gray-50 select-none">
    <div id="root"></div>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if (root && !root.innerHTML) {
                root.innerHTML = `<div style="padding:20px;text-align:center;color:red;margin-top:50px;"><h3>ç™¼ç”ŸéŒ¯èª¤ :(</h3><p>${message}</p><button onclick="location.reload()" style="margin-top:10px;padding:10px;border:1px solid #ccc;">é‡æ–°æ•´ç†</button></div>`;
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // API Key (é è¨­ç‚ºç©ºï¼Œç”±ä½¿ç”¨è€…è¼¸å…¥)
        const globalApiKey = ""; 

        // --- Custom Dialog Component (Replaces alert/confirm) ---
        const Dialog = ({ isOpen, type, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[6000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn">
                    <div className="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl border-4 border-pink-200 text-center relative">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-2 ${type === 'confirm' ? 'bg-yellow-100 border-yellow-200' : 'bg-pink-100 border-pink-200'}`}>
                            {type === 'confirm' ? 'ğŸ¤”' : 'ğŸ’¡'}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{type === 'confirm' ? 'ç¢ºèªä¸€ä¸‹' : 'å°æé†’'}</h3>
                        <p className="text-gray-600 mb-6 text-sm leading-relaxed">{message}</p>
                        <div className="flex gap-3 justify-center">
                            {type === 'confirm' && (
                                <button onClick={onCancel} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                            )}
                            <button onClick={onConfirm} className="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold hover:bg-pink-600 shadow-lg transition-colors">
                                {type === 'confirm' ? 'ç¢ºèª' : 'çŸ¥é“äº†'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Plane: (props) => <IconBase {...props}><path d="M2 22h20"/><path d="M13 2L2 22h20L13 2z"/><path d="M13 2v20"/></IconBase>,
            PlaneReal: (props) => <IconBase {...props}><path d="M20.38 3.62a2 2 0 0 0-1.97-.41L2.5 10.5 9 13l9-9-5.5 13.5 6.5 2.5.41-15.91a2 2 0 0 0-.41-1.97z"/></IconBase>,
            Hotel: (props) => <IconBase {...props}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconBase>,
            MapPin: (props) => <IconBase {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Calendar: (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>,
            Coffee: (props) => <IconBase {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></IconBase>,
            Train: (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><path d="M2 8h20"/></IconBase>,
            Wallet: (props) => <IconBase {...props}><path d="M20 7h-3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h3"/><path d="M4 22h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-3a4 4 0 0 0-4 4 4 4 0 0 0 4 4h3v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1"/></IconBase>,
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            Check: (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Copy: (props) => <IconBase {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></IconBase>,
            Menu: (props) => <IconBase {...props}><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></IconBase>,
            X: (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            ArrowRight: (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>,
            Sun: (props) => <IconBase {...props}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>,
            Star: (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
            Heart: (props) => <IconBase {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></IconBase>,
            Camera: (props) => <IconBase {...props}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></IconBase>,
            Navigation: (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>,
            Bus: (props) => <IconBase {...props}><rect x="3" y="6" width="18" height="14" rx="2"/><path d="M5 22v-5"/><path d="M19 22v-5"/><path d="M3 11h18"/><path d="M10 15h4"/><path d="M7 6v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></IconBase>,
            Sparkles: (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>,
            Send: (props) => <IconBase {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Key: (props) => <IconBase {...props}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>,
            Settings: (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            PenTool: (props) => <IconBase {...props}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>,
            Share: (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" /></IconBase>,
            PlusSquare: (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            ExternalLink: (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></IconBase>,
            CloudSun: (props) => <IconBase {...props}><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></IconBase>,
            CloudRain: (props) => <IconBase {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></IconBase>,
            Droplet: (props) => <IconBase {...props}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconBase>,
            Video: (props) => <IconBase {...props}><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></IconBase>
        };

        // --- SVGs ---
        const MarioSilhouette = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20,50 Q20,20 50,15 Q80,20 85,50 L95,50 L95,60 L10,60 L10,50 Z" fill={color} />
                <circle cx="55" cy="40" r="12" fill="white" opacity="0.5"/>
                <path d="M50,45 L45,35 L50,40 L55,35 L60,45" stroke={color} strokeWidth="3" fill="none" />
                <path d="M30,75 Q45,65 60,75 Q75,65 80,75 Q70,90 55,85 Q45,90 30,75" fill={color} />
            </svg>
        );
        const ZeldaShield = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M15,20 Q15,5 50,5 Q85,5 85,20 V40 Q85,80 50,95 Q15,80 15,40 Z" fill="none" stroke={color} strokeWidth="4" />
                <path d="M25,25 L75,25" stroke={color} strokeWidth="3" />
                <path d="M50,60 L35,40 H65 Z" fill={color} opacity="0.6" />
                <path d="M50,70 L50,85" stroke={color} strokeWidth="3" />
            </svg>
        );
        const PikachuSilhouette = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M10,70 L25,60 L25,50 L40,40" stroke={color} strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                <path d="M35,80 Q30,50 45,45 Q40,20 30,15 L35,10 L50,35 L65,10 L70,15 Q60,20 55,45 Q70,50 65,80 Z" fill={color} />
            </svg>
        );
        const LeafIcon = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M50,90 Q20,80 20,50 Q20,10 50,10 Q80,10 80,50 Q80,80 50,90 Z" fill={color} />
                <circle cx="40" cy="40" r="10" fill="white" opacity="0.4" />
                <path d="M50,10 L50,80" stroke="white" strokeWidth="2" opacity="0.5" />
            </svg>
        );
        const SakuraBranch = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 200 100" className={className}>
                <path d="M0,50 Q50,40 80,60 T150,40 T200,60" stroke={color} strokeWidth="3" fill="none" strokeLinecap="round" />
                <circle cx="60" cy="50" r="5" fill={color} />
                <circle cx="90" cy="60" r="4" fill={color} />
                <circle cx="140" cy="40" r="6" fill={color} />
                <circle cx="180" cy="55" r="5" fill={color} />
                <path d="M55,45 Q60,35 65,45" fill={color} />
                <path d="M135,35 Q140,25 145,35" fill={color} />
            </svg>
        );
        const HexagonPattern = ({ className, color = "#fca5a5" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M25,10 L75,10 L100,50 L75,90 L25,90 L0,50 Z" fill="none" stroke={color} strokeWidth="2" opacity="0.5" />
                <path d="M25,10 L75,10 L100,50 L75,90 L25,90 L0,50 Z" transform="translate(50, 0) scale(0.5)" fill="none" stroke={color} strokeWidth="2" opacity="0.3" />
            </svg>
        );
        const SimpleOnigiri = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M50 15 L15 80 Q50 95 85 80 Z" fill="none" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M35 82 Q50 88 65 82 L65 65 Q50 60 35 65 Z" fill={color} opacity="0.4"/>
                <circle cx="40" cy="55" r="3" fill={color} />
                <circle cx="60" cy="55" r="3" fill={color} />
                <path d="M48 60 Q50 63 52 60" stroke={color} strokeWidth="2" fill="none" strokeLinecap="round"/>
            </svg>
        );
        const SimpleFuji = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 80" className={className}>
                <path d="M50 10 L90 75 H10 Z" fill="none" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M50 10 L65 35 L58 32 L50 40 L42 32 L35 35 Z" fill={color} opacity="0.4" stroke={color} strokeWidth="2" strokeLinejoin="round"/>
            </svg>
        );
        const SimpleDeer = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <circle cx="25" cy="30" r="10" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="75" cy="30" r="10" fill="none" stroke={color} strokeWidth="3"/>
                <ellipse cx="50" cy="55" rx="40" ry="35" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="35" cy="50" r="3" fill={color}/>
                <circle cx="65" cy="50" r="3" fill={color}/>
                <path d="M50 65 L50 70" stroke={color} strokeWidth="3"/>
            </svg>
        );
        const SimpleMatcha = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20 40 Q20 85 50 85 Q80 85 80 40 L20 40 Z" fill={color} opacity="0.3" stroke={color} strokeWidth="3" strokeLinejoin="round"/>
                <path d="M20 40 Q50 50 80 40" stroke={color} strokeWidth="2" fill="none"/>
                <line x1="85" y1="20" x2="85" y2="90" stroke={color} strokeWidth="3"/>
                <circle cx="85" cy="30" r="8" fill="white" stroke={color} strokeWidth="2"/>
                <circle cx="85" cy="46" r="8" fill="white" stroke={color} strokeWidth="2"/>
                <circle cx="85" cy="62" r="8" fill="white" stroke={color} strokeWidth="2"/>
            </svg>
        );
        const SimpleTorii = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <rect x="25" y="20" width="50" height="6" rx="2" fill={color} opacity="0.8"/> 
                <rect x="20" y="30" width="60" height="6" rx="2" fill={color} opacity="0.8"/>
                <rect x="35" y="20" width="6" height="70" fill={color} opacity="0.6"/>
                <rect x="59" y="20" width="6" height="70" fill={color} opacity="0.6"/>
            </svg>
        );
        const SimpleSakura = ({ className, color = "#ffb7c5" }) => (
            <svg viewBox="0 0 50 50" className={className}>
                <path d="M25 25 Q25 5 35 10 Q45 15 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q45 25 40 35 Q35 45 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q25 45 15 40 Q5 35 25 25 Z" fill={color} opacity="0.9"/>
                <path d="M25 25 Q5 25 10 15 Q15 5 25 25 Z" fill={color} opacity="0.9"/>
                <circle cx="25" cy="25" r="3" fill="#fff"/>
            </svg>
        );
        const SimpleDaruma = ({ className, color = "#737373" }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <path d="M20 80 Q10 50 20 20 Q50 5 80 20 Q90 50 80 80 Q50 95 20 80 Z" fill="none" stroke={color} strokeWidth="3"/>
                <circle cx="50" cy="45" r="25" fill="none" stroke={color} strokeWidth="2"/>
                <circle cx="40" cy="48" r="4" fill={color}/>
                <circle cx="60" cy="48" r="4" fill="none" stroke={color} strokeWidth="2"/>
                <path d="M45 55 Q50 60 55 55" stroke={color} strokeWidth="2" fill="none"/>
            </svg>
        );

        const NintendoSakuraBackground = () => (
            <div className="absolute inset-0 z-0 overflow-hidden pointer-events-none select-none bg-gradient-to-b from-pink-100 via-pink-50 to-white">
                <div className="absolute top-0 right-[-50px] w-80 h-40 opacity-30 transform rotate-12"><SakuraBranch className="w-full h-full" color="#fda4af" /></div>
                <div className="absolute top-1/3 left-[-40px] w-64 h-32 opacity-20 transform -rotate-12"><SakuraBranch className="w-full h-full" color="#fda4af" /></div>
                <div className="absolute top-10 left-6 w-16 h-16 opacity-20 transform -rotate-12"><MarioSilhouette className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute top-1/4 right-4 w-14 h-14 opacity-20 transform rotate-6"><ZeldaShield className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute bottom-40 left-8 w-16 h-16 opacity-20"><PikachuSilhouette className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute bottom-10 right-6 w-12 h-12 opacity-20 transform rotate-45"><LeafIcon className="w-full h-full" color="#fb7185" /></div>
                <div className="absolute top-32 left-[-10px] w-20 h-20 opacity-10"><HexagonPattern className="w-full h-full" color="#f43f5e" /></div>
                <div className="absolute bottom-1/3 right-[-10px] w-24 h-24 opacity-10 transform rotate-90"><HexagonPattern className="w-full h-full" color="#f43f5e" /></div>
                <div className="absolute top-20 left-1/2 w-4 h-4 opacity-40"><SimpleSakura className="w-full h-full" color="#fda4af"/></div>
                <div className="absolute bottom-20 right-1/3 w-6 h-6 opacity-30 transform rotate-45"><SimpleSakura className="w-full h-full" color="#fda4af"/></div>
            </div>
        );

        const callGemini = async (prompt, userKey) => {
            const validKey = userKey || globalApiKey;
            const maxRetries = 3;
            const baseDelay = 1000;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (!validKey) throw new Error("NO_API_KEY");
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${validKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }] 
                        }),
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæ«»èŠ±é†¬ç¾åœ¨æœ‰é»æšˆæšˆçš„ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ ğŸ˜µâ€ğŸ’«";
                } catch (error) {
                    if (error.message === "NO_API_KEY") return "è«‹è¨­å®š API Key æ‰èƒ½å‘¼å«æ«»èŠ±é†¬å–”ï¼(åœ¨ç¨‹å¼ç¢¼ä¸Šæ–¹)";
                    if (attempt === maxRetries) return "æ«»èŠ±é†¬ç¾åœ¨é€£ç·šæœ‰é»ä¸ç©©ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ä¸€æ¬¡å–”ï¼";
                    await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, attempt)));
                }
            }
        };

        const MessageContent = ({ text }) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            if (typeof text !== 'string') return <span>{String(text)}</span>;
            const parts = text.split(urlRegex);

            return (
                <span>
                    {parts.map((part, i) => {
                        if (part.match(urlRegex)) {
                            const isMaps = part.includes('google.com/maps');
                            return (
                                <a 
                                    key={i} 
                                    href={part} 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    className={`break-all font-bold hover:underline ${isMaps ? 'text-blue-600' : 'text-blue-500'}`}
                                    onClick={(e) => e.stopPropagation()} 
                                >
                                    {isMaps ? 'ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–' : 'ğŸ”— é€£çµ'}
                                </a>
                            );
                        }
                        return part;
                    })}
                </span>
            );
        };

        // --- Weather Helpers ---
        const fetchWeatherData = async (lat, lon) => {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,apparent_temperature&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=4`);
                if(!res.ok) throw new Error("Weather fetch failed");
                const data = await res.json();
                
                if (!data.current || !data.daily) return null;

                const days = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];

                return {
                    current: {
                        temp: Math.round(data.current.temperature_2m),
                        feelsLike: Math.round(data.current.apparent_temperature),
                        code: data.current.weather_code,
                        rainProb: data.daily.precipitation_probability_max?.[0] || 0
                    },
                    daily: data.daily.time.map((t, i) => {
                        const d = new Date(t);
                        return {
                            date: `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`,
                            code: data.daily.weather_code[i],
                            max: Math.round(data.daily.temperature_2m_max[i]),
                            min: Math.round(data.daily.temperature_2m_min[i]),
                            rain: data.daily.precipitation_probability_max[i]
                        }
                    }).slice(1)
                };
            } catch (e) {
                console.warn("Weather API Error:", e);
                return null;
            }
        };

        const getWeatherIcon = (code, size = 24) => {
            if (code === undefined || code === null) return <div style={{fontSize: size}}>?</div>;
            if (code <= 1) return <Icons.Sun size={size} className="text-orange-400 animate-spin-slow" />;
            if (code <= 3) return <Icons.CloudSun size={size} className="text-gray-400" />;
            if (code <= 48) return <div style={{fontSize: size}} className="text-gray-400">ğŸŒ«ï¸</div>;
            if (code <= 67) return <Icons.CloudRain size={size} className="text-blue-400" />;
            if (code <= 77) return <div style={{fontSize: size}} className="text-blue-200">â„ï¸</div>;
            if (code <= 82) return <Icons.CloudRain size={size} className="text-blue-600" />;
            return <div style={{fontSize: size}} className="text-yellow-600">âš¡</div>;
        };

        const WeatherCard = ({ title, lat, lon, isCurrent = false }) => {
            const [weatherData, setWeatherData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(lat && lon) {
                    setLoading(true);
                    fetchWeatherData(lat, lon)
                        .then(data => {
                            setWeatherData(data);
                            setLoading(false);
                        })
                        .catch(() => {
                            setLoading(false);
                            setWeatherData(null);
                        });
                } else {
                    setLoading(false);
                }
            }, [lat, lon]);

            if (!lat || !lon) return isCurrent ? (
                <div className="bg-white/60 p-4 rounded-2xl border-2 border-dashed border-gray-300 text-center text-gray-400 text-sm">
                    é»æ“Šä¸‹æ–¹å®šä½æŒ‰éˆ•<br/>æŸ¥çœ‹é€™è£¡çš„å¤©æ°£
                </div>
            ) : null;

            if (loading) return <div className="bg-white/60 p-4 rounded-2xl border-2 border-pink-100 h-32 animate-pulse"></div>;
            
            if (!weatherData) return <div className="bg-white/60 p-4 rounded-2xl border-2 border-red-100 text-red-400 text-xs flex items-center justify-center">å¤©æ°£æš«ç„¡æ³•é¡¯ç¤º (N/A)</div>;

            const { current, daily } = weatherData;
            const isRaining = current.rainProb > 40;
            const bgClass = isRaining ? "bg-blue-50/90 border-blue-200" : "bg-orange-50/90 border-orange-200";

            return (
                <div className={`${bgClass} border-2 p-4 rounded-2xl shadow-sm relative overflow-hidden transition-all duration-300 hover:shadow-md`}>
                    <div className="flex justify-between items-start z-10 relative mb-4">
                        <div>
                            <h4 className="font-bold text-gray-700 text-lg flex items-center gap-1">
                                {isCurrent && <Icons.MapPin size={16} className="text-pink-500"/>}
                                {title}
                            </h4>
                            <div className="text-3xl font-mono font-bold text-gray-800 mt-1">{current.temp}Â°</div>
                            <div className="text-xs text-gray-500 mt-1">é«”æ„Ÿ {current.feelsLike}Â°</div>
                        </div>
                        <div className="flex flex-col items-end">
                            <div className="w-12 h-12 flex items-center justify-center bg-white rounded-full shadow-sm mb-2 animate-float">
                                {getWeatherIcon(current.code)}
                            </div>
                            <div className="flex items-center gap-1 text-xs font-bold text-blue-500 bg-white/80 px-2 py-1 rounded-lg">
                                <Icons.Droplet size={10} /> {current.rainProb}%
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between border-t border-gray-200/30 pt-3 relative z-10">
                        {daily.map((day, idx) => (
                            <div key={idx} className="flex flex-col items-center gap-1">
                                <span className="text-[10px] text-gray-500 font-bold whitespace-nowrap">{day.date}</span>
                                {getWeatherIcon(day.code, 16)}
                                <span className="text-[10px] text-gray-700 font-mono">{day.min}Â°-{day.max}Â°</span>
                                <span className="text-[9px] text-blue-400 font-bold">{day.rain}%</span>
                            </div>
                        ))}
                    </div>

                    {isRaining && <div className="absolute inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '10px 10px'}}></div>}
                </div>
            );
        };

        const SpotWeatherBadge = ({ city }) => {
            const coords = {
                'kyoto': { lat: 35.0116, lon: 135.7681 },
                'osaka': { lat: 34.6937, lon: 135.5023 },
                'nara': { lat: 34.6851, lon: 135.8048 },
            };
            const [w, setW] = useState(null);
            
            useEffect(() => {
                const c = coords[city];
                if(c) {
                    fetchWeatherData(c.lat, c.lon)
                        .then(setW)
                        .catch(() => setW(null));
                }
            }, [city]);

            if(!w) return null;

            return (
                <span className="inline-flex items-center gap-1 ml-2 px-1.5 py-0.5 rounded-md bg-gray-100/80 border border-gray-200 text-[10px] text-gray-600 font-mono transform scale-90 origin-left">
                    {getWeatherIcon(w.current.code, 14)}
                    <span>{w.current.temp}Â°</span>
                    <span className="text-blue-500 flex items-center"><Icons.Droplet size={8}/>{w.current.rainProb}%</span>
                </span>
            );
        };

        const ChatModal = ({ isOpen, onClose, itinerary, apiKey, setApiKey }) => {
            const [tempKey, setTempKey] = useState("");
            const [messages, setMessages] = useState([
                { role: "ai", text: "å“ˆå›‰ï¼æˆ‘æ˜¯ä½ å€‘çš„äº¬éƒ½å¤§é˜ªå°å°éŠã€Œæ«»èŠ±é†¬ã€ğŸŒ¸\n\næœ‰ä»€éº¼å•é¡Œéƒ½å¯ä»¥å•æˆ‘ï½ (ä¾‹å¦‚ï¼šæ˜å¤©æ—©é¤åƒä»€éº¼ï¼Ÿæ€éº¼å»ç’°çƒå½±åŸï¼Ÿ)\n\nğŸ“ é»æ“Šä¸‹æ–¹çš„å®šä½æŒ‰éˆ•ï¼Œæˆ‘å¯ä»¥æ¨è–¦é™„è¿‘çš„å•†åº—å–”ï¼" }
            ]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [locationStatus, setLocationStatus] = useState("idle");
            const [userLocation, setUserLocation] = useState(null);
            const messagesEndRef = useRef(null);
            
            // Local dialog state for ChatModal
            const [chatDialog, setChatDialog] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
            const closeChatDialog = () => setChatDialog(prev => ({ ...prev, isOpen: false }));

            useEffect(() => { if (isOpen) messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);

            const handleSaveKey = () => {
                if (!tempKey.trim()) return;
                const key = tempKey.trim();
                setApiKey(key);
                try { localStorage.setItem('gemini_api_key', key); } catch (e) { console.warn("Storage failed", e); }
            };

            const handleClearKey = () => {
                setChatDialog({
                    isOpen: true,
                    type: 'confirm',
                    message: "ç¢ºå®šè¦ç§»é™¤ç›®å‰çš„ API Key å—ï¼Ÿ",
                    onConfirm: () => {
                        setApiKey("");
                        setTempKey("");
                        try { localStorage.removeItem('gemini_api_key'); } catch (e) {}
                        closeChatDialog();
                    }
                });
            };

            const handleGetLocation = () => {
                if (!navigator.geolocation) {
                    setChatDialog({ isOpen: true, type: 'alert', message: "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ >_<", onConfirm: closeChatDialog });
                    return;
                }
                setLocationStatus("loading");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setUserLocation({ lat: latitude, lng: longitude });
                        setLocationStatus("success");
                        setMessages(prev => [...prev, { role: "system", text: `ğŸ“ å·²ç²å–ç›®å‰ä½ç½®ï¼\n(ç·¯åº¦: ${latitude.toFixed(4)}, ç¶“åº¦: ${longitude.toFixed(4)})` }]);
                    },
                    (error) => {
                        console.error(error);
                        setLocationStatus("error");
                        setChatDialog({ isOpen: true, type: 'alert', message: "ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±å­˜å–å®šä½æ¬Šé™ã€‚\néŒ¯èª¤: " + error.message, onConfirm: closeChatDialog });
                    }
                );
            };

            const handleSend = async () => {
                if (!input.trim()) return;
                setMessages(prev => [...prev, { role: "user", text: input }]);
                setInput("");
                setIsLoading(true);

                const cleanItinerary = {
                    itinerary: itinerary.itinerary.map(day => {
                        const { icon, color, ...rest } = day;
                        return { ...rest, activities: rest.activities.map(({ icon, ...act }) => act) };
                    })
                };

                let locationContext = "";
                if (userLocation) {
                    locationContext = `
                    ã€ç›®å‰ä½¿ç”¨è€…ä½ç½®ã€‘
                    ç·¯åº¦: ${userLocation.lat}
                    ç¶“åº¦: ${userLocation.lng}
                    `;
                }

                const systemPrompt = `
                ä½ æ˜¯ä¸€å€‹å°ˆæ¥­ã€æŒ‘æƒ•ä¸”å¯æ„›çš„æ—¥æœ¬æ—…éŠ AI å°éŠã€Œæ«»èŠ±é†¬ã€ã€‚
                
                ã€ä»»å‹™ç›®æ¨™ã€‘
                å”åŠ©ä½¿ç”¨è€…è¦åŠƒäº¬éƒ½å¤§é˜ªè¡Œç¨‹ã€‚
                
                ã€è¡Œç¨‹è³‡æ–™ã€‘
                ${JSON.stringify(cleanItinerary)}

                ${locationContext}

                ã€æ¨è–¦åš´æ ¼è¦ç¯„ã€‘
                1. ğŸ“ **è·é›¢é™åˆ¶**ï¼šè‹¥æœ‰æä¾›ä½ç½®ï¼Œç¯©é¸è·é›¢åº§æ¨™ **800å…¬å°ºå…§**ã€‚
                2. ğŸ”¥ **ç†±åº¦èˆ‡è©•åƒ¹**ï¼š
                   - å¿…é ˆæ¨è–¦ **ç¤¾ç¾¤è¨è«–åº¦é«˜** (IG/Threads ç†±é–€) æˆ– **Google è©•åƒ¹é«˜ (4.0é¡†æ˜Ÿä»¥ä¸Š)** çš„åº—å®¶ã€‚
                   - å„ªå…ˆæ¨è–¦è©•è«–æ•¸å¤š (è¶…é 100 å‰‡) çš„äººæ°£ååº—ã€‚
                3. ğŸ”— **é€£çµæ ¼å¼ (é‡è¦)**ï¼š
                   - æ¯å€‹æ¨è–¦åº—å®¶**å¿…é ˆ**é™„ä¸Š Google Maps é€£çµã€‚
                   - æ ¼å¼ï¼šhttps://www.google.com/maps/search/?api=1&query={åº—å}
                   - è«‹ç›´æ¥è²¼ä¸Šé€£çµç¶²å€ï¼Œä¸è¦ä½¿ç”¨ Markdown Link (ä¸è¦ç”¨ [é€£çµ](url))ï¼Œä»¥ä¾¿ç³»çµ±è‡ªå‹•è½‰æ›ç‚ºè—è‰²æŒ‰éˆ•ã€‚

                ã€ä½¿ç”¨è€…å•é¡Œã€‘
                ${input}

                ã€å›ç­”è¦ç¯„ã€‘
                1. èªæ°£ï¼šæ´»æ½‘å¯æ„›ï¼Œç¹é«”ä¸­æ–‡ã€‚
                2. æ ¼å¼ï¼šæ¨è–¦åº—å®¶è«‹åˆ—å‡ºã€Œåº—åã€ã€ã€Œè·é›¢ã€ã€ã€Œè©•åƒ¹ã€èˆ‡ã€Œé€£çµã€ã€‚
                3. **ç²¾ç°¡ï¼šå›ç­”è«‹æ§åˆ¶åœ¨ 150 å­—å…§ï¼Œä¸è¦ä¸€æ¬¡çµ¦å¤ªå¤šè³‡è¨Šã€‚**
                `;
                
                const aiResponseText = await callGemini(systemPrompt, apiKey);
                setMessages(prev => [...prev, { role: "ai", text: aiResponseText }]);
                setIsLoading(false);
            };

            if (!isOpen) return null;

            if (!apiKey) {
                return (
                    <div className="fixed inset-0 z-[5000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn">
                        <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 border-4 border-pink-200 relative text-center">
                             <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X size={24}/></button>
                             <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border-2 border-pink-200">ğŸ”‘</div>
                             <h3 className="text-xl font-bold text-gray-800 mb-2">å•Ÿå‹• AI æ«»èŠ±é†¬</h3>
                             <p className="text-sm text-gray-500 mb-6">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key</p>
                             <input type="password" value={tempKey} onChange={(e) => setTempKey(e.target.value)} placeholder="API Key (AIza...)" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-pink-300 mb-4 transition-all" />
                             <button onClick={handleSaveKey} disabled={!tempKey} className="w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-600 active:scale-95 transition-transform disabled:opacity-50">ç¢ºèªå•Ÿå‹•</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-[5000] bg-black/50 backdrop-blur-sm flex items-end justify-center sm:items-center p-4 animate-fadeIn pb-safe">
                    <Dialog 
                        isOpen={chatDialog.isOpen} 
                        type={chatDialog.type} 
                        message={chatDialog.message} 
                        onConfirm={chatDialog.onConfirm} 
                        onCancel={closeChatDialog} 
                    />
                    <div className="bg-white w-full max-w-md h-[80dvh] max-h-[85dvh] sm:h-[600px] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden border-4 border-pink-200 relative mb-safe">
                        <div className="bg-pink-100 p-4 flex justify-between items-center border-b border-pink-200 shrink-0 relative z-10">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl shadow-sm border-2 border-pink-300">ğŸ‘©ğŸ»â€ğŸ¦°</div>
                                <div>
                                    <h3 className="font-bold text-pink-600 text-lg">AI æ«»èŠ±é†¬</h3>
                                    <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span><span className="text-xs text-pink-400">ç·šä¸Š</span><button onClick={handleClearKey} className="text-[10px] bg-white/50 px-1.5 py-0.5 rounded border border-pink-200 text-gray-500 hover:text-red-500">é‡è¨­</button></div>
                                </div>
                            </div>
                            <button onClick={onClose} className="w-10 h-10 flex items-center justify-center bg-red-100 rounded-full hover:bg-red-200 text-red-500 border border-red-200"><Icons.X size={22} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#fffafc] overscroll-contain">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] p-4 rounded-2xl leading-relaxed whitespace-pre-wrap shadow-sm text-base ${msg.role === 'user' ? 'bg-pink-400 text-white rounded-tr-none' : 'bg-white border border-pink-100 text-gray-700 rounded-tl-none'}`}>
                                        {msg.role === 'system' ? <span className="text-pink-500 font-bold">{msg.text}</span> : <MessageContent text={msg.text} />}
                                    </div>
                                </div>
                            ))}
                            {isLoading && <div className="flex justify-start"><div className="bg-white border border-pink-100 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1"><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div><div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div></div></div>}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-3 bg-white border-t border-pink-100 flex items-center gap-2 pb-12 sm:pb-3 shrink-0 relative z-10">
                            <button onClick={handleGetLocation} disabled={locationStatus === 'loading'} className={`w-10 h-10 flex items-center justify-center shrink-0 rounded-2xl border transition-colors ${locationStatus === 'success' ? 'bg-green-100 text-green-600 border-green-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>{locationStatus === 'loading' ? <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div> : <Icons.MapPin size={20} />}</button>
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="é™„è¿‘æœ‰ä»€éº¼..." className="flex-1 bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:border-pink-300 min-w-0"/>
                            <button onClick={handleSend} disabled={isLoading} className="bg-pink-500 text-white p-3 w-10 h-10 flex items-center justify-center rounded-2xl hover:bg-pink-600 disabled:opacity-50 shadow-md shrink-0"><Icons.Send size={20} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const LaceCard = ({ children, className, color = "pink", icon }) => {
            const styles = { pink: { border: "border-pink-200/60", bg: "bg-pink-50", text: "text-pink-400", iconColor: "#ec4899" }, blue: { border: "border-blue-200/60", bg: "bg-blue-50", text: "text-blue-400", iconColor: "#3b82f6" }, orange: { border: "border-orange-200/60", bg: "bg-orange-50", text: "text-orange-400", iconColor: "#f97316" }, green: { border: "border-green-200/60", bg: "bg-green-50", text: "text-green-400", iconColor: "#22c55e" } };
            const theme = styles[color];
            return (
                <div className={`relative p-1 rounded-3xl shadow-sm ${className} overflow-hidden`}>
                    <div className={`absolute inset-0 border-2 border-dashed ${theme.border} rounded-3xl pointer-events-none z-40`}></div>
                    <div className={`absolute top-2 left-2 ${theme.text} z-40`}><Icons.Heart size={12} fill="currentColor" className="opacity-50"/></div>
                    <div className={`absolute bottom-2 right-2 ${theme.text} z-40`}><Icons.Heart size={12} fill="currentColor" className="opacity-50"/></div>
                    <div className="relative h-full m-1 z-30">{children}</div>
                    <div className="absolute -right-4 -top-4 w-40 h-40 opacity-[0.25] transform rotate-12 pointer-events-none z-20"><div style={{ color: theme.iconColor }} className="w-full h-full">{icon ? React.cloneElement(icon, { color: theme.iconColor }) : null}</div></div>
                    <div className="absolute inset-1 rounded-2xl bg-white/40 backdrop-blur-md z-10"></div>
                </div>
            );
        };

        const Button3D = ({ children, onClick, isActive, color = "pink", className }) => {
            const styles = { pink: `bg-pink-400 border-pink-600 text-white ${isActive ? 'bg-pink-500 border-pink-700' : ''}`, white: `bg-white/80 border-gray-200/50 text-gray-600 backdrop-blur-sm ${isActive ? 'bg-white border-gray-300' : 'hover:bg-white'}`, blue: `bg-blue-400 border-blue-600 text-white` };
            const activeStyle = isActive ? "border-b-0 translate-y-1 shadow-inner" : "border-b-4 shadow-md active:border-b-0 active:translate-y-1 active:shadow-inner";
            return <button onClick={onClick} className={`${styles[color]} ${activeStyle} ${className} transition-all duration-100 rounded-xl font-bold flex items-center justify-center`}>{children}</button>;
        };

        const IOSInstallGuide = ({ onClose }) => (
            <div className="fixed inset-0 z-[9999] bg-black/70 flex items-center justify-center p-6 backdrop-blur-sm animate-fadeIn">
                <div className="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl relative text-center border-4 border-pink-200">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X size={24}/></button>
                    <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><Icons.Download size={32} className="text-pink-500"/></div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">å®‰è£åˆ° iPhone</h3>
                    <p className="text-sm text-gray-500 mb-6">å°‡æ­¤ç¶²é åŠ å…¥ä¸»ç•«é¢ï¼Œå°±èƒ½åƒ App ä¸€æ¨£å…¨è¢å¹•ä½¿ç”¨å–”ï¼</p>
                    <button onClick={onClose} className="mt-6 w-full bg-pink-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-600 active:scale-95 transition-transform">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        );

        const SplashScreen = () => (
            <div className="fixed inset-0 z-[10000] bg-gradient-to-b from-pink-100 to-white flex flex-col items-center justify-center animate-fadeOut pointer-events-none">
                <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg border-4 border-pink-200 mb-4 animate-bounce"><Icons.PlaneReal size={48} className="text-pink-500" /></div>
                <h1 className="text-2xl font-bold text-pink-600 tracking-wider">å¤§é˜ªäº¬éƒ½è¡Œ</h1>
                <p className="text-sm text-pink-400 mt-2">æ—…ç¨‹æº–å‚™ä¸­...</p>
            </div>
        );

        const SakuraRain = () => {
            const petals = Array.from({ length: 12 }).map((_, i) => ({ id: i, left: Math.random() * 100 + '%', animationDuration: 8 + Math.random() * 10 + 's', animationDelay: Math.random() * 5 + 's', opacity: 0.4 + Math.random() * 0.5, size: 12 + Math.random() * 12 + 'px' }));
            return (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-50">
                    {petals.map((petal) => (<div key={petal.id} className="absolute top-[-20px]" style={{ left: petal.left, width: petal.size, height: petal.size, animation: `sakura-fall ${petal.animationDuration} linear infinite`, animationDelay: petal.animationDelay, opacity: petal.opacity }}><SimpleSakura className="w-full h-full" /></div>))}
                </div>
            );
        };

        const TripAssistant = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [selectedDayIndex, setSelectedDayIndex] = useState(0);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [isIos, setIsIos] = useState(false);
            const [showSplash, setShowSplash] = useState(true);
            const [apiKey, setApiKey] = useState(() => {
                try { return localStorage.getItem('gemini_api_key') || ""; } catch (e) { return ""; }
            });
            
            const dayMenuRef = useRef(null);
            const mainContentRef = useRef(null);

            const [jpyAmount, setJpyAmount] = useState('');
            const [exchangeRate, setExchangeRate] = useState(0.215); 
            const [isRateLoading, setIsRateLoading] = useState(false);
            const [weatherLoc, setWeatherLoc] = useState(null);
            const [locLoading, setLocLoading] = useState(false);
            
            // Dialog state
            const [dialog, setDialog] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null });
            const closeDialog = () => setDialog(prev => ({ ...prev, isOpen: false }));

            const fetchRate = async () => {
                setIsRateLoading(true);
                try {
                     const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                     if(!res.ok) throw new Error('Network response was not ok');
                     const data = await res.json();
                     if(data.rates.TWD) setExchangeRate(data.rates.TWD);
                } catch (error) {
                    console.error("Failed to fetch rate:", error);
                } finally {
                    setIsRateLoading(false);
                }
            };

            const requestLocation = () => {
                if (!navigator.geolocation) {
                    setDialog({ isOpen: true, type: 'alert', message: "ç€è¦½å™¨ä¸æ”¯æ´å®šä½", onConfirm: closeDialog });
                    return;
                }
                setLocLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        setWeatherLoc({ lat: pos.coords.latitude, lon: pos.coords.longitude });
                        setLocLoading(false);
                    },
                    (err) => {
                        console.log(err);
                        setLocLoading(false);
                        setDialog({ isOpen: true, type: 'alert', message: "ç„¡æ³•ç²å–ä½ç½®ï¼šè«‹æª¢æŸ¥å®šä½æ¬Šé™", onConfirm: closeDialog });
                    }
                );
            };

            useEffect(() => { fetchRate(); }, []);
            useEffect(() => { const timer = setTimeout(() => setShowSplash(false), 2000); return () => clearTimeout(timer); }, []);

            const [completedActivities, setCompletedActivities] = useState({});
            const [isDataLoaded, setIsDataLoaded] = useState(false);

            useEffect(() => {
                try {
                    if (typeof window !== 'undefined') {
                        const savedActs = localStorage.getItem('trip_acts_v3');
                        if (savedActs) setCompletedActivities(JSON.parse(savedActs));
                    }
                } catch (e) { console.warn("Load failed", e); }
                setIsDataLoaded(true);
            }, []);

            useEffect(() => {
                if (isDataLoaded) {
                    try { localStorage.setItem('trip_acts_v3', JSON.stringify(completedActivities)); } catch (e) {}
                }
            }, [completedActivities, isDataLoaded]);

            const toggleActivity = (dayIndex, actIndex) => {
                const key = `${dayIndex}-${actIndex}`;
                setCompletedActivities(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const clearAllData = () => {
                setDialog({
                    isOpen: true,
                    type: 'confirm',
                    message: "ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ‰“å‹¾ç´€éŒ„å—ï¼Ÿ",
                    onConfirm: () => {
                        setCompletedActivities({});
                        try { localStorage.removeItem('trip_acts_v3'); } catch(e){}
                        closeDialog();
                    }
                });
            };

            useEffect(() => {
                const checkIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.navigator.standalone === true;
                if (checkIos && !isStandalone) {
                    setIsIos(true);
                    if (!sessionStorage.getItem('installGuideShown')) {
                        setTimeout(() => {
                            setShowInstallModal(true);
                            sessionStorage.setItem('installGuideShown', 'true');
                        }, 1500);
                    }
                }
            }, []);

            useEffect(() => {
                if (dayMenuRef.current) {
                    const selectedBtn = dayMenuRef.current.children[selectedDayIndex];
                    if (selectedBtn) selectedBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, [selectedDayIndex]);

            const dayCityMap = {
                0: 'kyoto', 1: 'kyoto', 2: 'kyoto', 3: 'nara', 4: 'kyoto',
                5: 'kyoto', 6: 'osaka', 7: 'osaka', 8: 'osaka', 9: 'osaka'
            };

            const tripData = {
                flights: [ { type: 'å»ç¨‹', date: '12/15 (ä¸€)', flight: 'æ¨‚æ¡ƒ MM026', dep: 'TPE 13:40 (æ¡ƒæ©Ÿ T1)', arr: 'KIX 17:05 (é—œè¥¿)', note: 'æŠµé”å¾Œé ˜è¡Œæç´„ 18:00ï¼Œæ­ Haruka å¾€äº¬éƒ½' }, { type: 'å›ç¨‹', date: '12/24 (ä¸‰)', flight: 'æ¨‚æ¡ƒ MM025', dep: 'KIX 10:10 (é—œè¥¿ T2)', arr: 'TPE 12:45 (æ¡ƒæ©Ÿ)', note: '08:10 å‰éœ€æŠµé”æ©Ÿå ´' } ],
                hotels: [ { city: 'äº¬éƒ½', name: "Hotel The Mâ€™s Kyoto", rating: '9.0', address: '6,8-1,Higashisanno-cho,Higashikujo,Minami-ku,å—,äº¬éƒ½,æ—¥æœ¬ 601-8004', checkIn: '12/15 - 12/20 (äº”æ™š)', transport: 'äº¬éƒ½å¾Œç«™æ­¥è¡Œ 5-8 åˆ†', priceNote: 'å¨Ÿ+è“: $4093/äºº | Danny: $7647/äºº', mapLink: 'https://www.google.com/maps/search/?api=1&query=Hotel+The+Ms+Kyoto' }, { city: 'å¤§é˜ª', name: "ç›¸éµ FRESA INN å¤§é˜ªé›£æ³¢ç«™å‰", tel: '06-7668-2031', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æµªé€Ÿå€é›£æ³¢ä¸­1-6-5', checkIn: '12/20 - 12/24 (å››æ™š)', transport: 'å—æµ·é›»éµé›£æ³¢ç«™æ—ï¼Œ7è™Ÿå‡ºå£(æ¨“æ¢¯)æˆ–10è™Ÿ/5è™Ÿ(é›»æ¢¯/æ‰¶æ¢¯)', priceNote: 'å¨Ÿ+è“: $7875/äºº | Danny: $14280/äºº', mapLink: 'https://www.google.com/maps/search/?api=1&query=Sotetsu+Fresa+inn+Osaka-Namba' } ],
                itinerary: [
                    { 
                        date: '12/15', shortDate: '12/15', day: 'é€±ä¸€', title: 'æŠµé”äº¬éƒ½', icon: <SimpleFuji className="w-full h-full" />, color: "blue", 
                        activities: [ { time: '17:05', content: 'æŠµé”é—œè¥¿æ©Ÿå ´ (T2)', icon: <Icons.PlaneReal className="w-4 h-4" /> }, { time: '18:16', content: 'æ­ä¹˜ Haruka å¾€äº¬éƒ½', icon: <Icons.Train className="w-4 h-4" /> }, { time: '20:00', content: 'é£¯åº— Check-in', icon: <Icons.Hotel className="w-4 h-4" /> }, { time: 'æ™šé–“', content: 'æœ¬å®¶ç¬¬ä¸€æ—­æ‹‰éºµ', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'Haruka å¾€äº¬éƒ½ç™¼è»Šæ™‚åˆ»ï¼š18:16ã€18:46ã€19:16ã€19:46ã€‚' }, { type: 'food', text: 'è‹¥ç¬¬ä¸€æ—­æ’éšŠéé•·ï¼Œéš”å£çš„ã€Œæ–°ç¦èœé¤¨ã€ä¹Ÿæ˜¯è€å­—è™Ÿé»‘é†¬æ²¹æ‹‰éºµã€‚' } ], 
                        spots: [ 
                            { name: "æœ¬å®¶ç¬¬ä¸€æ—­", mapUrl: "https://www.google.com/maps/search/?api=1&query=Honke+Daiichi-Asahi", highlights: ["ç¶“å…¸é†¬æ²¹è±šéª¨", "æ»¿æ»¿è”¥èŠ±", "ç…é¤ƒ"], tips: "æ’éšŠååº—ï¼Œå»ºè­°é¿é–‹ç”¨é¤å°–å³°ã€‚" },
                            { name: "äº¬éƒ½è»Šç«™", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kyoto+Station", highlights: ["å¤§éšæ¢¯ç‡ˆå…‰ç§€", "äº¬éƒ½å¡”å¤œæ™¯", "æ‹‰éºµå°è·¯"], tips: "å‡ºç«™å¾ŒæŠ¬é ­çœ‹äº¬éƒ½å¡”ï¼Œæ™šä¸Šå¾ˆç¾ã€‚" } 
                        ] 
                    },
                    { 
                        date: '12/16', shortDate: '12/16', day: 'é€±äºŒ', title: 'ç¶“å…¸äº¬éƒ½ï¼šæ¸…æ°´å¯º', icon: <SimpleTorii className="w-full h-full" />, color: "pink", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'æ¸…æ°´å¯ºã€åœ°ä¸»ç¥ç¤¾', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'äºŒå¹´å‚ã€ä¸‰å¹´å‚ã€å…«å‚ç¥ç¤¾', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'å‚æ™š', content: 'ç¥‡åœ’ã€èŠ±è¦‹å°è·¯', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'äº¬éƒ½è»Šç«™æ­ 206 æˆ– 100 è™Ÿå·´å£«ï¼Œåœ¨ã€Œäº”æ¡å‚ã€ä¸‹è»Šæ­¥è¡Œä¸Šå±±ã€‚' } ], 
                        spots: [ 
                            { name: "æ¸…æ°´å¯º", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kiyomizu-dera", highlights: ["æ¸…æ°´èˆå°", "éŸ³ç¾½ç€‘å¸ƒ", "èƒå…§å·¡éŠ"], tips: "éŸ³ç¾½ç€‘å¸ƒä¸‰å€‹åªèƒ½å–ä¸€å€‹ã€‚èƒå…§å·¡éŠå€¼å¾—ä¸€è©¦ã€‚" }, 
                            { name: "äºŒå¹´å‚/ä¸‰å¹´å‚", mapUrl: "https://www.google.com/maps/search/?api=1&query=Sannenzaka", highlights: ["æ˜Ÿå·´å…‹æ¦»æ¦»ç±³åº—", "ä¸ƒå‘³å®¶æœ¬èˆ–"], tips: "å‚³èªªåœ¨ä¸‰å¹´å‚è·Œå€’æœƒå€’æ¥£ä¸‰å¹´ï¼Œèµ°è·¯è«‹å°å¿ƒï¼" },
                            { name: "å…«å‚ç¥ç¤¾", mapUrl: "https://www.google.com/maps/search/?api=1&query=Yasaka+Shrine", highlights: ["èˆæ®¿ç‡ˆç± ", "ç¾å®¹æ°´", "æ±‚æˆ€æ„›é‹"], tips: "é€™è£¡çš„ç¾å®¹æ°´æ“šèªªæ‹åœ¨è‡‰ä¸Šæœƒè®Šç¾å–”ã€‚" },
                            { name: "ç¥‡åœ’/èŠ±è¦‹å°è·¯", mapUrl: "https://www.google.com/maps/search/?api=1&query=Hanamikoji+Street", highlights: ["è—å¦“è¡—å€", "å¤è€ç”ºå®¶", "èŠå¡ç›¸æ©Ÿåº—"], tips: "å‚æ™šæœ‰æ©Ÿæœƒçœ‹åˆ°è—å¦“ï¼Œè«‹å‹¿è§¸æ‘¸æˆ–æœªç¶“åŒæ„è¿‘è·é›¢æ‹ç…§ã€‚" }
                        ] 
                    },
                    { 
                        date: '12/17', shortDate: '12/17', day: 'é€±ä¸‰', title: 'é‡‘é–£å¯ºèˆ‡äºŒæ¢åŸ', icon: <SimpleMatcha className="w-full h-full" />, color: "green", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'é‡‘é–£å¯º (é¹¿è‹‘å¯º)', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'äºŒæ¢åŸ / éŒ¦å¸‚å ´', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'æ™šé–“', content: 'æ²³åŸç”ºé€›è¡—', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'äº¬éƒ½è»Šç«™æ­ 101/111/205 è™Ÿå·´å£«è‡³ã€Œé‡‘é–£å¯ºé“ã€ã€‚' }, { type: 'info', text: 'éŒ¦å¸‚å ´å»ºè­°ä¸‹åˆ 4:30 å‰æŠµé”ã€‚' } ], 
                        spots: [ 
                            { name: "é‡‘é–£å¯º", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kinkakuji", highlights: ["é‡‘è‰²å€’å½±", "é–€ç¥¨(å®ˆè­·ç¬¦)", "é‡‘ç®”æŠ¹èŒ¶å†°æ·‡æ·‹"], tips: "æœ€ä½³æ‹ç…§é»åœ¨å‰›é€²é–€çš„æ± å¡˜å°å²¸ã€‚" },
                            { name: "äºŒæ¢åŸ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nijo+Castle", highlights: ["äºŒä¹‹ä¸¸å¾¡æ®¿", "é¶¯è²åœ°æ¿", "å”é–€"], tips: "èµ°åœ¨å¾¡æ®¿å…§åœ°æ¿æœƒæœ‰åƒé»ƒé¶¯å«çš„è²éŸ³ï¼Œæ˜¯ç”¨ä¾†é˜²åˆºå®¢çš„ã€‚" },
                            { name: "éŒ¦å¸‚å ´", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nishiki+Market", highlights: ["å²åŠªæ¯”èŒ¶å±‹", "è±†ä¹³ç”œç”œåœˆ", "ä¸‰æœ¨é›åµ"], tips: "äº¬éƒ½çš„å»šæˆ¿ï¼Œè«‹å‹¿é‚Šèµ°é‚Šåƒã€‚" },
                            { name: "æ²³åŸç”º", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kawaramachi+Kyoto", highlights: ["ç™¾è²¨å…¬å¸", "è—¥å¦åº—", "è¿ªå£«å°¼å•†åº—"], tips: "æœ€å¥½é€›çš„å€åŸŸï¼Œæ‰€æœ‰ä¼´æ‰‹ç¦®é€™è£¡éƒ½æœ‰ã€‚" }
                        ] 
                    },
                    { 
                        date: '12/18', shortDate: '12/18', day: 'é€±å››', title: 'å¥ˆè‰¯å°é¹¿èˆ‡å®‡æ²»æŠ¹èŒ¶', icon: <SimpleDeer className="w-full h-full" />, color: "orange", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'å¥ˆè‰¯å…¬åœ’ã€æ±å¤§å¯º', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'å®‡æ²»å¹³ç­‰é™¢ã€è¡¨åƒé“', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'æ™šé–“', content: 'äº¬éƒ½æ™šé¤', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'å…¨ç¨‹æ­ä¹˜ JR å¥ˆè‰¯ç·šã€‚' } ], 
                        spots: [ 
                            { name: "å¥ˆè‰¯å…¬åœ’", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nara+Park", highlights: ["é¤µé¹¿åƒä»™è²", "æ±å¤§å¯ºå¤§ä½›", "é‘½å¤§ä½›é¼»å­”"], tips: "é¹¿å¾ˆè°æ˜ä¹Ÿå¾ˆè²ªåƒï¼Œæ²’ä»™è²æ™‚è«‹æ”¤é–‹é›™æ‰‹ç¤ºæ„ã€‚" },
                            { name: "å¹³ç­‰é™¢", mapUrl: "https://www.google.com/maps/search/?api=1&query=Byodoin", highlights: ["é³³å‡°å ‚", "10å…ƒç¡¬å¹£åœ–æ¡ˆ", "ç´«è—¤èŠ±"], tips: "10æ—¥åœ“ç¡¬å¹£èƒŒå¾Œçš„åœ–æ¡ˆå°±æ˜¯é³³å‡°å ‚ã€‚" },
                            { name: "ä¸­æ‘è—¤å‰ (å®‡æ²»)", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nakamura+Tokichi+Honten", highlights: ["æŠ¹èŒ¶å‡", "æŠ¹èŒ¶å†°æ·‡æ·‹"], tips: "éå¸¸ç†±é–€ï¼Œå»ºè­°ä¸€åˆ°å®‡æ²»å…ˆå»æŠ½è™Ÿç¢¼ç‰Œã€‚" }
                        ] 
                    },
                    { 
                        date: '12/19', shortDate: '12/19', day: 'é€±äº”', title: 'åµå±±æ·±åº¦éŠ', icon: <SimpleFuji className="w-full h-full" />, color: "green", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'åµå±±ç«¹æ—ã€é‡å®®ç¥ç¤¾', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'å…¨å¤©', content: 'æ¸¡æœˆæ©‹ã€åµå±±å¤§è¡—', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'æ™šé–“', content: 'æ²³åŸç”ºæ™šé¤', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'JR åµ¯å³¨é‡ç·šè‡³åµå±±ç«™ (ç´„17åˆ†)ã€‚' } ], 
                        spots: [ 
                            { name: "åµå±±ç«¹æ—", mapUrl: "https://www.google.com/maps/search/?api=1&query=Arashiyama+Bamboo+Grove", highlights: ["ç«¹æ—ä¹‹é“", "é‡å®®ç¥ç¤¾", "å¤©é¾å¯º"], tips: "æƒ³æ‹ç©ºæ™¯éœ€æ—©ä¸Š8é»å‰æŠµé”ã€‚" },
                            { name: "æ¸¡æœˆæ©‹", mapUrl: "https://www.google.com/maps/search/?api=1&query=Togetsukyo+Bridge", highlights: ["æ¡‚å·é¢¨æ™¯", "åµå±±å…¬åœ’"], tips: "æŸ¯å—é›»å½±ç‰ˆã€Šå”ç´…çš„æˆ€æ­Œã€‹å–æ™¯åœ°ã€‚" },
                            { name: "é‡å®®ç¥ç¤¾", mapUrl: "https://www.google.com/maps/search/?api=1&query=Nonomiya+Shrine", highlights: ["ç· çµè‰¯ç·£", "é»‘è‰²é³¥å±…", "ç¥çŸ³(é¾œçŸ³)"], tips: "æ“šèªªæ‘¸äº†ç¥çŸ³é¡˜æœ›æœƒæˆçœŸã€‚" }
                        ] 
                    },
                    { 
                        date: '12/20', shortDate: '12/20', day: 'é€±å…­', title: 'ç§»å‹•æ—¥ï¼šä¼è¦‹ç¨»è·', icon: <SimpleTorii className="w-full h-full" />, color: "pink", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'ç§»å‹•è‡³å¤§é˜ªé›£æ³¢é£¯åº—', icon: <Icons.Train className="w-4 h-4" /> }, { time: 'æ™šé–“', content: 'é“é “å´›ã€å¿ƒé½‹æ©‹', icon: <Icons.Coffee className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'è¡Œæå¯å¯„æ”¾é£¯åº—æˆ–è»Šç«™ã€‚JR å¥ˆè‰¯ç·šè‡³ç¨»è·ç«™ã€‚' } ], 
                        spots: [ 
                            { name: "ä¼è¦‹ç¨»è·å¤§ç¤¾", mapUrl: "https://www.google.com/maps/search/?api=1&query=Fushimi+Inari+Taisha", highlights: ["åƒæœ¬é³¥å±…", "ç‹ç‹¸ç¹ªé¦¬", "èˆ‰é‡çŸ³"], tips: "åƒæœ¬é³¥å±…å‰æ®µäººå¾ˆå¤šï¼Œå¾€å±±ä¸Šèµ°äººæ½®æœƒé©Ÿæ¸›ã€‚" },
                            { name: "é“é “å´›", mapUrl: "https://www.google.com/maps/search/?api=1&query=Dotonbori", highlights: ["è·‘è·‘äººçœ‹æ¿", "å·¨å‹æ‹›ç‰Œ", "å”å‰è¨¶å¾·"], tips: "å¿…æ‹å›ºåŠ›æœè·‘è·‘äººçœ‹æ¿ï¼Œæ™šä¸Šæœ€ç†±é¬§ã€‚" },
                            { name: "å¿ƒé½‹æ©‹ç­‹", mapUrl: "https://www.google.com/maps/search/?api=1&query=Shinsaibashi-suji", highlights: ["è—¥å¦æ¿€æˆ°å€", "æœé£¾åº—", "å¤§ä¸¸ç™¾è²¨"], tips: "æœ‰å±‹é ‚çš„å•†åº—è¡—ï¼Œä¸‹é›¨ä¹Ÿä¸æ€•ã€‚" }
                        ] 
                    },
                    { 
                        date: '12/21', shortDate: '12/21', day: 'é€±æ—¥', title: 'å¤§é˜ªæ¢ç´¢ï¼šå‹å°¾å¯º', icon: <SimpleDaruma className="w-full h-full" />, color: "blue", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'é»‘é–€å¸‚å ´', icon: <Icons.Coffee className="w-4 h-4" /> }, { time: 'åˆé–“', content: 'å¤§é˜ªåŸ', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'å‹å°¾å¯º (æ±‚å‹é‹)', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'å‹å°¾å¯ºï¼šåœ°éµå¾¡å ‚ç­‹ç·šç›´é€šåŒ—å¤§é˜ªæ€¥è¡Œè‡³ã€Œç®•é¢è±é‡ç«™ã€ï¼Œè½‰ä¹˜å…¬è»Šã€‚' } ], 
                        spots: [ 
                            { name: "å‹å°¾å¯º", mapUrl: "https://www.google.com/maps/search/?api=1&query=Katsuo-ji", highlights: ["æ»¿å±±æ»¿è°·çš„é”æ‘©", "æ±‚å‹é‹", "é”æ‘©ç±¤"], tips: "è²·å€‹é”æ‘©ï¼Œç•«ä¸Šå·¦çœ¼è¨±é¡˜ï¼Œé¡˜æœ›å¯¦ç¾å¾Œå†ç•«å³çœ¼ä¸¦é‚„é¡˜ã€‚" },
                            { name: "é»‘é–€å¸‚å ´", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kuromon+Market", highlights: ["ç¾çƒ¤æµ·é®®", "é—œæ±ç…®", "ç¥æˆ¶ç‰›"], tips: "è§€å…‰å®¢è¼ƒå¤šï¼Œåƒ¹æ ¼åé«˜ï¼Œå»ºè­°å¤šæ¯”åƒ¹ã€‚" },
                            { name: "å¤§é˜ªåŸå…¬åœ’", mapUrl: "https://www.google.com/maps/search/?api=1&query=Osaka+Castle", highlights: ["å¤©å®ˆé–£", "è­·åŸæ²³", "å¾¡åº§èˆ¹"], tips: "å…¬åœ’å¾ˆå¤§ï¼Œå¦‚æœè¦ä¸Šå¤©å®ˆé–£å»ºè­°é ç•™æ™‚é–“ã€‚" }
                        ] 
                    },
                    { 
                        date: '12/22', shortDate: '12/22', day: 'é€±ä¸€', title: 'ç’°çƒå½±åŸ USJ', icon: <Icons.Star className="w-full h-full text-yellow-400 fill-yellow-400" />, color: "orange", 
                        activities: [ { time: 'å…¨å¤©', content: 'USJ ç’°çƒå½±åŸ', icon: <Icons.Sun className="w-4 h-4" /> }, { time: 'äº¤é€š', content: 'JR æ«»å³¶ç·šè‡³ç’°çƒå½±åŸç«™', icon: <Icons.Train className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'å»ºè­°é–‹åœ’å‰ 1-1.5 å°æ™‚æŠµé”æ’éšŠã€‚' } ], 
                        spots: [ 
                            { name: "USJ ç’°çƒå½±åŸ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Universal+Studios+Japan", highlights: ["è¶…ç´šä»»å¤©å ‚ä¸–ç•Œ", "å“ˆåˆ©æ³¢ç‰¹", "å°å°å…µ"], tips: "å…¥åœ’ç¬¬ä¸€ä»¶äº‹ï¼šç”¨ APP æŠ½ä»»å¤©å ‚æ•´ç†åˆ¸ã€‚" } 
                        ] 
                    },
                    { 
                        date: '12/23', shortDate: '12/23', day: 'é€±äºŒ', title: 'å¤§é³¥å¤§ç¤¾èˆ‡æ–°ä¸–ç•Œ', icon: <SimpleOnigiri className="w-full h-full" />, color: "blue", 
                        activities: [ { time: 'ä¸Šåˆ', content: 'å¤§é³¥å¤§ç¤¾', icon: <Icons.MapPin className="w-4 h-4" /> }, { time: 'ä¸‹åˆ', content: 'é€šå¤©é–£ã€æ–°ä¸–ç•Œ', icon: <Icons.MapPin className="w-4 h-4" /> } ], 
                        details: [ { type: 'transport', text: 'å¤§é³¥å¤§ç¤¾ï¼šJR é³³ç«™è¥¿å‡ºå£æ­¥è¡Œ7åˆ†ã€‚' }, { type: 'transport', text: 'æ–°ä¸–ç•Œï¼šåœ°éµæƒ ç¾é ˆç”ºç«™ã€‚' } ], 
                        spots: [ 
                            { name: "å¤§é³¥å¤§ç¤¾", mapUrl: "https://www.google.com/maps/search/?api=1&query=Otori+Taisha", highlights: ["å’Œæ³‰åœ‹ä¸€ä¹‹å®®", "é€æ˜å¾¡å®ˆ", "å‹é‹ä¹‹ç¥"], tips: "ã€Œé€æ˜å¾¡å®ˆã€æ¼‚äº®åˆç‰¹åˆ¥ï¼Œé©åˆç•¶ä¼´æ‰‹ç¦®ã€‚" }, 
                            { name: "æ–°ä¸–ç•Œ", mapUrl: "https://www.google.com/maps/search/?api=1&query=Shinsekai", highlights: ["é€šå¤©é–£", "ç‚¸ä¸²", "Smart Ball"], tips: "é€™è£¡æœ‰æ¿ƒæ¿ƒçš„æ˜­å’Œå¾©å¤é¢¨ï¼Œå¿…åƒç‚¸ä¸²ã€‚" },
                            { name: "é€šå¤©é–£", mapUrl: "https://www.google.com/maps/search/?api=1&query=Tsutenkaku", highlights: ["è§€æ™¯å°", "æºœæ»‘æ¢¯", "æ¯”åˆ©è‚¯ç¥åƒ"], tips: "æ‘¸æ‘¸æ¯”åˆ©è‚¯ç¥åƒçš„è…³åº•æœƒå¸¶ä¾†å¥½é‹ã€‚" }
                        ] 
                    },
                    { 
                        date: '12/24', shortDate: '12/24', day: 'é€±ä¸‰', title: 'è¿”ç¨‹', icon: <Icons.PlaneReal className="w-full h-full text-blue-400" />, color: "blue", 
                        activities: [ { time: '06:30', content: 'æ­ä¹˜å—æµ·é›»éµå‰å¾€æ©Ÿå ´', icon: <Icons.Train className="w-4 h-4" /> }, { time: '08:10', content: 'æŠµé”é—œè¥¿æ©Ÿå ´ T2', icon: <Icons.PlaneReal className="w-4 h-4" /> }, { time: '10:10', content: 'æ­ä¹˜æ¨‚æ¡ƒ MM025 è¿”å°', icon: <Icons.PlaneReal className="w-4 h-4" /> } ], 
                        details: [ { type: 'info', text: 'æ¨‚æ¡ƒåœ¨ T2ï¼Œå¾ T1 éœ€æ­æ¥é§è»Šï¼Œè«‹å¤šé ç•™æ™‚é–“ã€‚' } ], 
                        spots: [
                            { name: "é—œè¥¿æ©Ÿå ´ T2", mapUrl: "https://www.google.com/maps/search/?api=1&query=Kansai+Airport+Terminal+2", highlights: ["å…ç¨…åº—", "ä¼´æ‰‹ç¦®"], tips: "T2 å•†åº—è¼ƒå°‘ï¼Œå»ºè­°å…¥é—œå‰å…ˆè²·å¥½ã€‚" }
                        ] 
                    }
                ],
                transportGuides: [
                    { title: 'å‹å°¾å¯ºäº¤é€š (è©³ç´°ç‰ˆ)', steps: [ 'æ­ä¹˜ç´…ç·šåœ°éµè‡³ã€Œç®•é¢è±é‡ç«™ã€', 'å…¬è»Š 6 è™Ÿæœˆå°', 'è½‰ä¹˜é˜ªæ€¥å·´å£« 29 è™Ÿæˆ– 30 è™Ÿ', 'æ–¼ã€Œå‹å°¾å¯ºç«™ã€ä¸‹è»Š (Â¥800)' ] },
                    { title: 'é›£æ³¢ -> é—œè¥¿æ©Ÿå ´ (å›ç¨‹)', steps: [ 'å—æµ·é›»éµ (Airport Exp.)', '06:30 â†’ 07:08 (æ¨è–¦)', '07:00 â†’ 07:34 (Rapi:t)', '07:30 â†’ 08:10 (æœ€å¾Œæ¥µé™)' ] }
                ]
            };

            const CopyButton = ({ text }) => {
                const [copied, setCopied] = useState(false);
                const handleCopy = (e) => {
                    e.stopPropagation();
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) {}
                    document.body.removeChild(textarea);
                };
                return <Button3D onClick={handleCopy} color="white" className="ml-2 px-3 py-1 text-xs h-8">{copied ? <Icons.Check size={14} className="mr-1"/> : <Icons.Copy size={14} className="mr-1"/>}{copied ? 'å·²è¤‡è£½' : 'è¤‡è£½'}</Button3D>;
            };

            const scrollToTop = () => {
                if (mainContentRef.current) {
                    mainContentRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            return (
                <div 
                    className="h-[100dvh] bg-[#fffafc] font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100 flex flex-col"
                    style={{ 
                        paddingTop: 'env(safe-area-inset-top)', 
                        paddingBottom: 'env(safe-area-inset-bottom)' 
                    }}
                >
                    <NintendoSakuraBackground />
                    <SakuraRain />
                    
                    {showSplash && <SplashScreen />}
                    
                    {/* Dialog Component Instance */}
                    <Dialog 
                        isOpen={dialog.isOpen} 
                        type={dialog.type} 
                        message={dialog.message} 
                        onConfirm={dialog.onConfirm} 
                        onCancel={closeDialog} 
                    />

                    {/* Header */}
                    <header className="bg-pink-100/90 backdrop-blur-md p-2 sticky top-0 z-50 border-b-2 border-pink-200 border-dashed shadow-sm flex-shrink-0">
                        <div className="flex justify-between items-center mb-2">
                            <div>
                                <h1 className="text-lg font-creative text-3d flex items-center gap-2 tracking-widest transform -rotate-1">
                                    <Icons.PlaneReal size={20} className="text-pink-500 fill-white" /> <span>å¤§é˜ªäº¬éƒ½ä¸‰äººéŠ</span>
                                </h1>
                                <p className="text-[10px] text-gray-500 mt-0.5 font-bold ml-1">2025.12.15 - 12.24 (10å¤©)</p>
                            </div>
                            <div className="flex gap-2">
                                {isIos && (
                                    <Button3D onClick={() => setShowInstallModal(true)} color="white" className="w-8 h-8 p-0 text-blue-500 animate-pulse">
                                        <Icons.Download size={16} />
                                    </Button3D>
                                )}
                                <Button3D onClick={clearAllData} color="white" className="w-8 h-8 p-0 text-red-400"><Icons.Trash2 size={16} /></Button3D>
                                <Button3D onClick={() => setIsMenuOpen(!isMenuOpen)} color="white" className="w-8 h-8 p-0">{isMenuOpen ? <Icons.X size={16} /> : <Icons.Menu size={16} />}</Button3D>
                            </div>
                        </div>
                        
                        <div className="flex space-x-1 overflow-x-auto pb-2 no-scrollbar justify-between">
                            {[{ id: 'itinerary', label: 'è¡Œç¨‹', icon: Icons.Calendar }, { id: 'info', label: 'è³‡è¨Š', icon: Icons.Hotel }, { id: 'weather', label: 'å¤©æ°£', icon: Icons.CloudSun }, { id: 'transport', label: 'äº¤é€š', icon: Icons.MapPin }, { id: 'budget', label: 'é ç®—', icon: Icons.Wallet }].map((tab) => (
                                <Button3D key={tab.id} onClick={() => setActiveTab(tab.id)} isActive={activeTab === tab.id} color={activeTab === tab.id ? "pink" : "white"} className="flex-1 py-1 px-1 text-[10px]">
                                    <span className="flex flex-row items-center justify-center gap-1"><tab.icon size={14} />{tab.label}</span>
                                </Button3D>
                            ))}
                        </div>
                    </header>

                    {/* Main Content */}
                    <main ref={mainContentRef} className="flex-1 p-3 space-y-3 relative z-10 overflow-y-auto no-scrollbar pb-24">
                        {activeTab === 'itinerary' && (
                            <div className="space-y-4 animate-fadeIn h-full flex flex-col">
                                <div ref={dayMenuRef} className="flex-shrink-0 p-1 bg-white/40 backdrop-blur-md border-2 border-pink-100/50 rounded-3xl shadow-sm mb-2 overflow-x-auto whitespace-nowrap no-scrollbar">
                                    {tripData.itinerary.map((day, idx) => (
                                        <button key={idx} onClick={() => setSelectedDayIndex(idx)} className={`inline-block mx-1 px-3 py-1 rounded-2xl text-[10px] font-bold transition-all duration-200 ${selectedDayIndex === idx ? 'bg-pink-400 text-white shadow-md transform scale-105' : 'bg-gray-50/50 text-gray-500 hover:bg-pink-50/50 border border-gray-100/50'}`}><div className="flex flex-col items-center"><span>Day {idx + 1}</span><span className="font-normal opacity-80">{day.shortDate}</span></div></button>
                                    ))}
                                </div>
                                <div className="flex-grow">
                                    {(() => {
                                        const day = tripData.itinerary[selectedDayIndex];
                                        return (
                                            <LaceCard color={day.color} icon={day.icon} className="animate-fadeIn">
                                                <div className="p-6 relative z-10">
                                                    <div className="flex items-start justify-between border-b-2 border-dashed border-gray-100 pb-4 mb-4">
                                                        <div><div className="flex items-baseline gap-2 mb-1"><h2 className="text-2xl font-bold text-gray-800">Day {selectedDayIndex + 1}</h2><span className="text-sm text-gray-500 bg-white/60 border border-gray-200/60 px-2 py-0.5 rounded-lg shadow-sm">{day.day}</span></div><div className="text-sm font-bold text-pink-500">{day.title}</div></div>
                                                    </div>
                                                    {day.note && <div className="mb-6 bg-yellow-50/60 border-l-4 border-yellow-300 p-3 text-xs text-gray-600 rounded-r-lg flex gap-2 items-start shadow-sm backdrop-blur-sm"><Icons.Info size={14} className="shrink-0 mt-0.5 text-yellow-500"/> <span className="leading-relaxed">{day.note}</span></div>}
                                                    
                                                    <div className="space-y-6 relative before:absolute before:left-3.5 before:top-2 before:bottom-2 before:w-0.5 before:bg-gray-200/60">
                                                        {day.activities.map((act, i) => {
                                                            const isDone = completedActivities[`${selectedDayIndex}-${i}`];
                                                            return (
                                                                <div key={i} className="flex gap-4 relative pl-9 group cursor-pointer" onClick={() => toggleActivity(selectedDayIndex, i)}>
                                                                    <div className={`absolute left-0 top-1 w-7 h-7 rounded-full z-10 flex items-center justify-center shadow-sm transition-all duration-300 ${isDone ? 'bg-green-500 border-green-500' : 'bg-white/80 border-2 border-pink-200'}`}>
                                                                        {isDone ? <Icons.Check size={16} className="text-white"/> : <div className="text-gray-400 transform scale-75">{act.icon}</div>}
                                                                    </div>
                                                                    <div className={`transition-opacity duration-300 ${isDone ? 'opacity-50' : 'opacity-100'}`}>
                                                                        <div className={`font-bold text-sm inline-block px-2 py-0.5 rounded-md mb-1 border ${isDone ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-pink-50/50 text-gray-700 border-pink-100/50'}`}>{act.time}</div>
                                                                        <div className={`text-sm leading-relaxed ${isDone ? 'text-gray-400 line-through' : 'text-gray-600'}`}>{act.content}</div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>

                                                    <div className="mt-8 pt-4 relative">
                                                        <div className="absolute top-0 left-[-24px] right-[-24px] h-3 bg-pink-100 opacity-30 transform -rotate-1"></div>
                                                        {day.details && <div className="space-y-3 mt-4"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1"><Icons.Bus size={12}/> äº¤é€š & å‚™è¨»</h4>{day.details.map((detail, dIdx) => (<div key={dIdx} className="bg-white/30 p-3 rounded-xl text-sm text-gray-600 border border-gray-100/60 flex gap-2 items-start backdrop-blur-sm"><span className="text-pink-400 mt-1">â€¢</span><span className="leading-relaxed">{detail.text}</span></div>))}</div>}
                                                        
                                                        {day.spots && day.spots.length > 0 && <div className="space-y-3 mt-6"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1"><Icons.Camera size={12}/> æ™¯é»æ”»ç•¥</h4>{day.spots.map((spot, sIdx) => (<div key={sIdx} className="bg-white/40 border border-blue-100/60 rounded-xl p-4 shadow-sm backdrop-blur-sm"><div className="flex justify-between items-start mb-2 border-b border-dashed border-gray-100/60 pb-2"><h5 className="font-bold text-gray-700 flex items-center gap-1 flex-1"><Icons.MapPin size={14} className="text-blue-400 shrink-0"/> {spot.name} <SpotWeatherBadge city={dayCityMap[selectedDayIndex]} /></h5><div className="flex gap-1 shrink-0 ml-2"><a href={`https://www.youtube.com/results?search_query=${encodeURIComponent(spot.name + " ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©")}&sp=EgJAAQ%253D%253D`} target="_blank" rel="noreferrer" className="text-[10px] bg-red-50/50 text-red-500 border border-red-100/50 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-red-100 transition-colors"><Icons.Video size={10}/> è§€çœ‹äººæ½®</a><a href={spot.mapUrl} target="_blank" rel="noreferrer" className="text-[10px] bg-blue-50/50 text-blue-500 border border-blue-100/50 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-blue-100 transition-colors"><Icons.Navigation size={10}/> å°èˆª</a></div></div><div className="text-xs text-gray-600 leading-relaxed mb-2 flex gap-2 items-start"><Icons.Star size={12} className="text-yellow-400 shrink-0 mt-0.5 fill-yellow-400"/><span><span className="font-bold text-gray-700">å¿…åšï¼š</span>{spot.highlights.join('ã€')}</span></div><div className="text-xs text-gray-500 bg-orange-50/50 p-2 rounded-lg flex gap-2 items-start border border-orange-100/50"><Icons.Sparkles size={12} className="text-orange-400 shrink-0 mt-0.5"/><span><span className="font-bold text-orange-500">Tips:</span> {spot.tips}</span></div></div>))}</div>}
                                                    </div>
                                                </div>
                                            </LaceCard>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'info' && (
                            <div className="space-y-6 animate-fadeIn pb-8">
                                <section><div className="flex items-center gap-2 mb-3"><div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-500"><Icons.Plane size={16} /></div><h2 className="text-lg font-bold text-gray-700">èˆªç­è³‡è¨Š</h2></div>{tripData.flights.map((flight, idx) => (<LaceCard key={idx} color="blue" className="mb-3" icon={<Icons.Plane className="w-full h-full"/>}><div className="p-4 relative z-10"><div className="flex justify-between mb-2"><span className="bg-blue-100/60 text-blue-600 text-xs px-2 py-1 rounded-lg font-bold">{flight.type}</span><span className="text-gray-400 text-xs font-mono">{flight.date}</span></div><div className="font-bold text-lg text-gray-800 mb-2">{flight.flight}</div><div className="flex items-center gap-3 text-sm text-gray-600 mb-3 bg-gray-50/50 p-2 rounded-lg border border-gray-100/50"><span className="font-bold">{flight.dep}</span><Icons.ArrowRight size={14} className="text-gray-400" /><span className="font-bold">{flight.arr}</span></div><div className="text-xs text-orange-500 flex gap-1 items-start"><Icons.AlertCircle size={12} className="mt-0.5 shrink-0"/> {flight.note}</div></div></LaceCard>))}</section>
                                <section><div className="flex items-center gap-2 mb-3"><div className="w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center text-pink-500"><Icons.Hotel size={16} /></div><h2 className="text-lg font-bold text-gray-700">ä½å®¿è³‡è¨Š</h2></div>{tripData.hotels.map((hotel, idx) => (<LaceCard key={idx} color="pink" className="mb-4" icon={<Icons.Hotel className="w-full h-full"/>}><div className="p-5 relative z-10"><div className="flex justify-between items-start mb-2"><span className="font-bold text-pink-500 text-xs border border-pink-200/60 px-2 py-0.5 rounded-full bg-white/60">{hotel.city}</span><div className="text-xs text-gray-400">{hotel.checkIn}</div></div><h3 className="font-bold text-gray-800 text-lg leading-tight mb-1">{hotel.name}</h3><div className="flex items-center gap-1 text-xs text-yellow-500 mb-3"><Icons.Star size={10} fill="currentColor"/> {hotel.rating}</div><div className="bg-gray-50/50 border border-gray-100/60 p-3 rounded-xl text-sm text-gray-600 mb-3"><div className="flex justify-between items-start mb-2"><span className="w-3/4">{hotel.address}</span><CopyButton text={hotel.address} /></div><a href={hotel.mapLink} target="_blank" rel="noreferrer" className="text-blue-500 text-xs flex items-center gap-1 font-bold hover:underline"><Icons.Navigation size={12}/> é–‹å•Ÿåœ°åœ–</a></div><div className="text-xs text-gray-500 flex gap-2 items-center bg-white/60 p-2 rounded-lg border border-dashed border-gray-200/60"><Icons.Train size={12} className="text-gray-400"/> {hotel.transport}</div></div></LaceCard>))}</section>
                            </div>
                        )}

                        {activeTab === 'weather' && (
                            <div className="space-y-4 animate-fadeIn pb-8">
                                <div className="flex justify-center mb-4">
                                    <button onClick={requestLocation} disabled={locLoading} className={`bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 active:scale-95 transition-transform ${locLoading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                        {locLoading ? <span className="animate-pulse">å®šä½ä¸­...</span> : <><Icons.MapPin size={16}/> æ›´æ–°æˆ‘çš„ä½ç½®</>}
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="col-span-2"><WeatherCard title="ç›®å‰ä½ç½®" lat={weatherLoc?.lat} lon={weatherLoc?.lon} isCurrent={true} /></div>
                                    <WeatherCard title="å¤§é˜ª" lat={34.6937} lon={135.5023} />
                                    <WeatherCard title="äº¬éƒ½" lat={35.0116} lon={135.7681} />
                                    <div className="col-span-2"><WeatherCard title="æ±äº¬" lat={35.6895} lon={139.6917} /></div>
                                </div>
                                <div className="text-center text-[10px] text-gray-400 mt-4">è³‡æ–™ä¾†æºï¼šæ—¥æœ¬æ°£è±¡å»³ (JMA) via Open-Meteo</div>
                            </div>
                        )}

                        {activeTab === 'transport' && (
                            <div className="space-y-4 animate-fadeIn pb-8">
                                <div className="bg-white/40 backdrop-blur-md border-l-4 border-blue-300 p-4 rounded-xl text-sm text-gray-600 shadow-sm flex gap-3"><Icons.Info size={20} className="shrink-0 text-blue-400"/><p>é€™è£¡æ˜¯è¡Œç¨‹ä¸­è¼ƒè¤‡é›œçš„äº¤é€šæ–¹å¼æ•´ç†ï¼Œå»ºè­°å‡ºç™¼å‰å†æ¬¡ç¢ºèªæ™‚åˆ»è¡¨ã€‚</p></div>
                                {tripData.transportGuides.map((guide, idx) => (<LaceCard key={idx} color="green" className="mb-2" icon={<Icons.MapPin className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><Icons.Bus size={18} className="text-green-500" />{guide.title}</h3><ul className="space-y-3 relative before:absolute before:left-2.5 before:top-2 before:bottom-2 before:w-0.5 before:bg-gray-200/60">{guide.steps.map((step, sIdx) => (<li key={sIdx} className="flex gap-3 text-sm text-gray-600 relative pl-1"><div className="bg-white/80 border-2 border-green-200/60 text-green-600 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shrink-0 font-bold relative z-10 shadow-sm">{sIdx + 1}</div><span className="leading-relaxed">{step}</span></li>))}</ul></div></LaceCard>))}
                                <LaceCard color="orange" icon={<Icons.Train className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><Icons.Navigation size={16}/> å¯¦ç”¨é€£çµ</h3><div className="space-y-2"><a href="https://www.westjr.co.jp/global/tc/timetable/" target="_blank" rel="noreferrer" className="block bg-white/60 text-blue-600 px-4 py-3 rounded-xl text-sm hover:bg-blue-50/50 transition-colors font-bold text-center border border-blue-100/60 shadow-sm">JR è¥¿æ—¥æœ¬æ™‚åˆ»è¡¨</a><a href="https://www.nankai.co.jp/traffic/kix.html" target="_blank" rel="noreferrer" className="block bg-white/60 text-orange-600 px-4 py-3 rounded-xl text-sm hover:bg-orange-50/50 transition-colors font-bold text-center border border-orange-100/60 shadow-sm">å—æµ·é›»éµç©ºæ¸¯ç·šè³‡è¨Š</a></div></div></LaceCard>
                            </div>
                        )}

                        {activeTab === 'budget' && (
                            <div className="animate-fadeIn space-y-4 pb-8">
                                <LaceCard color="orange" icon={<Icons.Wallet className="w-full h-full"/>}>
                                    <div className="p-5 relative z-10">
                                        <div className="flex justify-between items-center mb-4 border-b border-dashed border-gray-200/60 pb-2">
                                             <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.Wallet size={18} className="text-orange-500"/> å³æ™‚åŒ¯ç‡è¨ˆç®—</h3>
                                             <button onClick={fetchRate} disabled={isRateLoading} className="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-orange-200 transition-colors">{isRateLoading ? 'æ›´æ–°ä¸­...' : <span className="flex items-center gap-1"><Icons.Sparkles size={10}/> æ›´æ–°åŒ¯ç‡</span>}</button>
                                        </div>
                                        <div className="flex items-center gap-2 mb-4">
                                             <div className="flex-1"><label className="text-xs text-gray-500 block mb-1 font-bold">æ—¥å¹£ (JPY)</label><input type="number" value={jpyAmount} onChange={(e) => setJpyAmount(e.target.value)} className="w-full bg-white border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-700 focus:outline-none focus:border-orange-300" placeholder="Â¥"/></div>
                                             <div className="pt-5 text-gray-400"><Icons.ArrowRight size={16}/></div>
                                             <div className="flex-1"><label className="text-xs text-gray-500 block mb-1 font-bold">å°å¹£ (TWD)</label><div className="w-full bg-orange-50 border border-orange-100 rounded-xl px-3 py-2 text-lg font-bold text-orange-600">${jpyAmount ? Math.round(jpyAmount * exchangeRate).toLocaleString() : '0'}</div></div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-gray-50/80 p-2 rounded-lg">
                                            <span className="text-xs text-gray-500 whitespace-nowrap">ç›®å‰åŒ¯ç‡:</span>
                                            <input type="number" step="0.0001" value={exchangeRate} onChange={(e) => setExchangeRate(parseFloat(e.target.value))} className="w-20 bg-white border border-gray-200 rounded px-1 py-0.5 text-xs text-gray-600 focus:outline-none text-center" />
                                            <span className="text-[10px] text-gray-400 ml-auto">å¯æ‰‹å‹•èª¿æ•´</span>
                                        </div>
                                    </div>
                                </LaceCard>

                                <LaceCard color="green" icon={<Icons.Wallet className="w-full h-full"/>}><div className="p-5 relative z-10"><h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b border-dashed border-gray-200/60 pb-3"><Icons.Wallet size={18} className="text-green-500"/> å›ºå®šæ”¯å‡º (æ©Ÿç¥¨+ä½å®¿)</h3><div className="space-y-6"><div><div className="flex justify-between items-center mb-2"><span className="font-bold text-gray-700 flex items-center gap-2"><span className="w-2 h-2 bg-green-400 rounded-full"></span> Danny (å–®äººæˆ¿)</span><span className="text-xl font-bold text-green-600 font-mono">$28,787</span></div><div className="text-xs text-gray-500 flex justify-between bg-white/60 p-3 rounded-xl border border-gray-200/60"><span>æ©Ÿç¥¨: 6860</span><span>äº¬éƒ½: 7647</span><span>å¤§é˜ª: 14280</span></div></div><div className="border-b border-dashed border-gray-200/60"></div><div><div className="flex justify-between items-center mb-2"><span className="font-bold text-gray-700 flex items-center gap-2"><span className="w-2 h-2 bg-green-400 rounded-full"></span> å¨Ÿ + è“ (æ¯äºº)</span><span className="text-xl font-bold text-green-600 font-mono">$18,828</span></div><div className="text-xs text-gray-500 flex justify-between bg-white/60 p-3 rounded-xl border border-gray-200/60"><span>æ©Ÿç¥¨: 6860</span><span>äº¬éƒ½: 4093</span><span>å¤§é˜ª: 7875</span></div></div></div></div></LaceCard>
                                <div className="bg-white/40 backdrop-blur-md p-4 rounded-2xl text-center border-2 border-gray-100/50 border-dashed text-gray-400 text-sm"><Icons.Info size={14} className="inline mr-1 mb-0.5"/> ä»¥ä¸Šåƒ…å«æ©Ÿç¥¨èˆ‡ä½å®¿ï¼Œä¸å«ç•¶åœ°äº¤é€šèˆ‡é¤é£Ÿã€‚</div>
                            </div>
                        )}

                        {!isChatOpen && (
                            <>
                                <Button3D onClick={() => setIsChatOpen(true)} color="pink" className="fixed bottom-6 left-6 w-14 h-14 rounded-full shadow-lg z-40 flex items-center justify-center border-2 border-white safe-margin-bottom"><Icons.Sparkles size={28} /></Button3D>
                                <Button3D onClick={scrollToTop} color="pink" className="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg z-40 flex items-center justify-center border-2 border-white safe-margin-bottom"><Icons.ArrowRight className="transform -rotate-90" size={28} /></Button3D>
                            </>
                        )}
                        {showInstallModal && <IOSInstallGuide onClose={() => setShowInstallModal(false)} />}
                        <ChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} itinerary={tripData} apiKey={apiKey} setApiKey={setApiKey} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TripAssistant />);
    </script>
</body>
</html>